<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Centro Cristiano Sublime Gracia - Sistema v2</title>
<style>

*{margin:0;padding:0;box-sizing:border-box}
:root{--do:#d4af37;--doc:#f4d03f;--doo:#b8941f;--ng:#0a0a0a;--nc:#141414;--go:#1c1c1c;--gr:#252525;--gm:#323232;--ex:#27ae60;--pe:#e74c3c;--in:#2980b9;--ad:#f39c12;--pu:#8e44ad}
body{font-family:Lato,sans-serif;background:var(--ng);color:#ccc;min-height:100vh;overflow-x:hidden}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-track{background:var(--nc)}::-webkit-scrollbar-thumb{background:var(--doo);border-radius:3px}
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lato:wght@300;400;700&display=swap');
#loginBox{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:radial-gradient(ellipse at 30% 50%,#1a1400,var(--ng));z-index:9999}
.lcard{width:410px;background:var(--nc);border:1px solid rgba(212,175,55,.25);border-radius:20px;padding:46px 36px;text-align:center;box-shadow:0 30px 80px rgba(0,0,0,.6),0 0 40px rgba(212,175,55,.1);animation:fadeUp .5s ease}
@keyframes fadeUp{from{opacity:0;transform:translateY(24px)}to{opacity:1;transform:translateY(0)}}
.lcross{width:74px;height:74px;margin:0 auto 20px;background:linear-gradient(135deg,var(--do),var(--doo));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;box-shadow:0 0 34px rgba(212,175,55,.35)}
.lcard h1{font-family:Cinzel,serif;color:var(--do);font-size:18px;letter-spacing:3px;text-transform:uppercase}
.lcard h2{color:#777;font-size:11px;font-weight:300;margin-bottom:30px;margin-top:3px;letter-spacing:1px}
.lg{margin-bottom:13px;text-align:left}
.lg label{display:block;color:var(--do);font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;font-weight:700}
.lg select,.lg input{width:100%;padding:11px 13px;background:var(--gr);border:1px solid var(--gm);border-radius:10px;color:#fff;font-size:13px;font-family:Lato,sans-serif;transition:all .3s}
.lg select:focus,.lg input:focus{outline:none;border-color:var(--do);box-shadow:0 0 0 3px rgba(212,175,55,.1)}
.lg select option{background:var(--gr)}
.btnl{width:100%;margin-top:16px;padding:12px;border:none;border-radius:10px;background:linear-gradient(135deg,var(--do),var(--doo));color:var(--ng);font-weight:700;font-size:13px;font-family:Cinzel,serif;letter-spacing:2px;cursor:pointer;text-transform:uppercase;transition:all .3s}
.btnl:hover{transform:translateY(-2px);box-shadow:0 8px 22px rgba(212,175,55,.32)}
.lhint{color:#555;font-size:11px;margin-top:16px;line-height:2}.lhint b{color:var(--do)}
#mainApp{display:none;min-height:100vh;flex-direction:column}
.hdr{background:linear-gradient(90deg,var(--nc),var(--go));border-bottom:2px solid rgba(212,175,55,.28);padding:10px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:500}
.hdr-b{display:flex;align-items:center;gap:12px}
.hdr-ico{width:44px;height:44px;background:linear-gradient(135deg,var(--do),var(--doo));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:19px;box-shadow:0 0 16px rgba(212,175,55,.28);flex-shrink:0}
.hdr-title{font-family:Cinzel,serif;color:var(--do);font-size:14px;letter-spacing:1px}
.hdr-sub{color:#666;font-size:10px;font-weight:300;margin-top:1px}
.hdr-r{display:flex;align-items:center;gap:11px}
.ub{display:flex;align-items:center;gap:8px;padding:6px 13px;background:rgba(212,175,55,.07);border:1px solid rgba(212,175,55,.16);border-radius:50px;color:var(--do);font-size:11px}
.ur{padding:2px 8px;border-radius:20px;font-size:9px;font-weight:700;text-transform:uppercase}
.btnlo{padding:6px 14px;background:rgba(231,76,60,.12);border:1px solid rgba(231,76,60,.25);color:var(--pe);border-radius:8px;cursor:pointer;font-size:11px;font-weight:700;text-transform:uppercase;transition:all .3s;font-family:Lato,sans-serif}
.btnlo:hover{background:var(--pe);color:#fff}
.hcumple{color:var(--ad);font-size:11px;display:none}
.app-body{display:flex;flex:1;height:calc(100vh - 68px);overflow:hidden}
.sidebar{width:215px;background:var(--nc);border-right:1px solid rgba(212,175,55,.1);overflow-y:auto;flex-shrink:0}
.sb-sec{padding:17px 13px 3px;color:#555;font-size:9px;text-transform:uppercase;letter-spacing:2px;font-weight:700}
.ni{display:flex;align-items:center;gap:10px;padding:10px 17px;color:#777;cursor:pointer;transition:all .2s;border-left:3px solid transparent;font-size:12px}
.ni:hover{color:var(--do);background:rgba(212,175,55,.04);border-left-color:rgba(212,175,55,.2)}
.ni.activo{color:var(--do);background:rgba(212,175,55,.07);border-left-color:var(--do)}
.ni .ico{font-size:16px;width:20px;text-align:center;flex-shrink:0}
.ndv{height:1px;background:rgba(212,175,55,.07);margin:7px 13px}
.contenido{flex:1;overflow-y:auto;background:#0d0d0d}
.vp{display:none;padding:22px;animation:fadeIn .22s ease}
.vp.activa{display:block}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-6px)}40%,80%{transform:translateX(6px)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(3px)}to{opacity:1;transform:translateY(0)}}
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid rgba(212,175,55,.1)}
.ph-t{font-family:Cinzel,serif;color:var(--do);font-size:19px;letter-spacing:1px}
.ph-s{color:#666;font-size:11px;margin-top:2px}
.sg{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:14px;margin-bottom:20px}
.sc{background:var(--nc);border:1px solid rgba(212,175,55,.1);border-radius:13px;padding:18px;position:relative;overflow:hidden;transition:all .3s}
.sc:hover{transform:translateY(-2px);border-color:rgba(212,175,55,.25);box-shadow:0 0 24px rgba(212,175,55,.07)}
.sc::before{content:'';position:absolute;top:0;right:0;width:65px;height:65px;border-radius:0 13px 0 65px;opacity:.1}
.sc.do::before{background:var(--do)}.sc.ve::before{background:var(--ex)}.sc.az::before{background:var(--in)}.sc.ro::before{background:var(--pe)}.sc.pu::before{background:var(--pu)}.sc.na::before{background:var(--ad)}
.sc-ico{font-size:24px;margin-bottom:9px}.sc-num{font-size:28px;font-weight:700;color:#fff;font-family:Cinzel,serif}.sc-lbl{color:#777;font-size:10px;text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.panel{background:var(--nc);border:1px solid rgba(212,175,55,.1);border-radius:13px;margin-bottom:16px;overflow:hidden}
.ph2{background:rgba(212,175,55,.05);padding:12px 17px;border-bottom:1px solid rgba(212,175,55,.1);display:flex;align-items:center;justify-content:space-between;font-family:Cinzel,serif;color:var(--do);font-size:12px;letter-spacing:1px}
.pb{padding:17px}
.fg{display:grid;grid-template-columns:repeat(auto-fit,minmax(185px,1fr));gap:12px;margin-bottom:12px}
.ff{display:flex;flex-direction:column}.ff.full{grid-column:1/-1}
.ff label{font-size:9px;color:#777;text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:700}
.ff input,.ff select,.ff textarea{padding:9px 12px;background:var(--gr);border:1px solid var(--gm);border-radius:9px;color:#fff;font-size:13px;font-family:Lato,sans-serif;transition:all .3s}
.ff input:focus,.ff select:focus,.ff textarea:focus{outline:none;border-color:var(--do);box-shadow:0 0 0 3px rgba(212,175,55,.09)}
.ff select option{background:var(--gr)}.ff textarea{resize:vertical;min-height:75px}
input[type=date],input[type=time]{color-scheme:dark}
.btn{padding:8px 18px;border:none;border-radius:8px;cursor:pointer;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;transition:all .2s;font-family:Lato,sans-serif;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px);box-shadow:0 5px 15px rgba(0,0,0,.3)}
.btn-p{background:linear-gradient(135deg,var(--do),var(--doo));color:var(--ng)}
.btn-s{background:rgba(255,255,255,.07);color:#bbb;border:1px solid rgba(255,255,255,.1)}
.btn-d{background:rgba(231,76,60,.1);color:var(--pe);border:1px solid rgba(231,76,60,.22)}
.btn-d:hover{background:var(--pe);color:#fff}
.btn-e{background:rgba(39,174,96,.1);color:var(--ex);border:1px solid rgba(39,174,96,.22)}
.btn-e:hover{background:var(--ex);color:#fff}
.btn-i{background:rgba(41,128,185,.1);color:var(--in);border:1px solid rgba(41,128,185,.22)}
.btn-i:hover{background:var(--in);color:#fff}
.btn-w{background:rgba(243,156,18,.1);color:var(--ad);border:1px solid rgba(243,156,18,.22)}
.btn-w:hover{background:var(--ad);color:var(--ng)}
.btn-wa{background:rgba(37,211,102,.1);color:#25d366;border:1px solid rgba(37,211,102,.22)}
.btn-wa:hover{background:#25d366;color:#fff}
.btn-xl{background:rgba(33,115,70,.1);color:var(--ex);border:1px solid rgba(33,115,70,.22)}
.btn-xl:hover{background:var(--ex);color:#fff}
.btn-sm{padding:6px 12px;font-size:10px}.btn-xs{padding:4px 8px;font-size:9px}
.bgrp{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
.tc{overflow-x:auto;border-radius:9px;border:1px solid rgba(212,175,55,.07);margin-top:12px}
table{width:100%;border-collapse:collapse;font-size:12px}
thead th{background:rgba(212,175,55,.05);color:var(--do);padding:11px 12px;text-align:left;font-size:10px;text-transform:uppercase;letter-spacing:1px;font-weight:700;white-space:nowrap;border-bottom:1px solid rgba(212,175,55,.1)}
tbody td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.03);color:#ccc;vertical-align:middle}
tbody tr:hover{background:rgba(212,175,55,.03)}tbody tr:last-child td{border-bottom:none}
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:.5px}
.ba{background:rgba(39,174,96,.1);color:var(--ex);border:1px solid rgba(39,174,96,.22)}
.bi{background:rgba(231,76,60,.1);color:var(--pe);border:1px solid rgba(231,76,60,.22)}
.bv{background:rgba(41,128,185,.1);color:var(--in);border:1px solid rgba(41,128,185,.22)}
.bvh{background:rgba(243,156,18,.1);color:var(--ad);border:1px solid rgba(243,156,18,.22)}
.bvn{background:rgba(142,68,173,.1);color:var(--pu);border:1px solid rgba(142,68,173,.22)}
.badm{background:rgba(231,76,60,.1);color:var(--pe);border:1px solid rgba(231,76,60,.22)}
.bpas{background:rgba(212,175,55,.1);color:var(--do);border:1px solid rgba(212,175,55,.22)}
.btes{background:rgba(39,174,96,.1);color:var(--ex);border:1px solid rgba(39,174,96,.22)}
.bsec{background:rgba(41,128,185,.1);color:var(--in);border:1px solid rgba(41,128,185,.22)}
.blid{background:rgba(142,68,173,.1);color:var(--pu);border:1px solid rgba(142,68,173,.22)}
.bvol{background:rgba(255,255,255,.05);color:#aaa;border:1px solid rgba(255,255,255,.1)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:1000;justify-content:center;align-items:center;padding:17px;backdrop-filter:blur(4px)}
.modal-overlay.activo{display:flex}
.mv{background:var(--nc);border:1px solid rgba(212,175,55,.18);border-radius:17px;width:100%;max-width:720px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 30px 80px rgba(0,0,0,.7),0 0 50px rgba(212,175,55,.07);animation:mIn .26s cubic-bezier(.34,1.56,.64,1)}
@keyframes mIn{from{opacity:0;transform:scale(.88) translateY(-14px)}to{opacity:1;transform:scale(1) translateY(0)}}
.mh{background:rgba(212,175,55,.05);padding:14px 20px;border-bottom:1px solid rgba(212,175,55,.16);display:flex;align-items:center;justify-content:space-between;font-family:Cinzel,serif;color:var(--do);font-size:14px;letter-spacing:1px}
.mx{width:28px;height:28px;background:rgba(231,76,60,.1);border:1px solid rgba(231,76,60,.22);color:var(--pe);border-radius:50%;font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .22s}
.mx:hover{background:var(--pe);color:#fff;transform:rotate(90deg)}
.mbody{padding:20px;overflow-y:auto;flex:1}
.mf{padding:12px 20px;border-top:1px solid rgba(212,175,55,.1);display:flex;justify-content:flex-end;gap:8px;background:rgba(0,0,0,.18)}
.sb{position:relative;flex:1;max-width:300px}
.sb input{width:100%;padding:8px 12px 8px 34px;background:var(--gr);border:1px solid var(--gm);border-radius:9px;color:#fff;font-size:12px;font-family:Lato,sans-serif;transition:all .3s}
.sb input:focus{outline:none;border-color:var(--do)}
.sb::before{content:'üîç';position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:12px}
.ag{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:9px;max-height:420px;overflow-y:auto;padding:3px}
.ac{background:var(--gr);border:2px solid transparent;border-radius:10px;padding:12px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .2s}
.ac:hover{transform:translateY(-1px)}
.ac.presente{border-color:var(--ex);background:rgba(39,174,96,.07)}
.ac.ausente{border-color:var(--pe);background:rgba(231,76,60,.07)}
.ac.justificado{border-color:var(--ad);background:rgba(243,156,18,.07)}
.ava{width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--do),var(--doo));display:flex;align-items:center;justify-content:center;color:var(--ng);font-weight:700;font-size:13px;flex-shrink:0}
.an2{font-weight:700;font-size:12px;color:#fff}.am2{font-size:10px;color:#777;margin-top:1px}
.aest{margin-left:auto;padding:3px 8px;border-radius:13px;font-size:9px;font-weight:700;text-transform:uppercase}
.ep{background:rgba(39,174,96,.16);color:var(--ex);border:1px solid rgba(39,174,96,.3)}
.ea{background:rgba(231,76,60,.16);color:var(--pe);border:1px solid rgba(231,76,60,.3)}
.ej{background:rgba(243,156,18,.16);color:var(--ad);border:1px solid rgba(243,156,18,.3)}
.en{background:#3a3a3a;color:#888}
.tg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.tb{padding:10px 16px;border:2px solid var(--gm);background:transparent;border-radius:10px;cursor:pointer;font-size:11px;font-weight:700;color:#777;transition:all .2s;font-family:Lato,sans-serif}
.tb:hover{border-color:var(--do);color:var(--do)}.tb.activo{border-color:var(--do);background:rgba(212,175,55,.09);color:var(--do)}
.calg{display:grid;grid-template-columns:repeat(7,1fr);gap:2px}
.cdh{text-align:center;font-size:9px;font-weight:700;color:var(--do);padding:6px;text-transform:uppercase}
.cd{aspect-ratio:1;display:flex;align-items:center;justify-content:center;border-radius:6px;font-size:11px;cursor:pointer;transition:all .16s;position:relative}
.cd:hover{background:rgba(212,175,55,.1)}.cd.hoy{background:var(--do);color:var(--ng);font-weight:700}
.cd.te::after{content:'';position:absolute;bottom:2px;left:50%;transform:translateX(-50%);width:3px;height:3px;background:var(--ex);border-radius:50%}
.cd.om{color:#333}
.cel-card{background:var(--gr);border:1px solid rgba(212,175,55,.09);border-radius:12px;padding:15px;transition:all .3s;cursor:pointer}
.cel-card:hover{border-color:rgba(212,175,55,.25);transform:translateY(-2px);box-shadow:0 0 20px rgba(212,175,55,.06)}
.cel-n{font-family:Cinzel,serif;color:var(--do);font-size:13px;margin-bottom:4px}.cel-l{color:#777;font-size:10px;margin-bottom:8px}
.cel-st{display:flex;gap:12px}.cel-sn{font-size:17px;font-weight:700;color:#fff;text-align:center}.cel-sl{font-size:9px;color:#666;text-transform:uppercase;text-align:center}
.seg-c{background:var(--gr);border-left:4px solid var(--do);border-radius:0 10px 10px 0;padding:13px;margin-bottom:10px}
.seg-c.fr{border-left-color:var(--ex)}.seg-c.oc{border-left-color:var(--ad)}.seg-c.in2{border-left-color:var(--pe)}
.seg-n{font-weight:700;color:#fff;font-size:13px}.seg-p{font-size:20px;font-weight:700;font-family:Cinzel,serif}
.pbar{width:100%;height:6px;background:var(--gm);border-radius:3px;overflow:hidden;margin-top:6px}
.pfill{height:100%;border-radius:3px;transition:width .5s ease}
.tcw{position:fixed;top:72px;right:16px;z-index:9000;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--nc);border-radius:10px;padding:12px 15px;box-shadow:0 8px 28px rgba(0,0,0,.4);display:flex;align-items:center;gap:10px;font-size:12px;color:#fff;min-width:250px;max-width:330px;border-left:4px solid var(--ex);animation:tIn .32s ease}
.toast.error{border-left-color:var(--pe)}.toast.warning{border-left-color:var(--ad)}.toast.info{border-left-color:var(--in)}
@keyframes tIn{from{opacity:0;transform:translateX(100%)}to{opacity:1;transform:translateX(0)}}
.txb{margin-left:auto;cursor:pointer;color:#777;font-size:16px;background:none;border:none}
.evc{background:var(--gr);border:1px solid rgba(212,175,55,.07);border-radius:10px;padding:13px;display:flex;gap:12px;align-items:flex-start;margin-bottom:9px;transition:all .2s}
.evc:hover{border-color:rgba(212,175,55,.22)}.evfb{width:46px;height:46px;background:rgba(212,175,55,.07);border:1px solid rgba(212,175,55,.22);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;flex-shrink:0}
.evd{font-family:Cinzel,serif;color:var(--do);font-size:18px;font-weight:700;line-height:1}.evm{color:#777;font-size:8px;text-transform:uppercase}
.evt{font-weight:700;color:#fff;font-size:12px;margin-bottom:2px}.evds{color:#777;font-size:10px}.evh{color:var(--do);font-size:9px;margin-top:4px;font-weight:700}
.orc{background:var(--gr);border-radius:10px;padding:13px;margin-bottom:9px;border-left:4px solid var(--pu)}
.ort{font-weight:700;color:#fff;font-size:12px}.orx{color:#999;font-size:11px;margin-top:4px;font-style:italic}.orm{color:#666;font-size:10px;margin-top:6px}
.prc{background:var(--gr);border-radius:10px;padding:13px;margin-bottom:9px;border-left:4px solid var(--in)}
.prc.vc{border-left-color:var(--pe)}.prc.pg{border-left-color:var(--ex)}
.cui{display:flex;align-items:center;gap:11px;padding:9px 0;border-bottom:1px solid rgba(255,255,255,.04)}
.cui:last-child{border-bottom:none}
.cuav{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--pu),#c39bd3);display:flex;align-items:center;justify-content:center;font-size:14px}
.cun{font-weight:700;color:#fff;font-size:12px}.cuf{font-size:10px;color:#777}.cud{margin-left:auto;font-size:11px;font-weight:700}
.plt-g{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:16px}
.pltc{border:2px solid rgba(212,175,55,.1);border-radius:12px;overflow:hidden;cursor:pointer;transition:all .3s}
.pltc:hover{transform:translateY(-3px);border-color:var(--do);box-shadow:0 0 20px rgba(212,175,55,.1)}
.pltpv{height:115px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:12px;text-align:center;padding:8px}
.plti{padding:9px;background:var(--gr)}.pltn{font-weight:700;color:#fff;font-size:11px}
.dsg{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-bottom:12px}
.dsb{padding:8px 3px;border:2px solid var(--gm);background:transparent;border-radius:8px;cursor:pointer;font-size:10px;font-weight:700;color:#777;text-align:center;transition:all .2s;font-family:Lato,sans-serif}
.dsb.activo{border-color:var(--do);color:var(--do);background:rgba(212,175,55,.07)}
.clg{display:grid;grid-template-columns:repeat(8,1fr);gap:6px;margin-bottom:10px}
.cls{height:33px;border-radius:6px;cursor:pointer;border:3px solid transparent;transition:all .16s}
.cls:hover{transform:scale(1.08)}.cls.activo{border-color:var(--do);box-shadow:0 0 9px rgba(212,175,55,.38)}
.pvbox{background:var(--ng);border-radius:10px;padding:12px;text-align:center}
canvas{max-width:100%;height:auto;border-radius:6px}
.tabs{display:flex;gap:0;border-bottom:1px solid rgba(212,175,55,.1);margin-bottom:16px}
.tab{padding:10px 16px;cursor:pointer;color:#777;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;border-bottom:3px solid transparent;transition:all .2s;margin-bottom:-1px}
.tab:hover{color:var(--do)}.tab.activo{color:var(--do);border-bottom-color:var(--do)}
.alr{border-radius:9px;padding:12px 15px;margin-bottom:12px;display:flex;align-items:flex-start;gap:10px;font-size:12px}
.alr-i{background:rgba(41,128,185,.09);border:1px solid rgba(41,128,185,.2);color:#7ec8e3}
.alr-w{background:rgba(243,156,18,.09);border:1px solid rgba(243,156,18,.2);color:#f0c96c}
.donbox{background:rgba(41,128,185,.05);border:1px solid rgba(41,128,185,.16);border-radius:10px;padding:14px;margin-top:10px}
.empty{text-align:center;padding:46px 16px;color:#555}.empty-ico{font-size:42px;margin-bottom:12px}.empty-txt{font-size:12px}
input[type=range]{-webkit-appearance:none;width:100%;height:4px;background:var(--gm);border-radius:2px;outline:none}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;background:var(--do);border-radius:50%;cursor:pointer}
input[type=color]{width:100%;height:36px;border:none;border-radius:7px;cursor:pointer;background:none}
@media(max-width:768px){
  .sidebar{display:none}
  .sg{grid-template-columns:1fr 1fr}
  .fg{grid-template-columns:1fr}
  .hdr-title{font-size:11px}
  .hdr-sub{display:none}
  .vp{padding:12px}
  /* Finanzas m√≥vil */
  .fin-cat-card{padding:14px 10px}
  .fin-cat-ico{font-size:26px}
  .fin-cat-num{font-size:16px}
  /* Botones m√°s grandes */
  .btn{min-height:38px}
  /* Asistencia m√≥vil ‚Äî lista full width en pantallas peque√±as */
  #listaAsist{grid-template-columns:1fr!important}
  #listaPresentes{grid-template-columns:1fr!important}
  #listaExcusas{grid-template-columns:1fr!important}
  #buscarAsist{font-size:16px;padding:14px 16px}
  /* Modales desde abajo en m√≥vil */
  .mv{border-radius:16px 16px 0 0;max-height:92vh}
  .modal-overlay{align-items:flex-end;padding:0}
  /* Tabla scroll horizontal */
  .tc{-webkit-overflow-scrolling:touch}
  /* Contadores de asistencia en 2x2 en m√≥vil muy peque√±o */
}
  .ph-t{font-size:15px}
}
/* === MEN√ö M√ìVIL === */
#btnMenu{display:none;padding:7px 11px;background:rgba(212,175,55,.1);border:1px solid rgba(212,175,55,.25);border-radius:8px;color:var(--do);font-size:18px;cursor:pointer;line-height:1}
@media(max-width:768px){#btnMenu{display:flex;align-items:center}}
#sidebarOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:800;backdrop-filter:blur(3px)}
#sidebarOverlay.open{display:block}
@media(max-width:768px){
  .sidebar{display:none;position:fixed;left:0;top:0;height:100%;z-index:900;width:240px;animation:slideIn .25s ease}
  .sidebar.open{display:flex;flex-direction:column}
  @keyframes slideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
}
/* Nav inferior m√≥vil */
#mobileNav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--nc);border-top:1px solid rgba(212,175,55,.15);z-index:700;padding:6px 0 env(safe-area-inset-bottom,6px)}
@media(max-width:768px){#mobileNav{display:flex}}
.mn-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:4px 2px;cursor:pointer;color:#555;transition:all .2s;font-size:9px;text-transform:uppercase;letter-spacing:.5px;font-weight:700;border:none;background:none;font-family:Lato,sans-serif}
.mn-btn.activo,.mn-btn:hover{color:var(--do)}
.mn-btn .mn-ico{font-size:20px;line-height:1}
@media(max-width:768px){.app-body{height:calc(100vh - 68px - 58px)}.contenido{padding-bottom:4px}}


.perm-card{background:var(--gr);border:1px solid rgba(255,255,255,.06);border-radius:9px;padding:10px 12px;transition:all .2s}
.perm-card:hover{border-color:rgba(212,175,55,.2)}
.perm-card.activo{border-color:rgba(212,175,55,.4);background:rgba(212,175,55,.06)}
.perm-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.perm-title{font-size:12px;font-weight:700;color:#fff;display:flex;align-items:center;gap:6px}
.perm-sub{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.perm-btn{padding:3px 8px;border-radius:5px;font-size:9px;font-weight:700;cursor:pointer;border:1px solid;transition:all .2s;font-family:Lato,sans-serif;text-transform:uppercase;letter-spacing:.5px}
.perm-btn.ver{background:rgba(41,128,185,.1);color:#2980b9;border-color:rgba(41,128,185,.3)}
.perm-btn.ver.on{background:#2980b9;color:#fff}
.perm-btn.crear{background:rgba(39,174,96,.1);color:#27ae60;border-color:rgba(39,174,96,.3)}
.perm-btn.crear.on{background:#27ae60;color:#fff}
.perm-btn.editar{background:rgba(243,156,18,.1);color:#f39c12;border-color:rgba(243,156,18,.3)}
.perm-btn.editar.on{background:#f39c12;color:#141414}
.perm-btn.eliminar{background:rgba(231,76,60,.1);color:#e74c3c;border-color:rgba(231,76,60,.3)}
.perm-btn.eliminar.on{background:#e74c3c;color:#fff}
.perm-btn.exportar{background:rgba(142,68,173,.1);color:#8e44ad;border-color:rgba(142,68,173,.3)}
.perm-btn.exportar.on{background:#8e44ad;color:#fff}

/* Reportes mejorados */
.rep-tabs{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:16px}
.rep-tab{padding:8px 16px;border-radius:9px;cursor:pointer;font-size:11px;font-weight:700;border:2px solid transparent;transition:all .2s;font-family:Lato,sans-serif;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:6px}
.rep-tab.fr{background:rgba(39,174,96,.1);color:#27ae60;border-color:rgba(39,174,96,.25)}
.rep-tab.fr.on{background:#27ae60;color:#fff}
.rep-tab.si{background:rgba(41,128,185,.1);color:#2980b9;border-color:rgba(41,128,185,.25)}
.rep-tab.si.on{background:#2980b9;color:#fff}
.rep-tab.oc{background:rgba(243,156,18,.1);color:#f39c12;border-color:rgba(243,156,18,.25)}
.rep-tab.oc.on{background:#f39c12;color:#141414}
.rep-tab.in2{background:rgba(231,76,60,.1);color:#e74c3c;border-color:rgba(231,76,60,.25)}
.rep-tab.in2.on{background:#e74c3c;color:#fff}
.rep-tab.seg{background:rgba(142,68,173,.1);color:#8e44ad;border-color:rgba(142,68,173,.25)}
.rep-tab.seg.on{background:#8e44ad;color:#fff}
/* Alertas de seguimiento en dashboard */
.alerta-seg{background:rgba(231,76,60,.07);border:1px solid rgba(231,76,60,.25);border-radius:11px;padding:13px 15px;margin-bottom:8px;display:flex;align-items:center;gap:12px;transition:all .2s;cursor:pointer}
.alerta-seg:hover{background:rgba(231,76,60,.12)}
.alerta-seg.oc{background:rgba(243,156,18,.07);border-color:rgba(243,156,18,.25)}
.alerta-seg.oc:hover{background:rgba(243,156,18,.12)}
.alerta-ico{font-size:22px;flex-shrink:0}
.alerta-info{flex:1}
.alerta-nom{font-weight:700;color:#fff;font-size:13px}
.alerta-det{font-size:10px;color:#888;margin-top:2px}
.alerta-badge{padding:4px 10px;border-radius:20px;font-size:9px;font-weight:700;text-transform:uppercase;white-space:nowrap}
.badge-peligro{background:rgba(231,76,60,.15);color:#e74c3c;border:1px solid rgba(231,76,60,.3)}
.badge-aviso{background:rgba(243,156,18,.15);color:#f39c12;border:1px solid rgba(243,156,18,.3)}
/* Tarjeta miembro en reporte */
.mcard{background:var(--nc);border:1px solid rgba(255,255,255,.05);border-radius:11px;padding:14px;margin-bottom:8px;transition:all .2s}
.mcard:hover{border-color:rgba(212,175,55,.2);transform:translateY(-1px)}
.mcard.fr{border-left:3px solid #27ae60}
.mcard.si{border-left:3px solid #2980b9}
.mcard.oc{border-left:3px solid #f39c12}
.mcard.in2{border-left:3px solid #e74c3c}
.mcard-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.mcard-nom{font-weight:700;color:#fff;font-size:13px}
.mcard-pct{font-size:22px;font-weight:700;font-family:Cinzel,serif}
.mcard-det{display:flex;gap:12px;font-size:10px;color:#888;flex-wrap:wrap;margin-bottom:8px}
.mcard-det span b{color:#ccc}
.pbar{height:5px;background:#222;border-radius:3px;overflow:hidden;margin-bottom:8px}
.pfill{height:100%;border-radius:3px;transition:width .4s ease}

/* ===== TARJETAS FINANZAS ===== */
.fin-cat-card{background:var(--nc);border:2px solid rgba(255,255,255,.07);border-radius:14px;padding:18px 14px;text-align:center;cursor:pointer;transition:all .25s;position:relative;overflow:hidden}
.fin-cat-card:hover{transform:translateY(-3px);border-color:rgba(212,175,55,.3);box-shadow:0 8px 24px rgba(0,0,0,.3)}
.fin-cat-card[data-active="true"]{border-color:var(--do);background:rgba(212,175,55,.07);box-shadow:0 0 20px rgba(212,175,55,.1)}
.fin-cat-ico{font-size:34px;margin-bottom:8px;line-height:1}
.fin-cat-lbl{font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;font-weight:700;margin-bottom:6px}
.fin-cat-num{font-size:20px;font-weight:700;color:#fff;font-family:Cinzel,serif}
/* ===== M√ìDULOS LIMPIOS ===== */
.vp-clean .panel{margin-bottom:0}
.modulo-desc{background:rgba(212,175,55,.04);border:1px solid rgba(212,175,55,.1);border-radius:10px;padding:12px 16px;margin-bottom:18px;font-size:12px;color:#888;display:flex;align-items:center;gap:10px}
/* Historial de finanzas en cards */
.fin-item{display:flex;align-items:center;gap:14px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.04);transition:all .2s}
.fin-item:last-child{border-bottom:none}
.fin-item:hover{background:rgba(255,255,255,.02);border-radius:8px;padding-left:8px}
.fin-item-ico{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.fin-item-info{flex:1;min-width:0}
.fin-item-nom{font-weight:700;color:#fff;font-size:13px}
.fin-item-det{font-size:10px;color:#666;margin-top:2px}
.fin-item-monto{font-size:18px;font-weight:700;font-family:Cinzel,serif;flex-shrink:0;text-align:right}
.fin-item-monto.entrada{color:#27ae60}
.fin-item-monto.gasto{color:#e74c3c}
/* Foto avatar en tabla */
.mava{width:38px;height:38px;border-radius:50%;background:#2a2a2a;border:2px solid rgba(212,175,55,.25);display:flex;align-items:center;justify-content:center;overflow:hidden;font-size:16px;color:#666;flex-shrink:0}
.mava img{width:100%;height:100%;object-fit:cover}
/* Tema pendiente card */
.tema-card{border-radius:9px;padding:10px 12px;margin-bottom:7px;border:1px solid;transition:all .2s}
.tema-card.alta{background:rgba(231,76,60,.07);border-color:rgba(231,76,60,.25)}
.tema-card.media{background:rgba(243,156,18,.07);border-color:rgba(243,156,18,.25)}
.tema-card.baja{background:rgba(39,174,96,.07);border-color:rgba(39,174,96,.2)}
.tema-card.resuelto{background:rgba(255,255,255,.02);border-color:rgba(255,255,255,.06);opacity:.6}
.tema-top{display:flex;align-items:flex-start;justify-content:space-between;gap:8px;margin-bottom:4px}
.tema-tit{font-weight:700;color:#fff;font-size:12px}
.tema-det{font-size:10px;color:#888;line-height:1.5}
.tema-meta{display:flex;gap:8px;margin-top:6px;flex-wrap:wrap;align-items:center}
.alerta-cnt{background:rgba(231,76,60,.2);color:#e74c3c;border-radius:20px;padding:2px 7px;font-size:9px;font-weight:700}
/* Tab form miembro */
.mftab.activo{background:var(--do) !important;color:#fff !important}

/* Historial de acciones del miembro */
.hist-item{display:flex;gap:10px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.05);align-items:flex-start}
.hist-item:last-child{border-bottom:none}
.hist-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;margin-top:4px}
.hist-body{flex:1}
.hist-accion{font-size:12px;font-weight:700;color:#fff}
.hist-det{font-size:10px;color:#777;margin-top:2px;line-height:1.5}
.hist-meta{font-size:9px;color:#444;margin-top:4px;display:flex;gap:10px;flex-wrap:wrap}
/* Pol√≠tica contrase√±a custom */
.pw-req{display:flex;align-items:center;gap:7px;padding:6px 0;font-size:11px;border-bottom:1px solid rgba(255,255,255,.04)}
.pw-req:last-child{border-bottom:none}
.pw-req-ico{font-size:14px;flex-shrink:0}
.pw-req-lbl{flex:1;color:#aaa}
.pw-toggle{display:flex;align-items:center;gap:8px}
.pw-toggle input[type=checkbox]{width:16px;height:16px;accent-color:#d4af37;cursor:pointer}
.pw-toggle label{font-size:11px;color:#aaa;cursor:pointer}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<div class="tcw" id="toastC"></div>

<div id="loginBox">
<div class="lcard">
  <div class="lcross" id="loginLogo" style="overflow:hidden;padding:0">
    <img id="loginLogoImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%">
    <span id="loginLogoCross">‚úù</span>
  </div>
  <h1>Centro Cristiano</h1>
  <h2>Sublime Gracia de Dios</h2>
  <div class="lg"><label>Seleccionar Usuario</label><select id="selUsr" onchange="selUsr2()"><option value="">-- Seleccione --</option></select></div>
  <div class="lg"><label>Usuario</label><input type="text" id="usrInput" placeholder="Usuario" readonly></div>
  <div class="lg"><label>Contrase√±a</label><input type="password" id="pwInput" placeholder="Contrase√±a" onkeydown="if(event.key==='Enter')login()"></div>
  <button class="btnl" onclick="login()">‚úù Ingresar al Sistema</button>
  <div class="lhint">Sistema Integral de Gesti√≥n Ministerial<br><b>Usuarios:</b> admin / pastor / tesorero / secretario<br><b>Contrase√±a:</b> 12345</div>
</div>
</div>

<div id="mainApp">
  <div class="hdr">
    <div class="hdr-b">
      <div class="hdr-ico" id="hdrLogo" style="overflow:hidden;padding:0">
        <img id="hdrLogoImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%">
        <span id="hdrLogoCross">‚úù</span>
      </div>
      <div><div class="hdr-title">Centro Cristiano Sublime Gracia</div><div class="hdr-sub">Sistema Integral de Gesti√≥n Ministerial</div></div>
    </div>
    <div class="hdr-r">
      <button id="btnMenu" onclick="toggleSidebar()" aria-label="Men√∫">‚ò∞</button>
      <div class="hcumple" id="hCumple">üéÇ <span id="cumpleTxt"></span></div>
      <div class="ub"><span>üë§</span><span id="nomUsr"></span><span id="rolUsr" class="ur"></span></div>
      <button class="btnlo" onclick="logout()">‚èª Salir</button>
    </div>
  </div>

  <div class="app-body">
    <div class="sidebar">
      <div class="sb-sec">Principal</div>
      <div class="ni" id="nav-dashboard" onclick="go('dashboard')"><span class="ico">üìä</span>Dashboard</div>
      <div class="ni" id="nav-calendario" onclick="go('calendario')"><span class="ico">üìÖ</span>Calendario</div>
      <div class="sb-sec">Membres√≠a</div>
      <div class="ni" id="nav-membresia" onclick="go('membresia')"><span class="ico">üë•</span>Miembros</div>
      <div class="ni" id="nav-visitas" onclick="go('visitas')"><span class="ico">üëÅÔ∏è</span>Visitas</div>
      <div class="ni" id="nav-celulas" onclick="go('celulas')"><span class="ico">üè†</span>C√©lulas</div>
      <div class="ni" id="nav-ninos" onclick="go('ninos')"><span class="ico">üë∂</span>√Årea Infantil</div>
      <div class="ni" id="nav-oracion" onclick="go('oracion')"><span class="ico">üôè</span>Peticiones</div>
      <div class="sb-sec">Operaciones</div>
      <div class="ni" id="nav-asistencia" onclick="go('asistencia')"><span class="ico">üìã</span>Asistencia</div>
      <div class="ni" id="nav-finanzas" onclick="go('finanzas')"><span class="ico">üí∞</span>Finanzas</div>
      <div class="ni" id="nav-prestamos" onclick="go('prestamos')"><span class="ico">üí≥</span>Pr√©stamos</div>
      <div class="sb-sec">Reportes</div>
      <div class="ni" id="nav-reportes" onclick="go('reportes')"><span class="ico">üìà</span>Reportes</div>
      <div class="sb-sec">Comunicaci√≥n</div>
      <div class="ni" id="nav-publicidad" onclick="go('publicidad')"><span class="ico">üì¢</span>Publicidad</div>
      <div class="ni" id="nav-comunicacion" onclick="go('comunicacion')"><span class="ico">üìß</span>Comunicaci√≥n</div>
      <div class="ndv"></div>
      <div class="ni" id="nav-auditoria" onclick="go('auditoria')"><span class="ico">üîç</span>Auditor√≠a</div>
      <div class="ni" id="nav-admin" onclick="go('admin')"><span class="ico">‚öôÔ∏è</span>Administraci√≥n</div>
    </div>

    <div class="contenido">

      <!-- DASHBOARD -->
      <div id="vp-dashboard" class="vp">
        <div class="ph"><div><div class="ph-t">üìä Dashboard</div><div class="ph-s" id="dashFecha"></div></div><button class="btn btn-s btn-sm" onclick="renderDash()">üîÑ Actualizar</button></div>
        <div class="sg">
          <div class="sc do"><div class="sc-ico">üë•</div><div class="sc-num" id="dMiembros">0</div><div class="sc-lbl">Miembros Activos</div></div>
          <div class="sc ve"><div class="sc-ico">üí∞</div><div class="sc-num" id="dFinanzas">$0</div><div class="sc-lbl">Finanzas del Mes</div></div>
          <div class="sc az"><div class="sc-ico">üë∂</div><div class="sc-num" id="dNinos">0</div><div class="sc-lbl">Ni√±os Registrados</div></div>
          <div class="sc ro"><div class="sc-ico">üìã</div><div class="sc-num" id="dAsist">0%</div><div class="sc-lbl">Asistencia Promedio</div></div>
          <div class="sc pu"><div class="sc-ico">üè†</div><div class="sc-num" id="dCelulas">0</div><div class="sc-lbl">C√©lulas Activas</div></div>
          <div class="sc na"><div class="sc-ico">üëÅÔ∏è</div><div class="sc-num" id="dVisitas">0</div><div class="sc-lbl">Visitas Este Mes</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="panel"><div class="ph2">üéÇ Cumplea√±os Pr√≥ximos</div><div class="pb"><div id="dashCumple"></div></div></div>
          <div class="panel"><div class="ph2">üìÖ Pr√≥ximos Eventos</div><div class="pb"><div id="dashEv"></div></div></div>
          <div class="panel"><div class="ph2">üí∞ Resumen Financiero</div><div class="pb">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:#aaa;font-size:12px">Diezmos</span><span id="db_d" style="color:var(--do);font-weight:700">$0</span></div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:#aaa;font-size:12px">Ofrendas</span><span id="db_o" style="color:var(--do);font-weight:700">$0</span></div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:#aaa;font-size:12px">Primicias</span><span id="db_pr" style="color:var(--do);font-weight:700">$0</span></div>
            <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span style="color:#aaa;font-size:12px">Donaciones</span><span id="db_dn" style="color:var(--do);font-weight:700">$0</span></div>
            <hr style="border-color:rgba(212,175,55,.1);margin:10px 0">
            <div style="display:flex;justify-content:space-between"><span style="color:#fff;font-weight:700">Total</span><span id="db_t" style="color:var(--ex);font-size:16px;font-weight:700">$0</span></div>
          </div></div>
          <div class="panel"><div class="ph2">üôè Peticiones Recientes</div><div class="pb"><div id="dashOra"></div></div></div>
        </div>
      </div>

      <!-- CALENDARIO -->
      
        <!-- Alertas de Seguimiento Pastoral -->
        <div class="panel" style="margin-top:4px">
          <div class="ph2" style="display:flex;align-items:center;justify-content:space-between">
            <span>üîî Alertas de Seguimiento Pastoral <span id="dashAlertasCnt" style="background:rgba(231,76,60,.2);color:#e74c3c;border-radius:20px;padding:2px 8px;font-size:10px;margin-left:6px">0</span></span>
            <button class="btn btn-s btn-xs" onclick="go('reportes')">Ver todos ‚Üí</button>
          </div>
          <div class="pb" id="dashAlertas">
            <div style="color:#555;font-size:12px;padding:4px">Genera un reporte en la secci√≥n Reportes para ver las alertas aqu√≠.</div>
          </div>
        </div>
        <!-- Alertas Temas Pendientes con Miembros -->
        <div class="panel" style="margin-top:4px">
          <div class="ph2" style="display:flex;align-items:center;justify-content:space-between">
            <span>üìå Temas Urgentes con Miembros <span id="dashTemasCnt" style="background:rgba(231,76,60,.2);color:#e74c3c;border-radius:20px;padding:2px 8px;font-size:10px;margin-left:6px">0</span></span>
            <button class="btn btn-s btn-xs" onclick="go('membresia')">Ver miembros ‚Üí</button>
          </div>
          <div class="pb" id="dashTemasPend">
            <div style="color:#555;font-size:11px;padding:6px">Los temas de alta prioridad o vencidos aparecer√°n aqu√≠.</div>
          </div>
        </div>
      <div id="vp-calendario" class="vp">
        <div class="ph"><div><div class="ph-t">üìÖ Calendario de Eventos</div><div class="ph-s">Gestiona los eventos de la iglesia</div></div><button class="btn btn-p btn-sm" onclick="openM('mEvento');document.getElementById('evId').value='';document.getElementById('evFecha').valueAsDate=new Date()">‚ûï Nuevo</button></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="panel">
            <div class="ph2"><div style="display:flex;align-items:center;justify-content:space-between;width:100%"><button class="btn btn-s btn-xs" onclick="navCal(-1)">‚óÄ</button><span id="calMes" style="font-family:Cinzel,serif;color:var(--do)"></span><button class="btn btn-s btn-xs" onclick="navCal(1)">‚ñ∂</button></div></div>
            <div class="pb"><div class="calg" id="calGrid"></div></div>
          </div>
          <div class="panel"><div class="ph2">üìã Eventos del Mes</div><div class="pb" style="max-height:400px;overflow-y:auto"><div id="listaEv"></div></div></div>
        </div>
      </div>

      <!-- MEMBRES√çA -->
      <div id="vp-membresia" class="vp">
        <div class="ph">
          <div><div class="ph-t">üë• Miembros</div><div class="ph-s" id="subMiem"></div></div>
          <div style="display:flex;gap:8px;align-items:center"><div class="sb"><input type="text" id="buscarM" placeholder="Buscar..." onkeyup="filtrarM()"></div><button class="btn btn-xl btn-sm" onclick="if(!puedeExportar('membresia')){toast('Sin permiso de exportar','error');return}exportMiembrosCSV()">üìä CSV</button><button class="btn btn-p btn-sm" onclick="limpiarM()">‚ûï Nuevo</button></div>
        </div>
        <div class="panel">
          <div class="ph2">üìù Formulario<span id="editLbl" style="font-size:10px;color:var(--ad);display:none"> ‚Äî EDITANDO</span></div>
          <div class="pb">
            <input type="hidden" id="mId">
            <div style="display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap">
              <button class="btn btn-p btn-sm mftab activo" onclick="tabMForm('general',this)">üë§ General</button>
              <button class="btn btn-s btn-sm mftab" onclick="tabMForm('identidad',this)">ü™™ Identidad y Foto</button>
              <button class="btn btn-s btn-sm mftab" onclick="tabMForm('temas',this)">üìå Temas Pendientes</button>
              <button class="btn btn-s btn-sm mftab" onclick="tabMForm('historial',this)">üìã Historial</button>
            </div>
            <div id="mfGeneral">
              <div class="fg">
                <div class="ff"><label>Nombre Completo *</label><input type="text" id="mNom" placeholder="Nombre y apellido"></div>
                <div class="ff"><label>Tel√©fono</label><input type="tel" id="mTel" placeholder="000-000-0000"></div>
                <div class="ff"><label>Email</label><input type="email" id="mEmail" placeholder="correo@ejemplo.com"></div>
                <div class="ff"><label>Direcci√≥n</label><input type="text" id="mDir" placeholder="Direcci√≥n completa"></div>
                <div class="ff"><label>Fecha Nacimiento</label><input type="date" id="mFNac"></div>
                <div class="ff"><label>Fecha Ingreso</label><input type="date" id="mFIng"></div>
                <div class="ff"><label>Estado Civil</label><select id="mECiv"><option value="soltero">Soltero/a</option><option value="casado">Casado/a</option><option value="divorciado">Divorciado/a</option><option value="viudo">Viudo/a</option></select></div>
                <div class="ff"><label>Ministerio</label><select id="mMin"><option value="ninguno">Ninguno</option><option value="alabanza">Alabanza</option><option value="intercesion">Intercesi√≥n</option><option value="ensenanza">Ense√±anza</option><option value="evangelismo">Evangelismo</option><option value="jovenes">J√≥venes</option><option value="ninos">Ni√±os</option><option value="damas">Damas</option><option value="caballeros">Caballeros</option><option value="mantenimiento">Mantenimiento</option><option value="pastora">Pastora</option><option value="pastores">Pastores</option><option value="musicos">M√∫sicos</option><option value="danzarinas">Danzarinas</option><option value="profesoras-eb">Profesoras EB</option><option value="servicios">Servicios</option><option value="multimedia">üé¨ Multimedia</option><option value="otros">Otros</option></select></div>
                <div class="ff"><label>Estado</label><select id="mEst"><option value="activo">Activo</option><option value="inactivo">Inactivo</option><option value="visitante">Visitante</option></select></div>
                <div class="ff"><label>C√©lula</label><select id="mCel"><option value="">Sin c√©lula</option></select></div>
                <div class="ff full"><label>Notas</label><textarea id="mNotas" placeholder="Notas adicionales..."></textarea></div>
              </div>
            </div>
            <div id="mfIdentidad" style="display:none">
              <div class="fg">
                <div class="ff"><label>C√©dula / ID Nacional</label><input type="text" id="mCedula" placeholder="000-0000000-0" maxlength="20"></div>
                <div class="ff"><label>Pasaporte (opcional)</label><input type="text" id="mPasaporte" placeholder="N√∫mero de pasaporte"></div>
                <div class="ff"><label>Fecha Vencimiento ID</label><input type="date" id="mCedulaVence"></div>
                <div class="ff"><label>Nacionalidad</label><input type="text" id="mNacionalidad" placeholder="Ej: Dominicana"></div>
              </div>
              <div style="margin-top:14px;border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:14px">
                <div style="font-weight:700;color:#d4af37;font-size:12px;margin-bottom:12px">üì∑ Foto del Miembro</div>
                <div style="display:flex;align-items:flex-start;gap:16px;flex-wrap:wrap">
                  <div id="fotoPreview" style="width:100px;height:100px;border-radius:50%;background:#2a2a2a;border:2px solid rgba(212,175,55,.3);display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0">
                    <span style="font-size:36px;color:#555" id="fotoPlaceholder">üë§</span>
                    <img id="fotoImg" style="display:none;width:100%;height:100%;object-fit:cover" src="">
                  </div>
                  <div style="flex:1">
                    <input type="file" id="fotoFile" accept="image/*" style="display:none" onchange="cargarFoto(event)">
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                      <button class="btn btn-s btn-sm" onclick="document.getElementById('fotoFile').click()">üì∑ Seleccionar foto</button>
                      <button class="btn btn-d btn-sm" onclick="borrarFoto()">üóëÔ∏è Quitar foto</button>
                    </div>
                    <div style="font-size:10px;color:#555">Formatos: JPG, PNG, WEBP. La foto se comprime y guarda en la base de datos.</div>
                    <input type="hidden" id="mFoto">
                  </div>
                </div>
              </div>
            </div>
            <div id="mfTemas" style="display:none">
              <div style="margin-bottom:12px">
                <div style="font-size:10px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">‚ûï Nuevo tema pendiente</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                  <input type="text" id="temaTitulo" placeholder="Ej: Consejer√≠a, seguimiento bautismo, problema familiar..." style="flex:1;min-width:180px">
                  <select id="temaPrioridad" style="padding:8px 10px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#fff;font-size:12px">
                    <option value="alta">üî¥ Alta prioridad</option>
                    <option value="media" selected>üü° Media</option>
                    <option value="baja">üü¢ Baja</option>
                  </select>
                </div>
                <textarea id="temaDetalle" placeholder="Detalles del tema, problema o situaci√≥n a tratar..." rows="2" style="width:100%;padding:8px 10px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#fff;font-size:12px;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>
                <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                  <input type="date" id="temaFechaLimite" style="padding:8px 10px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#fff;font-size:12px">
                  <label style="font-size:11px;color:#888">Fecha l√≠mite (opcional)</label>
                  <button class="btn btn-p btn-sm" onclick="agregarTema()">‚ûï Agregar</button>
                </div>
              </div>
              <div id="listaTemasPend">
                <div style="color:#555;font-size:12px;padding:12px;text-align:center">Guarda el miembro primero, luego agrega temas aqu√≠.</div>
              </div>
              <input type="hidden" id="mTemas">
            </div>
            <div id="mfHistorial" style="display:none">
              <div style="margin-bottom:12px">
                <div style="font-size:10px;color:#888;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">‚ûï Registrar acci√≥n manual</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
                  <select id="histTipo" style="padding:8px 10px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#fff;font-size:12px">
                    <option value="visita">üè† Visita domiciliaria</option>
                    <option value="llamada">üìû Llamada telef√≥nica</option>
                    <option value="consejeria">ü§ù Consejer√≠a</option>
                    <option value="oracion">üôè Oraci√≥n personal</option>
                    <option value="bautismo">üíß Bautismo</option>
                    <option value="membresia">üìú Membres√≠a</option>
                    <option value="disciplina">‚ö†Ô∏è Disciplina</option>
                    <option value="restauracion">‚úÖ Restauraci√≥n</option>
                    <option value="capacitacion">üìö Capacitaci√≥n</option>
                    <option value="ministerio">üé§ Cambio de ministerio</option>
                    <option value="otro">üìù Otro</option>
                  </select>
                  <input type="date" id="histFecha" style="padding:8px 10px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#fff;font-size:12px">
                </div>
                <textarea id="histDetalle" placeholder="Describe la acci√≥n, observaciones o resultado..." rows="2" style="width:100%;padding:8px 10px;background:#2a2a2a;border:1px solid #444;border-radius:8px;color:#fff;font-size:12px;resize:vertical;box-sizing:border-box;margin-bottom:8px"></textarea>
                <button class="btn btn-p btn-sm" onclick="agregarHistorial()">‚ûï Registrar acci√≥n</button>
              </div>
              <div id="listaHistorial" style="margin-top:8px">
                <div style="color:#555;font-size:12px;padding:8px;text-align:center">No hay acciones registradas para este miembro.</div>
              </div>
              <input type="hidden" id="mHistorial">
            </div>
            <div class="bgrp" style="margin-top:14px">
              <button class="btn btn-p" onclick="guardarM()">üíæ Guardar miembro</button>
              <button class="btn btn-s" onclick="limpiarM()">üîÑ Limpiar</button>
            </div>
          </div>
        </div>
        <div class="panel"><div class="ph2">üë• Lista <span id="cuentaM" style="font-size:10px;color:#666"></span></div>
          <div class="tc" style="margin-top:0;border:none;border-radius:0"><table><thead><tr><th style="width:50px">Foto</th><th>Nombre / C√©dula</th><th>Ministerio</th><th>Estado</th><th>Alertas</th><th>Acciones</th></tr></thead><tbody id="tbM"></tbody></table></div>
        </div>
      </div>

      <!-- VISITAS -->
      <div id="vp-visitas" class="vp">
        <div class="ph"><div><div class="ph-t">üëÅÔ∏è Control de Visitas</div><div class="ph-s">Seguimiento de personas que visitan</div></div><button class="btn btn-p btn-sm" onclick="openM('mVisita');document.getElementById('visId').value=''">‚ûï Registrar</button></div>
        <div class="sg">
          <div class="sc az"><div class="sc-ico">üëÅÔ∏è</div><div class="sc-num" id="vTot">0</div><div class="sc-lbl">Total Visitas</div></div>
          <div class="sc ve"><div class="sc-ico">üîÑ</div><div class="sc-num" id="vHab">0</div><div class="sc-lbl">Habituales</div></div>
          <div class="sc do"><div class="sc-ico">‚ú®</div><div class="sc-num" id="vNuv">0</div><div class="sc-lbl">Visitas Nuevas</div></div>
          <div class="sc pu"><div class="sc-ico">‚úÖ</div><div class="sc-num" id="vConv">0</div><div class="sc-lbl">Convertidos</div></div>
        </div>
        <div class="panel"><div class="ph2">üìã Registro de Visitas</div>
          <div class="tc" style="margin-top:0;border:none;border-radius:0"><table><thead><tr><th>Nombre</th><th>Tel√©fono</th><th>Fecha</th><th>¬øC√≥mo lleg√≥?</th><th>Estado</th><th>Notas</th><th>Acciones</th></tr></thead><tbody id="tbVis"></tbody></table></div>
        </div>
      </div>

      <!-- C√âLULAS -->
      <div id="vp-celulas" class="vp">
        <div class="ph"><div><div class="ph-t">üè† Grupos y C√©lulas</div><div class="ph-s">Gesti√≥n de grupos peque√±os</div></div><button class="btn btn-p btn-sm" onclick="openM('mCelula');document.getElementById('celId').value=''">‚ûï Nueva C√©lula</button></div>
        <div id="celGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px;margin-bottom:18px"></div>
        <div class="panel"><div class="ph2">üìã Todas las C√©lulas</div>
          <div class="tc" style="margin-top:0;border:none;border-radius:0"><table><thead><tr><th>Nombre</th><th>L√≠der</th><th>D√≠a/Hora</th><th>Lugar</th><th>Miembros</th><th>Acciones</th></tr></thead><tbody id="tbCel"></tbody></table></div>
        </div>
      </div>

      <!-- NI√ëOS -->
      <div id="vp-ninos" class="vp">
        <div class="ph"><div><div class="ph-t">üë∂ √Årea Infantil</div></div></div>
        <div class="panel"><div class="ph2">üìù Registrar Ni√±o</div><div class="pb">
          <div class="fg">
            <div class="ff"><label>Nombre *</label><input type="text" id="nNom" placeholder="Nombre completo"></div>
            <div class="ff"><label>Edad</label><input type="number" id="nEdad" placeholder="0" min="0" max="17"></div>
            <div class="ff"><label>Fecha Nacimiento</label><input type="date" id="nFNac"></div>
            <div class="ff"><label>Padre/Tutor *</label><select id="nPadre"><option value="">-- Seleccione --</option></select></div>
            <div class="ff"><label>Grado Escolar</label><input type="text" id="nGrado" placeholder="2do grado"></div>
            <div class="ff"><label>Tel. Emergencia</label><input type="tel" id="nEmerg" placeholder="000-000-0000"></div>
            <div class="ff full"><label>Alergias / Condiciones</label><input type="text" id="nAler" placeholder="Especifique alergias"></div>
          </div>
          <div class="bgrp"><button class="btn btn-p" onclick="guardarN()">üíæ Guardar</button><button class="btn btn-s" onclick="limpiarN()">üîÑ Limpiar</button></div>
        </div></div>
        <div class="panel"><div class="ph2">üë∂ Ni√±os Registrados</div>
          <div class="tc" style="margin-top:0;border:none;border-radius:0"><table><thead><tr><th>Nombre</th><th>Edad</th><th>Grado</th><th>Padre/Tutor</th><th>Alergias</th><th>Tel. Emergencia</th><th>Acciones</th></tr></thead><tbody id="tbNin"></tbody></table></div>
        </div>
      </div>

      <!-- ORACI√ìN -->
      <div id="vp-oracion" class="vp">
        <div class="ph"><div><div class="ph-t">üôè Peticiones de Oraci√≥n</div></div><button class="btn btn-p btn-sm" onclick="openM('mOracion');document.getElementById('orId').value=''">‚ûï Nueva Petici√≥n</button></div>
        <div class="tabs"><div class="tab activo" onclick="filtOra('todas',this)">Todas</div><div class="tab" onclick="filtOra('activa',this)">Activas</div><div class="tab" onclick="filtOra('respondida',this)">Respondidas</div><div class="tab" onclick="filtOra('urgente',this)">Urgentes</div></div>
        <div id="listaOra"></div>
      </div>

      <!-- ASISTENCIA -->
      <div id="vp-asistencia" class="vp">

        <!-- VISTA: LISTA DE ACTIVIDADES (default) -->
        <div id="vistaActividades">
          <div class="ph" style="flex-wrap:wrap;gap:10px">
            <div>
              <div class="ph-t">üìã Asistencia</div>
              <div class="ph-s">Crea una actividad para comenzar a pasar lista</div>
            </div>
            <button class="btn btn-p" onclick="abrirCrearActividad()" style="min-height:44px;padding:12px 20px;font-size:13px">
              ‚ûï Nueva Actividad
            </button>
          </div>

          <!-- Actividades pendientes -->
          <div class="panel" id="panelActividades">
            <div class="ph2">
              <span>üìÖ Actividades pendientes</span>
              <span style="font-size:10px;color:#888;font-family:Lato,sans-serif;font-weight:400">Toca "Pasar lista" para iniciar</span>
            </div>
            <div class="pb" id="listaActividades">
              <div class="empty"><div class="empty-ico">üìÖ</div><div class="empty-txt">No hay actividades pendientes.<br>Crea una nueva para comenzar.</div></div>
            </div>
          </div>

          <!-- Historial -->
          <div class="panel" id="panelHistorialAsist" style="margin-top:16px">
            <div class="ph2">üìú Listas guardadas</div>
            <div class="pb" id="listaHistorialAsist">
              <div class="empty"><div class="empty-ico">üìú</div><div class="empty-txt">A√∫n no hay listas guardadas.</div></div>
            </div>
          </div>
        </div>

        <!-- VISTA: PASAR LISTA (modo activo, oculta la lista de actividades) -->
        <div id="vistaPasarLista" style="display:none">
          <!-- Header con nombre de actividad -->
          <div style="background:linear-gradient(135deg,rgba(212,175,55,.1),rgba(212,175,55,.04));border:1px solid rgba(212,175,55,.25);border-radius:14px;padding:16px 20px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
            <div>
              <div style="font-family:Cinzel,serif;color:var(--do);font-size:16px" id="aActividadNombre">Actividad</div>
              <div style="font-size:11px;color:#888;margin-top:4px">Selecciona qui√©n asisti√≥. Los no marcados quedar√°n como ausentes al guardar.</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn btn-e btn-sm" onclick="marcarT('presente')" style="min-height:40px">‚úÖ Todos presentes</button>
              <button class="btn btn-s btn-sm" onclick="confirmarCerrarLista()" style="min-height:40px">‚úñ Cancelar</button>
            </div>
          </div>

          <!-- Contadores en tiempo real -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px">
            <div style="background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:26px;font-weight:700;color:#fff;font-family:Cinzel,serif" id="aT">0</div>
              <div style="font-size:9px;color:#888;text-transform:uppercase;margin-top:4px;letter-spacing:.5px">üë• Total</div>
            </div>
            <div style="background:rgba(39,174,96,.08);border:1px solid rgba(39,174,96,.25);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:26px;font-weight:700;color:#27ae60;font-family:Cinzel,serif" id="aP">0</div>
              <div style="font-size:9px;color:#888;text-transform:uppercase;margin-top:4px;letter-spacing:.5px">‚úÖ Presentes</div>
            </div>
            <div style="background:rgba(243,156,18,.07);border:1px solid rgba(243,156,18,.2);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:26px;font-weight:700;color:#f39c12;font-family:Cinzel,serif" id="aJ">0</div>
              <div style="font-size:9px;color:#888;text-transform:uppercase;margin-top:4px;letter-spacing:.5px">üìù Excusas</div>
            </div>
            <div style="background:rgba(231,76,60,.07);border:1px solid rgba(231,76,60,.2);border-radius:12px;padding:14px;text-align:center">
              <div style="font-size:26px;font-weight:700;color:#e74c3c;font-family:Cinzel,serif" id="aA">0</div>
              <div style="font-size:9px;color:#888;text-transform:uppercase;margin-top:4px;letter-spacing:.5px">‚ùå Pendientes</div>
            </div>
          </div>

          <!-- B√∫squeda -->
          <input type="text" id="buscarAsist" placeholder="üîç Buscar miembro..." oninput="filtrarListaAsist()" 
            style="width:100%;padding:14px 16px;background:var(--gr);border:1px solid var(--gm);border-radius:12px;color:#fff;font-size:15px;font-family:Lato,sans-serif;box-sizing:border-box;margin-bottom:20px;-webkit-appearance:none">

          <!-- Secci√≥n: POR MARCAR -->
          <div id="secPendientes">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:1px;font-weight:700">üìã Por marcar</div>
              <span id="cntPendientes" style="background:rgba(255,255,255,.07);color:#aaa;border-radius:20px;padding:2px 10px;font-size:11px;font-weight:700">0</span>
            </div>
            <div id="listaAsist" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(min(100%,280px),1fr));gap:10px"></div>
          </div>

          <!-- Secci√≥n: ASISTI√ì / PRESENTE -->
          <div id="secPresentes" style="margin-top:24px;display:none">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:10px;color:#27ae60;text-transform:uppercase;letter-spacing:1px;font-weight:700">‚úÖ Asisti√≥</div>
              <span id="cntPresentes" style="background:rgba(39,174,96,.15);color:#27ae60;border-radius:20px;padding:2px 10px;font-size:11px;font-weight:700">0</span>
            </div>
            <div id="listaPresentes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(min(100%,240px),1fr));gap:8px"></div>
          </div>

          <!-- Secci√≥n: EXCUSAS -->
          <div id="secExcusas" style="margin-top:24px;display:none">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
              <div style="font-size:10px;color:#f39c12;text-transform:uppercase;letter-spacing:1px;font-weight:700">üìù Con excusa</div>
              <span id="cntExcusas" style="background:rgba(243,156,18,.15);color:#f39c12;border-radius:20px;padding:2px 10px;font-size:11px;font-weight:700">0</span>
            </div>
            <div id="listaExcusas" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(min(100%,240px),1fr));gap:8px"></div>
          </div>

          <!-- Bot√≥n guardar -->
          <div style="margin-top:32px;padding:20px;background:rgba(212,175,55,.04);border:1px solid rgba(212,175,55,.1);border-radius:14px;text-align:center">
            <div style="font-size:12px;color:#888;margin-bottom:14px">Los miembros que no est√©n en "Asisti√≥" quedar√°n como Ausentes autom√°ticamente</div>
            <div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap">
              <button class="btn btn-p" style="padding:16px 40px;font-size:15px;min-height:52px" onclick="guardarAsist()">üíæ Guardar y finalizar lista</button>
              <button class="btn btn-xl btn-sm" onclick="if(!puedeExportar('asistencia')){toast('Sin permiso','error');return}exportAsistCSV()" style="min-height:52px">üìä Exportar CSV</button>
            </div>
          </div>
        </div>

      </div>

      <!-- MODAL: Crear Actividad -->
      <div class="modal-overlay" id="mCrearActividad">
        <div class="mv" style="max-width:460px">
          <div class="mh">üìÖ Nueva Actividad <span class="mx" onclick="closeM('mCrearActividad')">‚úï</span></div>
          <div class="mbody">
            <div class="fg">
              <div class="ff full"><label>Nombre de la actividad *</label><input type="text" id="actNombre" placeholder="Ej: Culto Dominical, C√©lula J√≥venes..."></div>
              <div class="ff"><label>Fecha *</label><input type="date" id="actFecha"></div>
              <div class="ff"><label>Hora</label><input type="time" id="actHora"></div>
              <div class="ff full"><label>Tipo</label>
                <select id="actTipo">
                  <option value="culto">‚õ™ Culto</option>
                  <option value="celula">üè† C√©lula</option>
                  <option value="jovenes">üéØ J√≥venes</option>
                  <option value="ninos">üë∂ Ni√±os</option>
                  <option value="capacitacion">üìö Capacitaci√≥n</option>
                  <option value="otro">üìã Otro</option>
                </select>
              </div>
            </div>
          </div>
          <div class="mf">
            <button class="btn btn-s" onclick="closeM('mCrearActividad')">Cancelar</button>
            <button class="btn btn-p" onclick="crearActividad()">‚úÖ Crear y pasar lista</button>
          </div>
        </div>
      </div>

      <!-- FINANZAS (incluye pr√©stamos como pesta√±a) -->
      <div id="vp-finanzas" class="vp">

        <!-- Cabecera limpia -->
        <div class="ph" style="flex-wrap:wrap;gap:10px">
          <div><div class="ph-t">üí∞ Finanzas</div><div class="ph-s">Entradas, gastos y pr√©stamos</div></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-xl btn-sm" onclick="if(!puedeExportar('finanzas')){toast('Sin permiso','error');return}exportFinCSV()">üìä Exportar</button>
          </div>
        </div>

        <!-- Tabs principales -->
        <div class="tabs" style="margin-bottom:20px">
          <div class="tab activo" id="ftab-entradas" onclick="finTab('entradas',this)">üíö Entradas</div>
          <div class="tab" id="ftab-gastos" onclick="finTab('gastos',this)">üî¥ Gastos</div>
          <div class="tab" id="ftab-prestamos" onclick="finTab('prestamos',this)">üí≥ Pr√©stamos</div>
          <div class="tab" id="ftab-resumen" onclick="finTab('resumen',this)">üìä Resumen</div>
        </div>

        <!-- ===== PESTA√ëA: ENTRADAS ===== -->
        <div id="fin-entradas">
          <!-- Tarjetas grandes por categor√≠a -->
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:24px">
            <div class="fin-cat-card" onclick="selTipoFin('diezmo')" id="fcat-diezmo" data-active="true" style="border-color:var(--do);background:rgba(212,175,55,.08)">
              <div class="fin-cat-ico">üìñ</div>
              <div class="fin-cat-lbl">Diezmo</div>
              <div class="fin-cat-num" id="fDi">$0</div>
            </div>
            <div class="fin-cat-card" onclick="selTipoFin('ofrenda')" id="fcat-ofrenda">
              <div class="fin-cat-ico">üôè</div>
              <div class="fin-cat-lbl">Ofrenda</div>
              <div class="fin-cat-num" id="fOf">$0</div>
            </div>
            <div class="fin-cat-card" onclick="selTipoFin('primicia')" id="fcat-primicia">
              <div class="fin-cat-ico">üåæ</div>
              <div class="fin-cat-lbl">Primicia</div>
              <div class="fin-cat-num" id="fPr">$0</div>
            </div>
            <div class="fin-cat-card" onclick="selTipoFin('donacion')" id="fcat-donacion">
              <div class="fin-cat-ico">üéÅ</div>
              <div class="fin-cat-lbl">Donaci√≥n</div>
              <div class="fin-cat-num" id="fDn">$0</div>
            </div>
            <div class="fin-cat-card" onclick="selTipoFin('otro')" id="fcat-otro">
              <div class="fin-cat-ico">üìã</div>
              <div class="fin-cat-lbl">Otro ingreso</div>
              <div class="fin-cat-num" id="fOt">$0</div>
            </div>
          </div>

          <!-- Total grande y visible -->
          <div style="background:linear-gradient(135deg,rgba(39,174,96,.12),rgba(39,174,96,.04));border:1px solid rgba(39,174,96,.3);border-radius:14px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;font-weight:700">Total Entradas</div>
              <div style="font-size:36px;font-weight:700;color:#27ae60;font-family:Cinzel,serif" id="fTo">$0.00</div>
            </div>
            <div style="text-align:right">
              <div style="font-size:11px;color:#555;text-transform:uppercase;letter-spacing:1px">Categor√≠a seleccionada</div>
              <div style="font-size:16px;font-weight:700;color:var(--do)" id="fCatSelLbl">üìñ Diezmo</div>
            </div>
          </div>

          <!-- Formulario de registro -->
          <div class="panel">
            <div class="ph2">‚ûï Registrar entrada ‚Äî <span id="fCatSelLbl2" style="color:var(--do)">Diezmo</span></div>
            <div class="pb">
              <div class="fg">
                <div class="ff"><label>Fecha *</label><input type="date" id="fFecha"></div>
                <div class="ff"><label>Miembro / Donante</label><select id="fMiem"><option value="">‚Äî An√≥nimo ‚Äî</option></select></div>
                <div class="ff"><label>Monto *</label>
                  <div style="position:relative">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#888;font-weight:700;font-size:15px">$</span>
                    <input type="number" id="fMonto" placeholder="0.00" step="0.01" min="0" style="padding-left:26px">
                  </div>
                </div>
                <div class="ff"><label>M√©todo de pago</label>
                  <select id="fMet">
                    <option value="efectivo">üíµ Efectivo</option>
                    <option value="transferencia">üè¶ Transferencia</option>
                    <option value="cheque">üìÑ Cheque</option>
                    <option value="tarjeta">üí≥ Tarjeta</option>
                  </select>
                </div>
                <div class="ff full"><label>Nota (opcional)</label><input type="text" id="fDesc" placeholder="Descripci√≥n adicional..."></div>
              </div>
              <!-- Campos extra para donaci√≥n -->
              <div id="donBox" style="display:none;margin-top:12px;background:rgba(212,175,55,.05);border:1px solid rgba(212,175,55,.15);border-radius:10px;padding:14px">
                <div class="fg">
                  <div class="ff"><label>Tipo de donaci√≥n</label><select id="donTipo" onchange="cambDon()"><option value="dinero">üíµ Dinero</option><option value="articulos">üì¶ Art√≠culos</option></select></div>
                  <div class="ff" id="artBox" style="display:none"><label>Descripci√≥n art√≠culos</label><textarea id="donArt" placeholder="Art√≠culos donados..."></textarea></div>
                </div>
              </div>
              <div class="bgrp" style="margin-top:16px">
                <button class="btn btn-e" style="padding:12px 28px;font-size:13px" onclick="guardarFin()">‚úÖ Guardar entrada</button>
                <button class="btn btn-s" onclick="limpiarFin()">üîÑ Limpiar</button>
              </div>
            </div>
          </div>

          <!-- Historial de entradas -->
          <div class="panel" style="margin-top:16px">
            <div class="ph2" style="justify-content:space-between">
              <span>üìã Historial de entradas</span>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                <select id="fFiltroTipo" onchange="renderFin()" style="padding:5px 10px;background:var(--gr);border:1px solid var(--gm);border-radius:7px;color:#ccc;font-size:11px">
                  <option value="">Todas las categor√≠as</option>
                  <option value="diezmo">üìñ Diezmo</option>
                  <option value="ofrenda">üôè Ofrenda</option>
                  <option value="primicia">üåæ Primicia</option>
                  <option value="donacion">üéÅ Donaci√≥n</option>
                  <option value="otro">üìã Otro</option>
                </select>
              </div>
            </div>
            <div id="listaFinEntradas" style="padding:14px"></div>
          </div>
        </div>

        <!-- ===== PESTA√ëA: GASTOS ===== -->
        <div id="fin-gastos" style="display:none">
          <!-- Total gastos -->
          <div style="background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(231,76,60,.03));border:1px solid rgba(231,76,60,.28);border-radius:14px;padding:20px 24px;margin-bottom:20px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
            <div>
              <div style="font-size:11px;color:#888;text-transform:uppercase;letter-spacing:1px;font-weight:700">Total Gastos</div>
              <div style="font-size:36px;font-weight:700;color:var(--pe);font-family:Cinzel,serif" id="fGa">$0.00</div>
            </div>
            <div>
              <div style="font-size:11px;color:#555;text-transform:uppercase;letter-spacing:1px">Balance neto</div>
              <div style="font-size:18px;font-weight:700" id="fBalance">$0.00</div>
            </div>
          </div>

          <div class="panel">
            <div class="ph2">üì§ Registrar gasto</div>
            <div class="pb">
              <div class="fg">
                <div class="ff"><label>Fecha *</label><input type="date" id="gFecha"></div>
                <div class="ff"><label>Categor√≠a</label>
                  <select id="gCategoria">
                    <option value="servicios">üîå Servicios (luz, agua, internet)</option>
                    <option value="mantenimiento">üîß Mantenimiento</option>
                    <option value="ministerio">üé§ Ministerio / Actividades</option>
                    <option value="alimentacion">üçΩÔ∏è Alimentaci√≥n</option>
                    <option value="transporte">üöó Transporte</option>
                    <option value="otro">üìã Otro</option>
                  </select>
                </div>
                <div class="ff"><label>Monto *</label>
                  <div style="position:relative">
                    <span style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#888;font-weight:700;font-size:15px">$</span>
                    <input type="number" id="gMonto" placeholder="0.00" step="0.01" min="0" style="padding-left:26px">
                  </div>
                </div>
                <div class="ff"><label>M√©todo</label>
                  <select id="gMet">
                    <option value="efectivo">üíµ Efectivo</option>
                    <option value="transferencia">üè¶ Transferencia</option>
                    <option value="cheque">üìÑ Cheque</option>
                    <option value="tarjeta">üí≥ Tarjeta</option>
                  </select>
                </div>
                <div class="ff full"><label>Descripci√≥n *</label><input type="text" id="gDesc" placeholder="¬øEn qu√© se us√≥ el dinero?"></div>
              </div>
              <div class="bgrp" style="margin-top:16px">
                <button class="btn btn-d" style="padding:12px 28px;font-size:13px" onclick="guardarGasto()">üì§ Registrar gasto</button>
                <button class="btn btn-s" onclick="limpiarGasto()">üîÑ Limpiar</button>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-top:16px">
            <div class="ph2">üìã Historial de gastos</div>
            <div id="listaFinGastos" style="padding:14px"></div>
          </div>
        </div>

        <!-- ===== PESTA√ëA: PR√âSTAMOS ===== -->
        <div id="fin-prestamos" style="display:none">
          <div style="display:flex;justify-content:flex-end;margin-bottom:16px">
            <button class="btn btn-p btn-sm" onclick="openM('mPrestamo');document.getElementById('preId').value='';document.getElementById('preFecha').valueAsDate=new Date()">‚ûï Nuevo pr√©stamo</button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px;margin-bottom:20px">
            <div class="sc az"><div class="sc-ico">üí≥</div><div class="sc-num" id="pTot">0</div><div class="sc-lbl">Total</div></div>
            <div class="sc na"><div class="sc-ico">‚è≥</div><div class="sc-num" id="pAct">0</div><div class="sc-lbl">Activos</div></div>
            <div class="sc ro"><div class="sc-ico">‚ö†Ô∏è</div><div class="sc-num" id="pVen">0</div><div class="sc-lbl">Vencidos</div></div>
            <div class="sc ve"><div class="sc-ico">‚úÖ</div><div class="sc-num" id="pPag">0</div><div class="sc-lbl">Pagados</div></div>
          </div>
          <div id="listaPres"></div>
        </div>

        <!-- ===== PESTA√ëA: RESUMEN ===== -->
        <div id="fin-resumen" style="display:none">
          <!-- Balance general -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px">
            <div style="background:linear-gradient(135deg,rgba(39,174,96,.12),rgba(39,174,96,.04));border:1px solid rgba(39,174,96,.3);border-radius:14px;padding:20px;text-align:center">
              <div style="font-size:13px;color:#888;margin-bottom:8px">üíö Total Entradas</div>
              <div style="font-size:32px;font-weight:700;color:#27ae60;font-family:Cinzel,serif" id="resTot">$0.00</div>
            </div>
            <div style="background:linear-gradient(135deg,rgba(231,76,60,.1),rgba(231,76,60,.03));border:1px solid rgba(231,76,60,.28);border-radius:14px;padding:20px;text-align:center">
              <div style="font-size:13px;color:#888;margin-bottom:8px">üî¥ Total Gastos</div>
              <div style="font-size:32px;font-weight:700;color:var(--pe);font-family:Cinzel,serif" id="resGas">$0.00</div>
            </div>
          </div>
          <div style="background:linear-gradient(135deg,rgba(212,175,55,.1),rgba(212,175,55,.03));border:2px solid rgba(212,175,55,.35);border-radius:14px;padding:22px;text-align:center;margin-bottom:20px">
            <div style="font-size:13px;color:#888;margin-bottom:8px">‚öñÔ∏è Balance Neto</div>
            <div style="font-size:42px;font-weight:700;font-family:Cinzel,serif" id="resBalance">$0.00</div>
          </div>
          <!-- Detalle por categor√≠a -->
          <div class="panel">
            <div class="ph2">üìä Detalle por categor√≠a</div>
            <div id="resDetalle" style="padding:14px"></div>
          </div>
        </div>

      </div>

      <!-- PR√âSTAMOS (redirige a finanzas) ‚Äî mantenemos el id para compatibilidad -->
      <div id="vp-prestamos" class="vp">
        <div style="text-align:center;padding:60px 20px">
          <div style="font-size:48px;margin-bottom:16px">üí≥</div>
          <div style="font-family:Cinzel,serif;color:var(--do);font-size:18px;margin-bottom:8px">Pr√©stamos</div>
          <div style="color:#666;font-size:13px;margin-bottom:20px">Los pr√©stamos ahora est√°n dentro del m√≥dulo de Finanzas</div>
          <button class="btn btn-p" onclick="go('finanzas');setTimeout(()=>finTab('prestamos',document.getElementById('ftab-prestamos')),100)">üí∞ Ir a Finanzas ‚Üí Pr√©stamos</button>
        </div>
      </div>

      <!-- REPORTES -->
      <div id="vp-reportes" class="vp">
        <div class="ph">
          <div><div class="ph-t">üìà Reportes y Estad√≠sticas</div><div class="ph-s">Visualiza, filtra y exporta en PDF o Excel</div></div>
        </div>

        <!-- Filtros -->
        <div class="panel"><div class="ph2">‚öôÔ∏è Filtros del Reporte</div><div class="pb">
          <div class="fg">
            <div class="ff"><label>Fecha Inicio</label><input type="date" id="rFI"></div>
            <div class="ff"><label>Fecha Fin</label><input type="date" id="rFF"></div>
            <div class="ff"><label>Ministerio</label>
              <select id="rMin">
                <option value="">Todos</option>
                <option value="alabanza">Alabanza</option>
                <option value="intercesion">Intercesi√≥n</option>
                <option value="ensenanza">Ense√±anza</option>
                <option value="evangelismo">Evangelismo</option>
                <option value="jovenes">J√≥venes</option>
                <option value="ninos">Ni√±os</option>
                <option value="damas">Damas</option>
                <option value="caballeros">Caballeros</option>
              </select>
            </div>
            <div class="ff"><label>Estado miembro</label>
              <select id="rEst"><option value="">Todos</option><option value="activo">Activo</option><option value="inactivo">Inactivo</option><option value="visita">Visita</option></select>
            </div>
          </div>
          <div class="bgrp">
            <button class="btn btn-p" onclick="genReporte()">üìä Generar Reporte</button>
          </div>
        </div></div>

        <!-- Resumen por categor√≠a -->
        <div class="sg" style="margin-bottom:14px">
          <div class="sc ve" style="cursor:pointer" onclick="filtrarReporte('siempre')">
            <div class="sc-ico">‚úÖ</div><div class="sc-num" id="rSi">0</div><div class="sc-lbl">Siempre asisten</div>
          </div>
          <div class="sc az" style="cursor:pointer" onclick="filtrarReporte('frecuente')">
            <div class="sc-ico">üìÖ</div><div class="sc-num" id="rFr">0</div><div class="sc-lbl">Frecuentes 70%+</div>
          </div>
          <div class="sc na" style="cursor:pointer" onclick="filtrarReporte('ocasional')">
            <div class="sc-ico">üîÑ</div><div class="sc-num" id="rOc">0</div><div class="sc-lbl">Ocasionales</div>
          </div>
          <div class="sc ro" style="cursor:pointer" onclick="filtrarReporte('casinunca')">
            <div class="sc-ico">‚ö†Ô∏è</div><div class="sc-num" id="rIn">0</div><div class="sc-lbl">Casi nunca</div>
          </div>
          <div class="sc pu" style="cursor:pointer" onclick="filtrarReporte('noasiste')">
            <div class="sc-ico">‚ùå</div><div class="sc-num" id="rNo">0</div><div class="sc-lbl">No asisten</div>
          </div>
        </div>

        <!-- Tabs de vista + botones de exportar -->
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px">
          <div class="rep-tabs" id="repTabs">
            <button class="rep-tab si on" onclick="filtrarReporte('siempre',this)">‚úÖ Siempre</button>
            <button class="rep-tab fr" onclick="filtrarReporte('frecuente',this)">üìÖ Frecuentes</button>
            <button class="rep-tab oc" onclick="filtrarReporte('ocasional',this)">üîÑ Ocasionales</button>
            <button class="rep-tab in2" onclick="filtrarReporte('casinunca',this)">‚ö†Ô∏è Casi nunca</button>
            <button class="rep-tab in2" onclick="filtrarReporte('noasiste',this)">‚ùå No asisten</button>
            <button class="rep-tab seg" onclick="filtrarReporte('seguimiento',this)">üìå Seguimiento</button>
            <button class="rep-tab" style="background:rgba(255,255,255,.05);color:#aaa;border-color:rgba(255,255,255,.1)" onclick="filtrarReporte('todos',this)">üìã Todos</button>
          </div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn btn-e btn-sm" onclick="exportarReporteActualPDF()">üìÑ PDF</button>
            <button class="btn btn-xl btn-sm" onclick="exportarReporteActualExcel()">üìä Excel</button>
          </div>
        </div>

        <!-- Lista de resultados -->
        <div id="listaSeg"><div class="empty"><div class="empty-ico">üìä</div><div class="empty-txt">Presiona "Generar Reporte" para ver resultados</div></div></div>
      </div>

      <!-- PUBLICIDAD -->
      <div id="vp-publicidad" class="vp">
        <div class="ph"><div><div class="ph-t">üì¢ Centro de Publicidad</div></div><div style="display:flex;gap:8px"><button class="btn btn-p btn-sm" onclick="openM('mAnuncio')">üé® Crear Anuncio</button><button class="btn btn-s btn-sm" onclick="openM('mAnunciosG')">üìÇ Guardados</button></div></div>
        <div class="sg">
          <div class="sc az"><div class="sc-ico">üìù</div><div class="sc-num" id="totAnu">0</div><div class="sc-lbl">Anuncios</div></div>
          <div class="sc do"><div class="sc-ico">üé®</div><div class="sc-num">6</div><div class="sc-lbl">Plantillas</div></div>
        </div>
        <div class="panel"><div class="ph2">üé® Plantillas</div><div class="pb"><div class="plt-g" id="pltContainer"></div></div></div>
      </div>

      <!-- COMUNICACI√ìN -->
      <div id="vp-comunicacion" class="vp">
        <div class="ph"><div><div class="ph-t">üìß Comunicaci√≥n</div><div class="ph-s">Env√≠a mensajes a tu congregaci√≥n</div></div></div>
        <div class="panel"><div class="ph2">‚úâÔ∏è Nuevo Mensaje</div><div class="pb">
          <div class="fg">
            <div class="ff"><label>T√≠tulo / Asunto</label><input type="text" id="comTit" placeholder="Asunto del mensaje"></div>
            <div class="ff"><label>Destinatarios</label><select id="comTipo"><option value="todos">Todos</option><option value="activos">Solo activos</option></select></div>
            <div class="ff full"><label>Mensaje</label><textarea id="comMsg" placeholder="Escriba su mensaje aqu√≠..." style="height:130px"></textarea></div>
          </div>
          <div class="alr alr-i">üí° WhatsApp: se abrir√° en el navegador. Email: se abrir√° su cliente de correo.</div>
          <div class="bgrp"><button class="btn btn-wa" onclick="envWA()">üì± WhatsApp</button><button class="btn btn-i" onclick="envEmail()">üìß Email</button><button class="btn btn-s" onclick="limpCom()">üîÑ Limpiar</button></div>
        </div></div>
        <div class="panel"><div class="ph2">üìã Plantillas R√°pidas</div><div class="pb">
          <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:11px">
            <div class="btn btn-s" style="text-align:left;display:block;padding:14px;cursor:pointer;height:auto" onclick="pltMsg('bienvenida')"><div style="font-size:18px;margin-bottom:7px">üéâ</div><div style="font-size:12px;font-weight:700;color:#fff">Bienvenida</div><div style="font-size:10px;color:#888;margin-top:3px">Para nuevos miembros</div></div>
            <div class="btn btn-s" style="text-align:left;display:block;padding:14px;cursor:pointer;height:auto" onclick="pltMsg('culto')"><div style="font-size:18px;margin-bottom:7px">‚õ™</div><div style="font-size:12px;font-weight:700;color:#fff">Recordatorio Culto</div><div style="font-size:10px;color:#888;margin-top:3px">Servicio dominical</div></div>
            <div class="btn btn-s" style="text-align:left;display:block;padding:14px;cursor:pointer;height:auto" onclick="pltMsg('cumple')"><div style="font-size:18px;margin-bottom:7px">üéÇ</div><div style="font-size:12px;font-weight:700;color:#fff">Feliz Cumplea√±os</div><div style="font-size:10px;color:#888;margin-top:3px">Saludo personalizado</div></div>
            <div class="btn btn-s" style="text-align:left;display:block;padding:14px;cursor:pointer;height:auto" onclick="pltMsg('oracion')"><div style="font-size:18px;margin-bottom:7px">üôè</div><div style="font-size:12px;font-weight:700;color:#fff">Cadena de Oraci√≥n</div><div style="font-size:10px;color:#888;margin-top:3px">Petici√≥n grupal</div></div>
          </div>
        </div></div>
      </div>

      <!-- ADMIN -->
      <div id="vp-admin" class="vp">
        <div class="ph"><div><div class="ph-t">‚öôÔ∏è Administraci√≥n</div></div></div>
        <div class="tabs"><div class="tab activo" onclick="tabAdm('usuarios',this)">üë§ Usuarios</div><div class="tab" onclick="tabAdm('backup',this)">üíæ Respaldos</div><div class="tab" onclick="tabAdm('config',this)">‚öôÔ∏è Config</div></div>
        <div id="admUsuarios">
          <div class="panel"><div class="ph2">‚ûï Crear / Editar Usuario</div><div class="pb">
            <input type="hidden" id="admId">
            <div class="fg">
              <div class="ff"><label>Nombre *</label><input type="text" id="admNom" placeholder="Nombre completo"></div>
              <div class="ff"><label>Usuario *</label><input type="text" id="admUsr" placeholder="Usuario de acceso"></div>
              <div class="ff"><label>Contrase√±a *</label><input type="password" id="admPw" placeholder="M√≠n. 8 chars, may√∫s, n√∫m, s√≠mbolo" oninput="mostrarIndicadorPw('admPw','pwIndicator')"><div id="pwIndicator"></div></div>
              <div class="ff"><label>Rol base</label>
                <select id="admRol" onchange="cargarPermisosPorRol()">
                  <option value="administrador">Administrador</option>
                  <option value="pastor">Pastor</option>
                  <option value="tesorero">Tesorero</option>
                  <option value="secretario">Secretario</option>
                  <option value="lider">L√≠der</option>
                  <option value="voluntario">Voluntario</option>
                </select>
              </div>
              <div class="ff"><label>Estado</label><select id="admEst"><option value="true">Activo</option><option value="false">Inactivo</option></select></div>
            </div>

            <!-- PERMISOS GRANULARES -->
            <div style="margin-top:16px;border:1px solid rgba(212,175,55,.2);border-radius:10px;overflow:hidden">
              <div style="background:rgba(212,175,55,.07);padding:10px 14px;display:flex;align-items:center;justify-content:space-between">
                <span style="font-family:Cinzel,serif;color:#d4af37;font-size:12px;letter-spacing:1px">üîê PERMISOS PERSONALIZADOS</span>
                <div style="display:flex;gap:6px">
                  <button class="btn btn-s btn-xs" onclick="cargarPermisosPorRol()">‚Ü∫ Restaurar por rol</button>
                  <button class="btn btn-e btn-xs" onclick="marcarTodosPermisos(true)">‚úÖ Todos</button>
                  <button class="btn btn-d btn-xs" onclick="marcarTodosPermisos(false)">‚ùå Ninguno</button>
                </div>
              </div>
              <div style="padding:14px">
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px" id="permisosGrid"></div>
              </div>
            </div>

            <div class="bgrp" style="margin-top:14px">
              <button class="btn btn-p" onclick="guardarUsr()">üíæ Guardar usuario</button>
              <button class="btn btn-s" onclick="limpiarUsr()">üîÑ Limpiar</button>
            </div>
          </div></div>

          <div class="panel"><div class="ph2">üë• Usuarios del Sistema</div>
            <div class="tc" style="margin-top:0;border:none;border-radius:0">
              <table><thead><tr><th>Nombre</th><th>Usuario</th><th>Rol</th><th>Estado</th><th>Permisos</th><th>Acciones</th></tr></thead>
              <tbody id="tbUsr"></tbody></table>
            </div>
          </div>
        </div>
        <div id="admBackup" style="display:none">

          <!-- Estado actual -->
          <div class="panel" style="margin-bottom:14px">
            <div class="ph2">üìç Ubicaci√≥n actual de la base de datos</div>
            <div class="pb">
              <div id="bdEstadoPanel" style="border-radius:9px;padding:12px 14px;background:rgba(39,174,96,.07);border:1px solid rgba(39,174,96,.25);margin-bottom:12px">
                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                  <span id="bdEstadoIcono" style="font-size:22px">üíæ</span>
                  <div style="flex:1">
                    <div style="font-weight:700;color:#fff;font-size:12px" id="bdEstadoNombre">Cargando...</div>
                    <div style="font-size:10px;color:#888;margin-top:2px;font-family:monospace" id="bdRutaTexto">‚Äî</div>
                    <div style="font-size:10px;color:#666;margin-top:2px" id="bdSyncEstado">Verificando sincronizaci√≥n...</div>
                  </div>
                  <button class="btn btn-i btn-xs" onclick="abrirCarpetaBD()">üìÅ Abrir carpeta</button>
                </div>
              </div>
              <div class="bgrp">
                <button class="btn btn-e" onclick="exportDB()">üíæ Exportar copia</button>
                <button class="btn btn-w" onclick="importDB()">üì• Importar copia</button>
                <button class="btn btn-d" onclick="limpiarTodo()">üóëÔ∏è Limpiar Todo</button>
              </div>
              <input type="file" id="impFile" style="display:none" accept=".json" onchange="procImport(event)">
            </div>
          </div>

          <!-- Selector de ubicaci√≥n -->
          <div class="panel" style="margin-bottom:14px">
            <div class="ph2">‚òÅÔ∏è Cambiar ubicaci√≥n ‚Äî Nube o Local</div>
            <div class="pb">
              <div style="margin-bottom:14px">
                <div style="font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:700">Servicios detectados en esta PC</div>
                <div id="nubeDetectada" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px">
                  <div style="color:#555;font-size:12px;padding:8px">Detectando servicios...</div>
                </div>
              </div>
              <div style="border-top:1px solid rgba(255,255,255,.05);padding-top:14px">
                <div style="font-size:10px;color:#666;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:700">O escribe la ruta manualmente</div>
                <div class="ff" style="margin-bottom:10px">
                  <input type="text" id="nuevaRutaBD" placeholder="Ej: C:\Users\Juan\Google Drive\Iglesia" style="font-family:monospace;font-size:12px">
                </div>
                <div style="font-size:11px;color:#555;margin-bottom:12px;line-height:1.8">
                  üü¢ <b style="color:#888">Google Drive:</b> C:\Users\TuNombre\Google Drive\SublimeGracia<br>
                  üîµ <b style="color:#888">OneDrive:</b> C:\Users\TuNombre\OneDrive\SublimeGracia<br>
                  üî¥ <b style="color:#888">MEGA:</b> C:\Users\TuNombre\MEGA\SublimeGracia<br>
                  üü¶ <b style="color:#888">Dropbox:</b> C:\Users\TuNombre\Dropbox\SublimeGracia
                </div>
                <button class="btn btn-p" onclick="cambiarRutaBD()">üíæ Aplicar nueva ruta</button>
              </div>
            </div>
          </div>

          <!-- Instrucciones multi-PC -->
          <div class="panel">
            <div class="ph2">üñ•Ô∏è C√≥mo usar en varias PCs</div>
            <div class="pb">
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(210px,1fr));gap:12px">
                <div style="background:rgba(39,174,96,.07);border:1px solid rgba(39,174,96,.15);border-radius:9px;padding:12px">
                  <div style="font-weight:700;color:#27ae60;margin-bottom:6px">‚ë† PC principal</div>
                  <div style="font-size:11px;color:#888;line-height:1.7">1. Instala Google Drive, OneDrive o MEGA<br>2. Cambia aqu√≠ la ruta a una carpeta dentro de ese servicio<br>3. El servicio sincroniza solo</div>
                </div>
                <div style="background:rgba(41,128,185,.07);border:1px solid rgba(41,128,185,.15);border-radius:9px;padding:12px">
                  <div style="font-weight:700;color:#2980b9;margin-bottom:6px">‚ë° Otras PCs</div>
                  <div style="font-size:11px;color:#888;line-height:1.7">1. Instala el sistema en cada PC<br>2. Instala el mismo servicio de nube<br>3. Apunta la ruta al mismo archivo sincronizado</div>
                </div>
                <div style="background:rgba(243,156,18,.07);border:1px solid rgba(243,156,18,.15);border-radius:9px;padding:12px">
                  <div style="font-weight:700;color:#f39c12;margin-bottom:6px">‚ö†Ô∏è Aviso importante</div>
                  <div style="font-size:11px;color:#888;line-height:1.7">No usar en 2 PCs exactamente al mismo tiempo. Guardar en una, esperar que sincronice el √≠cono de nube, luego abrir en la otra.</div>
                </div>
              </div>
            </div>
          </div>

        </div>
        <div id="admConfig" style="display:none">
          <div class="panel" style="margin-bottom:14px"><div class="ph2">‚öôÔ∏è Configuraci√≥n General</div><div class="pb">
            <div class="fg">
              <div class="ff full"><label>Nombre de la Iglesia</label><input type="text" id="cfgNom" value="Centro Cristiano Sublime Gracia de Dios"></div>
              <div class="ff"><label>Tel√©fono</label><input type="text" id="cfgTel" placeholder="000-000-0000"></div>
              <div class="ff"><label>Email</label><input type="email" id="cfgEmail" placeholder="iglesia@correo.com"></div>
              <div class="ff"><label>Direcci√≥n</label><input type="text" id="cfgDir" placeholder="Direcci√≥n"></div>
              <div class="ff"><label>Pastor Principal</label><input type="text" id="cfgPas" placeholder="Nombre del pastor"></div>
              <div class="ff"><label>Horario Principal</label><input type="text" id="cfgHor" placeholder="Domingos 10:00 AM"></div>
            </div>
            <div class="bgrp"><button class="btn btn-p" onclick="guardarCfg()">üíæ Guardar configuraci√≥n</button></div>
          </div></div>

          <!-- LOGO DE LA IGLESIA -->
          <div class="panel" style="margin-bottom:14px">
            <div class="ph2">üñºÔ∏è Logo de la Iglesia</div>
            <div class="pb">
              <div style="font-size:12px;color:#888;margin-bottom:18px">El logo aparecer√° en la pantalla de inicio de sesi√≥n y en la barra superior del sistema.</div>
              <div style="display:flex;align-items:center;gap:24px;flex-wrap:wrap">
                <!-- Vista previa login -->
                <div style="text-align:center">
                  <div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:700">Pantalla de Login</div>
                  <div style="width:74px;height:74px;background:linear-gradient(135deg,var(--do),var(--doo));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;overflow:hidden;margin:0 auto" id="prevLogoLogin">
                    <img id="prevLogoLoginImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%">
                    <span id="prevLogoLoginCross">‚úù</span>
                  </div>
                </div>
                <!-- Vista previa header -->
                <div style="text-align:center">
                  <div style="font-size:10px;color:#888;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:700">Barra Superior</div>
                  <div style="width:44px;height:44px;background:linear-gradient(135deg,var(--do),var(--doo));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:19px;overflow:hidden;margin:0 auto" id="prevLogoHdr">
                    <img id="prevLogoHdrImg" src="" style="display:none;width:100%;height:100%;object-fit:cover;border-radius:50%">
                    <span id="prevLogoHdrCross">‚úù</span>
                  </div>
                </div>
                <!-- Controles -->
                <div style="flex:1;min-width:200px">
                  <div class="ff" style="margin-bottom:12px">
                    <label>Subir imagen de logo</label>
                    <input type="file" id="cfgLogoFile" accept="image/png,image/jpeg,image/gif,image/webp,image/svg+xml" 
                      style="background:var(--gr);border:1px solid var(--gm);border-radius:9px;padding:9px;width:100%;color:#ccc;font-size:12px"
                      onchange="previsualizarLogo(event)">
                    <div style="font-size:10px;color:#666;margin-top:4px">PNG, JPG, GIF o SVG ¬∑ Recomendado: fondo transparente</div>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <button class="btn btn-p" onclick="guardarLogo()">üíæ Guardar Logo</button>
                    <button class="btn btn-d btn-sm" onclick="eliminarLogo()">üóëÔ∏è Quitar Logo</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- POL√çTICA DE CONTRASE√ëA PERSONALIZABLE -->
          <div class="panel">
            <div class="ph2">üîí Pol√≠tica de Contrase√±as</div>
            <div class="pb">
              <div style="font-size:11px;color:#666;margin-bottom:14px">Configura qu√© requisitos deben cumplir las contrase√±as de los usuarios del sistema.</div>

              <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;border:1px solid rgba(255,255,255,.07);border-radius:10px;overflow:hidden;margin-bottom:16px">
                <!-- Longitud m√≠nima -->
                <div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.05);border-right:1px solid rgba(255,255,255,.05)">
                  <div style="font-size:10px;color:#888;font-weight:700;text-transform:uppercase;margin-bottom:8px">üìè Longitud m√≠nima</div>
                  <div style="display:flex;align-items:center;gap:10px">
                    <input type="range" id="pwMinLen" min="4" max="20" value="8" oninput="document.getElementById('pwMinLenVal').textContent=this.value;previewPolicy()" style="flex:1;accent-color:#d4af37">
                    <span id="pwMinLenVal" style="font-size:18px;font-weight:700;color:#d4af37;min-width:25px">8</span>
                    <span style="font-size:10px;color:#666">chars</span>
                  </div>
                </div>
                <!-- Longitud m√°xima -->
                <div style="padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.05)">
                  <div style="font-size:10px;color:#888;font-weight:700;text-transform:uppercase;margin-bottom:8px">üìê Longitud m√°xima</div>
                  <div style="display:flex;align-items:center;gap:10px">
                    <input type="range" id="pwMaxLen" min="8" max="64" value="32" oninput="document.getElementById('pwMaxLenVal').textContent=this.value;previewPolicy()" style="flex:1;accent-color:#d4af37">
                    <span id="pwMaxLenVal" style="font-size:18px;font-weight:700;color:#d4af37;min-width:25px">32</span>
                    <span style="font-size:10px;color:#666">chars</span>
                  </div>
                </div>
              </div>

              <!-- Requisitos de caracteres -->
              <div style="border:1px solid rgba(255,255,255,.07);border-radius:10px;overflow:hidden;margin-bottom:16px">
                <div style="padding:8px 14px;background:rgba(212,175,55,.05);font-size:10px;color:#d4af37;font-weight:700;text-transform:uppercase;letter-spacing:1px">Requisitos de caracteres</div>
                <div style="padding:4px 14px">
                  <div class="pw-req">
                    <span class="pw-req-ico">üî†</span>
                    <span class="pw-req-lbl">May√∫sculas (A-Z)</span>
                    <div class="pw-toggle"><input type="checkbox" id="pwReqUpper" checked onchange="previewPolicy()"><label for="pwReqUpper">Requerido</label></div>
                  </div>
                  <div class="pw-req">
                    <span class="pw-req-ico">üî°</span>
                    <span class="pw-req-lbl">Min√∫sculas (a-z)</span>
                    <div class="pw-toggle"><input type="checkbox" id="pwReqLower" checked onchange="previewPolicy()"><label for="pwReqLower">Requerido</label></div>
                  </div>
                  <div class="pw-req">
                    <span class="pw-req-ico">üî¢</span>
                    <span class="pw-req-lbl">N√∫meros (0-9)</span>
                    <div class="pw-toggle"><input type="checkbox" id="pwReqNum" checked onchange="previewPolicy()"><label for="pwReqNum">Requerido</label></div>
                  </div>
                  <div class="pw-req">
                    <span class="pw-req-ico">üî£</span>
                    <span class="pw-req-lbl">S√≠mbolos (!@#$%...)</span>
                    <div class="pw-toggle"><input type="checkbox" id="pwReqSym" onchange="previewPolicy()"><label for="pwReqSym">Requerido</label></div>
                  </div>
                  <div class="pw-req">
                    <span class="pw-req-ico">üö´</span>
                    <span class="pw-req-lbl">No permitir espacios</span>
                    <div class="pw-toggle"><input type="checkbox" id="pwNoSpaces" checked onchange="previewPolicy()"><label for="pwNoSpaces">Activado</label></div>
                  </div>
                  <div class="pw-req">
                    <span class="pw-req-ico">üîÅ</span>
                    <span class="pw-req-lbl">No repetir 3 chars iguales seguidos</span>
                    <div class="pw-toggle"><input type="checkbox" id="pwNoRepeat" onchange="previewPolicy()"><label for="pwNoRepeat">Activado</label></div>
                  </div>
                </div>
              </div>

              <!-- Intentos antes de bloqueo -->
              <div style="border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:12px 14px;margin-bottom:16px">
                <div style="font-size:10px;color:#888;font-weight:700;text-transform:uppercase;margin-bottom:10px">üîê Seguridad de acceso</div>
                <div style="display:flex;gap:16px;flex-wrap:wrap">
                  <div style="flex:1;min-width:150px">
                    <label style="font-size:11px;color:#aaa;display:block;margin-bottom:5px">Intentos antes de bloqueo</label>
                    <div style="display:flex;align-items:center;gap:8px">
                      <input type="range" id="pwMaxIntentos" min="2" max="10" value="5" oninput="document.getElementById('pwMaxIntentosVal').textContent=this.value" style="flex:1;accent-color:#d4af37">
                      <span id="pwMaxIntentosVal" style="font-size:16px;font-weight:700;color:#d4af37">5</span>
                    </div>
                  </div>
                  <div style="flex:1;min-width:150px">
                    <label style="font-size:11px;color:#aaa;display:block;margin-bottom:5px">Minutos de bloqueo</label>
                    <div style="display:flex;align-items:center;gap:8px">
                      <input type="range" id="pwMinBloqueo" min="1" max="60" value="5" oninput="document.getElementById('pwMinBloqueoVal').textContent=this.value" style="flex:1;accent-color:#d4af37">
                      <span id="pwMinBloqueoVal" style="font-size:16px;font-weight:700;color:#d4af37">5</span>
                      <span style="font-size:10px;color:#666">min</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Preview en vivo -->
              <div id="pwPolicyPreview" style="background:rgba(212,175,55,.05);border:1px solid rgba(212,175,55,.15);border-radius:9px;padding:12px 14px;margin-bottom:14px">
                <div style="font-size:10px;color:#d4af37;font-weight:700;margin-bottom:6px">üëÅÔ∏è Vista previa de los requisitos activos</div>
                <div id="pwPolicyList" style="font-size:11px;color:#888;line-height:1.8"></div>
              </div>

              <div class="bgrp">
                <button class="btn btn-p" onclick="guardarPoliticaPw()">üîí Guardar pol√≠tica</button>
                <button class="btn btn-s" onclick="cargarPoliticaPw()">‚Ü∫ Restaurar</button>
              </div>
            </div>
          </div>
        </div>
      </div>


        <!-- AUDITOR√çA -->
        <div id="vp-auditoria" class="vp">
          <div class="ph"><div><div class="ph-t">üîç Auditor√≠a del Sistema</div><div class="ph-s">Registro de todas las acciones realizadas</div></div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <select id="audFiltroUser" onchange="renderAudit()" style="padding:6px 10px;background:#323232;border:1px solid #444;border-radius:8px;color:#fff;font-size:11px">
                <option value="">Todos los usuarios</option>
              </select>
              <select id="audFiltroAcc" onchange="renderAudit()" style="padding:6px 10px;background:#323232;border:1px solid #444;border-radius:8px;color:#fff;font-size:11px">
                <option value="">Todas las acciones</option>
                <option value="LOGIN">Login</option>
                <option value="LOGOUT">Logout</option>
                <option value="CREATE">Crear</option>
                <option value="UPDATE">Actualizar</option>
                <option value="DELETE">Eliminar</option>
                <option value="EXPORT">Exportar</option>
                <option value="IMPORT">Importar</option>
                <option value="CONFIG">Configuracion</option>
                <option value="FAIL_LOGIN">Login fallido</option>
              </select>
              <button class="btn btn-d btn-sm" onclick="limpiarAudit()">üóëÔ∏è Limpiar log</button>
              <button class="btn btn-xl btn-sm" onclick="exportAuditPDF()">üìÑ Exportar PDF</button>
            </div>
          </div>
          <div class="panel">
            <div class="tc"><table>
              <thead><tr><th>Fecha / Hora</th><th>Usuario</th><th>Rol</th><th>Accion</th><th>Detalle</th></tr></thead>
              <tbody id="tbAudit"></tbody>
            </table></div>
          </div>
        </div>
    </div><!-- fin contenido -->
  </div><!-- fin app-body -->
</div><!-- fin mainApp -->

<!-- MODALES -->
<div id="mEvento" class="modal-overlay">
  <div class="mv"><div class="mh">üìÖ Evento<button class="mx" onclick="closeM('mEvento')">√ó</button></div>
  <div class="mbody">
    <input type="hidden" id="evId">
    <div class="fg">
      <div class="ff full"><label>T√≠tulo *</label><input type="text" id="evTit" placeholder="Nombre del evento"></div>
      <div class="ff"><label>Fecha *</label><input type="date" id="evFecha"></div>
      <div class="ff"><label>Hora</label><input type="time" id="evHora"></div>
      <div class="ff"><label>Tipo</label><select id="evTipo"><option value="culto">Culto Dominical</option><option value="estudio">Estudio B√≠blico</option><option value="jovenes">J√≥venes</option><option value="ninos">Ni√±os</option><option value="especial">Evento Especial</option><option value="otro">Otro</option></select></div>
      <div class="ff"><label>Lugar</label><input type="text" id="evLugar" placeholder="Ubicaci√≥n"></div>
      <div class="ff full"><label>Descripci√≥n</label><textarea id="evDesc" placeholder="Descripci√≥n..."></textarea></div>
    </div>
  </div>
  <div class="mf"><button class="btn btn-s" onclick="closeM('mEvento')">Cancelar</button><button class="btn btn-p" onclick="guardarEv()">üíæ Guardar</button></div>
  </div>
</div>

<div id="mVisita" class="modal-overlay">
  <div class="mv"><div class="mh">üëÅÔ∏è Registrar Visita<button class="mx" onclick="closeM('mVisita')">√ó</button></div>
  <div class="mbody">
    <input type="hidden" id="visId">
    <div class="fg">
      <div class="ff"><label>Nombre *</label><input type="text" id="visNom" placeholder="Nombre y apellido"></div>
      <div class="ff"><label>Tel√©fono</label><input type="tel" id="visTel" placeholder="000-000-0000"></div>
      <div class="ff"><label>Email</label><input type="email" id="visEmail" placeholder="correo@ejemplo.com"></div>
      <div class="ff"><label>Fecha de Visita</label><input type="date" id="visFecha"></div>
      <div class="ff"><label>¬øC√≥mo lleg√≥?</label><select id="visLleg"><option value="invitado">Fue invitado</option><option value="redes">Redes sociales</option><option value="caminando">Pasando cerca</option><option value="familiar">Familiar de miembro</option><option value="otro">Otro</option></select></div>
      <div class="ff"><label>Estado</label><select id="visEst"><option value="visita-nueva">Visita Nueva</option><option value="visitante-habitual">Visitante Habitual</option><option value="convertido">Convertido</option></select></div>
      <div class="ff full"><label>Notas / Seguimiento</label><textarea id="visNotas" placeholder="Notas de seguimiento..."></textarea></div>
    </div>
  </div>
  <div class="mf"><button class="btn btn-s" onclick="closeM('mVisita')">Cancelar</button><button class="btn btn-p" onclick="guardarVis()">üíæ Guardar</button></div>
  </div>
</div>

<div id="mCelula" class="modal-overlay">
  <div class="mv"><div class="mh">üè† C√©lula / Grupo<button class="mx" onclick="closeM('mCelula')">√ó</button></div>
  <div class="mbody">
    <input type="hidden" id="celId">
    <div class="fg">
      <div class="ff full"><label>Nombre *</label><input type="text" id="celNom" placeholder="Ej: C√©lula Norte"></div>
      <div class="ff"><label>L√≠der *</label><select id="celLid"><option value="">-- Seleccione --</option></select></div>
      <div class="ff"><label>D√≠a</label><select id="celDia"><option value="lunes">Lunes</option><option value="martes">Martes</option><option value="miercoles">Mi√©rcoles</option><option value="jueves">Jueves</option><option value="viernes">Viernes</option><option value="sabado">S√°bado</option><option value="domingo">Domingo</option></select></div>
      <div class="ff"><label>Hora</label><input type="time" id="celHora"></div>
      <div class="ff full"><label>Lugar</label><input type="text" id="celLugar" placeholder="Direcci√≥n de reuni√≥n"></div>
      <div class="ff full"><label>Descripci√≥n</label><textarea id="celDesc" placeholder="Descripci√≥n..."></textarea></div>
    </div>
  </div>
  <div class="mf"><button class="btn btn-s" onclick="closeM('mCelula')">Cancelar</button><button class="btn btn-p" onclick="guardarCel()">üíæ Guardar</button></div>
  </div>
</div>

<div id="mOracion" class="modal-overlay">
  <div class="mv"><div class="mh">üôè Petici√≥n de Oraci√≥n<button class="mx" onclick="closeM('mOracion')">√ó</button></div>
  <div class="mbody">
    <input type="hidden" id="orId">
    <div class="fg">
      <div class="ff"><label>Solicitante</label><select id="orMiem"><option value="">-- An√≥nimo --</option></select></div>
      <div class="ff"><label>Urgencia</label><select id="orUrg"><option value="normal">Normal</option><option value="urgente">Urgente</option><option value="confidencial">Confidencial</option></select></div>
      <div class="ff full"><label>T√≠tulo / Motivo *</label><input type="text" id="orTit" placeholder="T√≠tulo de la petici√≥n"></div>
      <div class="ff full"><label>Descripci√≥n</label><textarea id="orTxt" placeholder="Descripci√≥n..." style="height:110px"></textarea></div>
      <div class="ff"><label>Estado</label><select id="orEst"><option value="activa">Activa</option><option value="respondida">Respondida</option></select></div>
    </div>
  </div>
  <div class="mf"><button class="btn btn-s" onclick="closeM('mOracion')">Cancelar</button><button class="btn btn-p" onclick="guardarOra()">üôè Guardar</button></div>
  </div>
</div>

<div id="mPrestamo" class="modal-overlay">
  <div class="mv"><div class="mh">üí≥ Registrar Pr√©stamo<button class="mx" onclick="closeM('mPrestamo')">√ó</button></div>
  <div class="mbody">
    <input type="hidden" id="preId">
    <div class="fg">
      <div class="ff"><label>Miembro *</label><select id="preMiem"><option value="">-- Seleccione --</option></select></div>
      <div class="ff"><label>Monto *</label><input type="number" id="preMonto" placeholder="0.00" step="0.01" min="0"></div>
      <div class="ff"><label>Fecha Otorgado</label><input type="date" id="preFecha"></div>
      <div class="ff"><label>Fecha Vencimiento</label><input type="date" id="preVenc"></div>
      <div class="ff full"><label>Motivo</label><textarea id="preMot" placeholder="Motivo del pr√©stamo..."></textarea></div>
    </div>
  </div>
  <div class="mf"><button class="btn btn-s" onclick="closeM('mPrestamo')">Cancelar</button><button class="btn btn-p" onclick="guardarPre()">üíæ Guardar</button></div>
  </div>
</div>

<div id="mAnuncio" class="modal-overlay">
  <div class="mv" style="max-width:920px">
    <div class="mh">üé® Crear Anuncio<button class="mx" onclick="closeM('mAnuncio')">√ó</button></div>
    <div class="mbody">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div class="panel" style="margin-bottom:13px"><div class="ph2">üìÖ D√≠a</div><div class="pb"><div class="dsg" id="diasCont"></div></div></div>
          <div class="panel" style="margin-bottom:13px"><div class="ph2">üé® Color</div><div class="pb"><div class="clg" id="colorCont"></div><div class="ff"><label>Color Personalizado</label><input type="color" id="colPers" value="#1e3c72" onchange="colPers2()"></div></div></div>
          <div class="panel"><div class="ph2">üìù Contenido</div><div class="pb">
            <div class="ff" style="margin-bottom:9px"><label>Plantilla</label><select id="pltBase" onchange="cargarPlt()"><option value="">-- Seleccionar --</option><option value="domingo-culto">Domingo de Culto</option><option value="discipulado">Discipulado</option><option value="bible-study">Bible Study</option><option value="adoracion">Adoraci√≥n</option><option value="evento-dorado">Evento Especial</option><option value="jovenes">J√≥venes</option></select></div>
            <div class="ff" style="margin-bottom:9px"><label>T√≠tulo *</label><input type="text" id="anTit" placeholder="T√≠tulo principal" oninput="updPrev()"></div>
            <div class="ff" style="margin-bottom:9px"><label>Subt√≠tulo</label><input type="text" id="anSub" placeholder="Subt√≠tulo" oninput="updPrev()"></div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:9px">
              <div class="ff"><label>Fecha</label><input type="date" id="anFecha" onchange="updPrev()"></div>
              <div class="ff"><label>Hora</label><input type="time" id="anHora" onchange="updPrev()"></div>
            </div>
            <div class="ff" style="margin-bottom:9px"><label>Lugar</label><input type="text" id="anLugar" placeholder="Ubicaci√≥n" oninput="updPrev()"></div>
            <div class="ff" style="margin-bottom:9px"><label>Horarios</label><input type="text" id="anHors" placeholder="8:30 AM, 10:30 AM" oninput="updPrev()"></div>
            <div class="ff" style="margin-bottom:9px"><label>Vers√≠culo</label><input type="text" id="anVers" placeholder="Texto b√≠blico" oninput="updPrev()"></div>
            <div class="ff" style="margin-bottom:9px"><label>Referencia</label><input type="text" id="anRef" placeholder="Juan 3:16" oninput="updPrev()"></div>
            <div class="ff"><label>Contacto</label><input type="text" id="anCont" placeholder="Tel/email" oninput="updPrev()"></div>
          </div></div>
        </div>
        <div>
          <div class="panel" style="margin-bottom:13px">
            <div class="ph2">üëÅÔ∏è Vista Previa</div>
            <div class="pb"><div class="pvbox"><canvas id="pvCanvas" width="580" height="435" style="max-width:100%;height:auto;border-radius:7px"></canvas></div>
            <div class="bgrp" style="justify-content:center;margin-top:9px">
              <button class="btn btn-e btn-sm" onclick="expJPG()">üì∑ JPG</button>
              <button class="btn btn-i btn-sm" onclick="expPNG()">üñºÔ∏è PNG</button>
              <button class="btn btn-p btn-sm" onclick="guardarAnu()">üíæ Guardar</button>
            </div></div>
          </div>
          <div class="panel"><div class="ph2">‚öôÔ∏è Dise√±o</div><div class="pb">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:9px">
              <div class="ff"><label>Fuente</label><select id="anFuente" onchange="updPrev()"><option value="Georgia">Georgia</option><option value="Impact">Impact</option><option value="Arial">Arial</option><option value="Times New Roman">Times New Roman</option></select></div>
              <div class="ff"><label>Alineaci√≥n</label><select id="anAlin" onchange="updPrev()"><option value="center">Centro</option><option value="left">Izquierda</option><option value="right">Derecha</option></select></div>
              <div class="ff"><label>Color T√≠tulo</label><input type="color" id="anColT" value="#ffffff" onchange="updPrev()"></div>
              <div class="ff"><label>Color Texto</label><input type="color" id="anColX" value="#ffffff" onchange="updPrev()"></div>
            </div>
            <div class="ff" style="margin-bottom:9px"><label>Imagen de Fondo</label><input type="file" id="anImgFondo" accept="image/*" style="background:var(--gr);border:1px solid var(--gm);border-radius:9px;padding:7px;width:100%;color:#ccc;font-size:11px" onchange="cargarImgFondo(event)"></div>
            <div class="ff"><label>Logo (opcional)</label><input type="file" id="anLogo" accept="image/*" style="background:var(--gr);border:1px solid var(--gm);border-radius:9px;padding:7px;width:100%;color:#ccc;font-size:11px" onchange="cargarLogo(event)"></div>
          </div></div>
        </div>
      </div>
    </div>
    <div class="mf"><button class="btn btn-s" onclick="closeM('mAnuncio')">Cerrar</button></div>
  </div>
</div>

<div id="mAnunciosG" class="modal-overlay">
  <div class="mv"><div class="mh">üìÇ Anuncios Guardados<button class="mx" onclick="closeM('mAnunciosG')">√ó</button></div>
  <div class="mbody"><div id="listaAnuG" style="max-height:480px;overflow-y:auto"></div></div>
  <div class="mf"><button class="btn btn-s" onclick="closeM('mAnunciosG')">Cerrar</button></div>
  </div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  window._firebaseReady = false;
  window._firebaseDB = null;

  // ============================================================
  // üîß CONFIGURACI√ìN FIREBASE ‚Äî Cambia estos valores con los tuyos
  // ============================================================
  const firebaseConfig = {
   apiKey: "AIzaSyDGoyDRmFMYDbbWg4d23d1FiKWTv6M1tgg",
  authDomain: "sublime-gracia-dccaa.firebaseapp.com",
  databaseURL: "https://sublime-gracia-dccaa-default-rtdb.firebaseio.com",
  projectId: "sublime-gracia-dccaa",
  storageBucket: "sublime-gracia-dccaa.firebasestorage.app",
  messagingSenderId: "444975265918",
  appId: "1:444975265918:web:92b53fb28e41f5c0c6002f"
  };
  // ============================================================

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  window._firebaseDB = db;
  window._firebaseRef = ref;
  window._firebaseSet = set;
  window._firebaseGet = get;
  window._firebaseReady = true;
  console.log('‚úÖ Firebase conectado correctamente');
</script>

<script>
// ===== BASE DE DATOS - Firebase Realtime Database =====
let _db = {};

async function _dbLoad(){
  try {
    if(!window._firebaseReady || !window._firebaseDB){
      // Esperar hasta que Firebase est√© listo (m√°x 5 seg)
      await new Promise((resolve,reject)=>{
        let t=0;
        const iv=setInterval(()=>{
          t+=100;
          if(window._firebaseReady){clearInterval(iv);resolve();}
          if(t>5000){clearInterval(iv);reject(new Error('Firebase no disponible'));}
        },100);
      });
    }
    const snap = await window._firebaseGet(window._firebaseRef(window._firebaseDB,'sublime_gracia'));
    if(snap.exists()) _db = snap.val();
    else _db = {};
  } catch(e){ _db={}; console.error('Error cargando BD Firebase:',e); }
}
async function _dbSave(){
  try {
    if(!window._firebaseReady || !window._firebaseDB) return;
    await window._firebaseSet(window._firebaseRef(window._firebaseDB,'sublime_gracia'), _db);
  } catch(e){ console.error('Error guardando BD Firebase:',e); }
}
function _pk(s){ return s==='asistencia'?'fecha':s==='configuracion'?'clave':'id'; }

async function initDB(){
  await _dbLoad();
}
async function dbP(s,d){
  if(!_db[s]) _db[s]=[];
  const k=_pk(s), idx=_db[s].findIndex(x=>x[k]===d[k]);
  if(idx>=0) _db[s][idx]=d; else _db[s].push(d);
  await _dbSave(); return d[k];
}
async function dbG(s,k){
  return (_db[s]||[]).find(x=>x[_pk(s)]===k)||null;
}
async function dbA(s){
  return JSON.parse(JSON.stringify(_db[s]||[]));
}
async function dbD(s,k){
  if(_db[s]) _db[s]=_db[s].filter(x=>x[_pk(s)]!==k);
  await _dbSave();
}

// ===== GLOBALS =====
let usuarios=[],miembros=[],finanzas=[],ninos=[],anuncios=[],eventos=[],visitas=[],celulas=[],oraciones=[],prestamos=[],asistData={},config={};
let usrActual=null,tipoFin='diezmo',diaPub='domingo',colorPub=['#1e3c72','#2a5298'],logoD=null,imgFondoD=null,calF=new Date(),filtroOra='todas';

const MINS={ninguno:'Ninguno',alabanza:'Alabanza',intercesion:'Intercesi√≥n',ensenanza:'Ense√±anza',evangelismo:'Evangelismo',jovenes:'J√≥venes',ninos:'Ni√±os',damas:'Damas',caballeros:'Caballeros',mantenimiento:'Mantenimiento',pastora:'Pastora',pastores:'Pastores',musicos:'M√∫sicos',danzarinas:'Danzarinas','profesoras-eb':'Profesoras EB',servicios:'Servicios',multimedia:'Multimedia',otros:'Otros'};
const TIPO_LBL={diezmo:'üìñ Diezmo',ofrenda:'üôè Ofrenda',primicia:'üåæ Primicia',donacion:'üéÅ Donaci√≥n',gasto:'üì§ Gasto',otro:'üìã Otro'};
const COLORES=[['#1e3c72','#2a5298'],['#cb2d3e','#ef473a'],['#0f0f0f','#2c2c2c'],['#11998e','#38ef7d'],['#d4af37','#f4d03f'],['#667eea','#764ba2'],['#f12711','#f5af19'],['#232526','#414345']];
const DIAS=[{id:'lunes',n:'Lun'},{id:'martes',n:'Mar'},{id:'miercoles',n:'Mi√©'},{id:'jueves',n:'Jue'},{id:'viernes',n:'Vie'},{id:'sabado',n:'S√°b'},{id:'domingo',n:'Dom'}];
const PLTS=[{id:'domingo-culto',n:'Domingo',c:['#cb2d3e','#ef473a']},{id:'discipulado',n:'Discipulado',c:['#0f0f0f','#2c2c2c']},{id:'bible-study',n:'Bible Study',c:['#0f0f0f','#d4af37']},{id:'adoracion',n:'Adoraci√≥n',c:['#1e3c72','#667eea']},{id:'evento-dorado',n:'Evento Especial',c:['#d4af37','#f4d03f']},{id:'jovenes',n:'J√≥venes',c:['#f12711','#f5af19']}];

// ===== TOAST =====
function toast(msg,tipo='ok'){const t=document.createElement('div');t.className='toast'+(tipo==='error'?' error':tipo==='warning'?' warning':tipo==='info'?' info':'');t.innerHTML=`<span>${{ok:'‚úÖ',error:'‚ùå',warning:'‚ö†Ô∏è',info:'‚ÑπÔ∏è'}[tipo]||'‚úÖ'}</span><span>${msg}</span><button class="txb" onclick="this.parentElement.remove()">√ó</button>`;document.getElementById('toastC').appendChild(t);setTimeout(()=>t.remove(),4000)}

// ===== INIT =====
document.addEventListener('DOMContentLoaded',async()=>{
  try{
    await initDB();
    await cargarDatos();
    poblarSelUsr();
    cargarRutaBD();
    document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('activo')})});
  }
  catch(e){console.error(e);alert('Error al inicializar: '+e.message)}
});
async function cargarDatos(){
  await cargarAudit();
  const u=await dbA('usuarios');
  if(u.length)usuarios=u;
  else{usuarios=[{id:'admin_001',nombre:'Administrador',usuario:'admin',clave:'12345',rol:'administrador',activo:true},{id:'pastor_001',nombre:'Pastor Principal',usuario:'pastor',clave:'12345',rol:'pastor',activo:true},{id:'tesorero_001',nombre:'Tesorero',usuario:'tesorero',clave:'12345',rol:'tesorero',activo:true},{id:'secretario_001',nombre:'Secretario',usuario:'secretario',clave:'12345',rol:'secretario',activo:true}];for(let u of usuarios)await dbP('usuarios',u)}
  miembros=await dbA('miembros');finanzas=await dbA('finanzas');ninos=await dbA('ninos');anuncios=await dbA('anuncios');eventos=await dbA('eventos');visitas=await dbA('visitas');celulas=await dbA('celulas');oraciones=await dbA('oraciones');prestamos=await dbA('prestamos');
  (await dbA('asistencia')).forEach(a=>asistData[a.fecha]=a.datos);
  if(!_db.actividades) _db.actividades={};
  const c=await dbG('configuracion','general');if(c)config=c;
  await cargarLogoGuardado();
}

// ===== AUTH =====
function poblarSelUsr(){const s=document.getElementById('selUsr');s.innerHTML='<option value="">-- Seleccione --</option>';usuarios.filter(u=>u.activo).forEach(u=>{const o=document.createElement('option');o.value=u.usuario;o.textContent=u.nombre+' ('+u.rol+')';s.appendChild(o)})}
function selUsr2(){document.getElementById('usrInput').value=document.getElementById('selUsr').value;document.getElementById('pwInput').value='';document.getElementById('pwInput').focus()}
// intentos fallidos por usuario
const _loginIntentos = {};

function login(){
  const u=document.getElementById('usrInput').value.trim(),p=document.getElementById('pwInput').value.trim();
  if(!u||!p){toast('Ingrese usuario y contrase√±a','error');return}

  // Bloqueo temporal tras 5 intentos fallidos
  const ahora = Date.now();
  if(_loginIntentos[u] && _loginIntentos[u].bloqueadoHasta > ahora){
    const seg = Math.ceil((_loginIntentos[u].bloqueadoHasta - ahora)/1000);
    toast('Cuenta bloqueada temporalmente. Intente en '+seg+' segundos.','error');
    return;
  }

  // Verificar si usuario existe pero est√° inactivo
  const usrExiste = usuarios.find(x=>x.usuario===u);
  const usr = usuarios.find(x=>x.usuario===u && x.clave===p && x.activo);

  if(usr){
    // Login exitoso ‚Äî resetear intentos
    _loginIntentos[u] = {count:0, bloqueadoHasta:0};
    usrActual = usr;
    document.getElementById('loginBox').style.display='none';
    document.getElementById('mainApp').style.display='flex';
    document.getElementById('nomUsr').textContent = usr.nombre;
    const rb = document.getElementById('rolUsr');
    rb.textContent = usr.rol;
    rb.className = 'ur badge b'+usr.rol.substring(0,3);
    // Aplicar permisos personalizados o por rol
    aplicarRol(usr.rol, usr.permisos);
    go('dashboard');
    checkCumples();
    logAudit('LOGIN','Inicio de sesi√≥n exitoso');
  } else {
    // Login fallido
    if(!_loginIntentos[u]) _loginIntentos[u]={count:0,bloqueadoHasta:0};
    _loginIntentos[u].count++;
    const intentos = _loginIntentos[u].count;
    const restantes = 5 - intentos;

    logAuditFail(u, 'Contrase√±a incorrecta (intento '+intentos+')');

    if(!usrExiste){
      toast('Usuario no encontrado','error');
    } else if(!usrExiste.activo){
      toast('Esta cuenta est√° desactivada. Contacte al administrador.','error');
    } else if(intentos >= (_pwPolicy.maxIntentos||5)){
      _loginIntentos[u].bloqueadoHasta = Date.now() + (_pwPolicy.minBloqueo||5)*60*1000;
      _loginIntentos[u].count = 0;
      toast('Demasiados intentos fallidos. Cuenta bloqueada '+(_pwPolicy.minBloqueo||5)+' minutos.','error');
    } else {
      toast('Contrase√±a incorrecta. '+(restantes>0?restantes+' intentos restantes antes del bloqueo':''),'error');
      // Sacudir el campo de contrase√±a visualmente
      const pw = document.getElementById('pwInput');
      pw.style.borderColor='#e74c3c';
      pw.style.animation='shake 0.4s ease';
      setTimeout(()=>{pw.style.borderColor='';pw.style.animation='';},600);
    }
  }
}
function logout(){if(confirm('¬øCerrar sesi√≥n?')){logAudit('LOGOUT','Cierre de sesi√≥n');setTimeout(()=>location.reload(),300);}}

// ===== NAVEGACI√ìN =====
function go(v){
  if(usrActual && !puedeAcceder(v)){toast('No tienes permiso para acceder a este m√≥dulo','error');return;}
  document.querySelectorAll('.vp').forEach(e=>e.classList.remove('activa'));
  document.querySelectorAll('.ni').forEach(e=>e.classList.remove('activo'));
  const el=document.getElementById('vp-'+v);if(el)el.classList.add('activa');
  const nv=document.getElementById('nav-'+v);if(nv)nv.classList.add('activo');
  const act={dashboard:renderDash,calendario:renderCal,membresia:()=>{renderM();actCelSel()},finanzas:()=>{if(!_db.actividades)_db.actividades={};renderFin();renderGastos();resumen();selFinMiem();const fd=document.getElementById('fFecha');if(fd)fd.valueAsDate=new Date();const gd=document.getElementById('gFecha');if(gd)gd.valueAsDate=new Date();},ninos:()=>{renderN();selPadres()},asistencia:()=>{if(!_db.actividades)_db.actividades={};renderActividades()},reportes:()=>{const fi=new Date();fi.setMonth(fi.getMonth()-3);document.getElementById('rFI').valueAsDate=fi;document.getElementById('rFF').valueAsDate=new Date();if(_repData.length)renderListaRep()},publicidad:initPub,admin:()=>{renderUsr();if(!document.getElementById("pcard-dashboard"))cargarPermisosPorRol();},visitas:()=>{renderVis();statVis()},celulas:()=>{renderCel();selLideres()},oracion:renderOra,prestamos:()=>{go('finanzas');setTimeout(()=>finTab('prestamos',document.getElementById('ftab-prestamos')),150)},auditoria:()=>{renderAudit()}};
  if(act[v])act[v]();
}
function openM(id){document.getElementById(id).classList.add('activo');if(id==='mAnuncio')initEditor();if(id==='mAnunciosG')renderAnuG();if(id==='mCelula')selLideres();if(id==='mPrestamo'||id==='mOracion'){const s={mPrestamo:'preMiem',mOracion:'orMiem'}[id];if(s)selGen(s,miembros)}; if(id==='mVisita'){document.getElementById('visFecha').valueAsDate=new Date()}}
function closeM(id){document.getElementById(id).classList.remove('activo')}

// ===== DASHBOARD =====
function renderDash(){if(_repData&&_repData.length)actualizarAlertas();alertasTemasDash();
  const h=new Date();
  document.getElementById('dashFecha').textContent=h.toLocaleDateString('es-ES',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('dMiembros').textContent=miembros.filter(m=>m.estado==='activo').length;
  document.getElementById('dNinos').textContent=ninos.length;
  document.getElementById('dCelulas').textContent=celulas.length;
  const mes=new Date();document.getElementById('dVisitas').textContent=visitas.filter(v=>{const d=new Date(v.fecha+'T00:00:00');return d.getMonth()===mes.getMonth()&&d.getFullYear()===mes.getFullYear()}).length;
  const totMes=finanzas.filter(f=>{const d=new Date(f.fecha);return d.getMonth()===h.getMonth()&&d.getFullYear()===h.getFullYear()&&f.tipo!=='gasto'}).reduce((s,f)=>s+parseFloat(f.monto||0),0);
  document.getElementById('dFinanzas').textContent='$'+totMes.toFixed(0);
  const dates=Object.keys(asistData);let prom=0;
  if(dates.length>0&&miembros.length>0){const tot=dates.reduce((s,d)=>s+Object.values(asistData[d]).filter(v=>v==='presente').length,0);prom=Math.round(tot/(dates.length*miembros.length)*100)}
  document.getElementById('dAsist').textContent=prom+'%';
  ['diezmo','ofrenda','primicia','donacion'].forEach((t,i)=>{const s=finanzas.filter(f=>f.tipo===t).reduce((a,f)=>a+parseFloat(f.monto||0),0);['db_d','db_o','db_pr','db_dn'][i]&&(document.getElementById(['db_d','db_o','db_pr','db_dn'][i]).textContent='$'+s.toFixed(2))});
  const gt=finanzas.filter(f=>f.tipo!=='gasto').reduce((s,f)=>s+parseFloat(f.monto||0),0);document.getElementById('db_t').textContent='$'+gt.toFixed(2);
  renderCumples();renderEvDash();renderOraDash();
}
function renderCumples(){
  const h=new Date(),m=h.getMonth(),d=h.getDate();
  const prox=miembros.filter(mb=>{if(!mb.fechaNac)return false;const fn=new Date(mb.fechaNac+'T00:00:00');const dias=((fn.getMonth()-m)*30+(fn.getDate()-d)+365)%365;return dias>=0&&dias<=30}).sort((a,b)=>{const fa=new Date(a.fechaNac+'T00:00:00'),fb=new Date(b.fechaNac+'T00:00:00');return((fa.getMonth()-m)*30+(fa.getDate()-d)+365)%365-((fb.getMonth()-m)*30+(fb.getDate()-d)+365)%365});
  const c=document.getElementById('dashCumple');
  if(!prox.length){c.innerHTML='<div class="empty"><div class="empty-ico">üéÇ</div><div class="empty-txt">Sin cumplea√±os pr√≥ximos</div></div>';return}
  c.innerHTML=prox.slice(0,5).map(mb=>{const fn=new Date(mb.fechaNac+'T00:00:00');const ini=mb.nombre.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();const dias=((fn.getMonth()-m)*30+(fn.getDate()-d)+365)%365;return`<div class="cui"><div class="cuav">${ini}</div><div><div class="cun">${mb.nombre}</div><div class="cuf">${fn.toLocaleDateString('es-ES',{day:'numeric',month:'long'})}</div></div><div class="cud" style="color:${dias===0?'var(--ex)':'var(--do)'}">${dias===0?'üéâ HOY':'En '+dias+'d'}</div></div>`}).join('');
}
function renderEvDash(){
  const hoy=new Date().toISOString().split('T')[0];
  const prox=eventos.filter(e=>e.fecha>=hoy).sort((a,b)=>a.fecha.localeCompare(b.fecha)).slice(0,4);
  const c=document.getElementById('dashEv');
  if(!prox.length){c.innerHTML='<div class="empty"><div class="empty-ico">üìÖ</div><div class="empty-txt">Sin eventos pr√≥ximos</div></div>';return}
  c.innerHTML=prox.map(e=>{const d=new Date(e.fecha+'T00:00:00');return`<div class="evc"><div class="evfb"><div class="evd">${d.getDate()}</div><div class="evm">${d.toLocaleDateString('es-ES',{month:'short'})}</div></div><div><div class="evt">${e.titulo}</div><div class="evds">${e.lugar||''}</div>${e.hora?'<div class="evh">‚è∞ '+e.hora+'</div>':''}</div></div>`}).join('');
}
function renderOraDash(){
  const a=oraciones.filter(o=>o.estado==='activa'||o.urgencia==='urgente').slice(0,3);
  const c=document.getElementById('dashOra');
  if(!a.length){c.innerHTML='<div class="empty"><div class="empty-ico">üôè</div><div class="empty-txt">Sin peticiones recientes</div></div>';return}
  c.innerHTML=a.map(o=>`<div class="orc"><div class="ort">${o.urgencia==='urgente'?'üî¥ ':''}${o.titulo}</div><div class="orx">${o.texto||''}</div><div class="orm">${o.sol||'An√≥nimo'} ¬∑ ${fmtF(o.fecha)}</div></div>`).join('');
}
function checkCumples(){const h=new Date();const c=miembros.filter(m=>{if(!m.fechaNac)return false;const fn=new Date(m.fechaNac+'T00:00:00');return fn.getMonth()===h.getMonth()&&fn.getDate()===h.getDate()});if(c.length){document.getElementById('hCumple').style.display='flex';document.getElementById('cumpleTxt').textContent='üéÇ ¬°Hoy cumple a√±os '+c.map(m=>m.nombre.split(' ')[0]).join(', ')+'!'}}

// ===== CALENDARIO =====
function renderCal(){
  const y=calF.getFullYear(),m=calF.getMonth();
  document.getElementById('calMes').textContent=new Date(y,m).toLocaleDateString('es-ES',{month:'long',year:'numeric'}).replace(/^./,c=>c.toUpperCase());
  const g=document.getElementById('calGrid'),dias=['Dom','Lun','Mar','Mi√©','Jue','Vie','S√°b'];
  let h=dias.map(d=>`<div class="cdh">${d}</div>`).join('');
  const p1=new Date(y,m,1),ult=new Date(y,m+1,0),hoy=new Date();
  for(let i=0;i<p1.getDay();i++)h+=`<div class="cd om"></div>`;
  for(let d=1;d<=ult.getDate();d++){const fecha=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;const esH=d===hoy.getDate()&&m===hoy.getMonth()&&y===hoy.getFullYear();const tiE=eventos.some(e=>e.fecha===fecha);h+=`<div class="cd${esH?' hoy':''}${tiE?' te':''}" onclick="verDia('${fecha}')">${d}</div>`}
  g.innerHTML=h;renderEvList();
}
function navCal(d){calF.setMonth(calF.getMonth()+d);renderCal()}
function verDia(f){document.getElementById('evFecha').value=f;document.getElementById('evId').value='';openM('mEvento')}
function renderEvList(){
  const y=calF.getFullYear(),m=calF.getMonth();
  const evs=eventos.filter(e=>{const d=new Date(e.fecha+'T00:00:00');return d.getFullYear()===y&&d.getMonth()===m}).sort((a,b)=>a.fecha.localeCompare(b.fecha));
  const c=document.getElementById('listaEv');
  if(!evs.length){c.innerHTML='<div class="empty"><div class="empty-ico">üìÖ</div><div class="empty-txt">Sin eventos este mes</div></div>';return}
  c.innerHTML=evs.map((e,i)=>{const d=new Date(e.fecha+'T00:00:00');return`<div class="evc"><div class="evfb"><div class="evd">${d.getDate()}</div><div class="evm">${d.toLocaleDateString('es-ES',{month:'short'})}</div></div><div style="flex:1"><div class="evt">${e.titulo}</div><div class="evds">${e.tipo||''} ${e.lugar?'¬∑ '+e.lugar:''}</div>${e.hora?'<div class="evh">‚è∞ '+e.hora+'</div>':''}</div><button class="btn btn-d btn-xs" onclick="delEv('${e.id}')">üóëÔ∏è</button></div>`}).join('');
}
async function guardarEv(){const t=document.getElementById('evTit').value.trim(),f=document.getElementById('evFecha').value;if(!t||!f){toast('Complete t√≠tulo y fecha','error');return}const ev={id:document.getElementById('evId').value||'ev_'+Date.now(),titulo:t,fecha:f,hora:document.getElementById('evHora').value,tipo:document.getElementById('evTipo').value,lugar:document.getElementById('evLugar').value,descripcion:document.getElementById('evDesc').value};await dbP('eventos',ev);const idx=eventos.findIndex(e=>e.id===ev.id);if(idx>=0)eventos[idx]=ev;else eventos.push(ev);closeM('mEvento');renderCal();toast('Evento guardado')}
async function delEv(id){if(!confirm('¬øEliminar evento?'))return;await dbD('eventos',id);eventos=eventos.filter(e=>e.id!==id);renderCal();toast('Evento eliminado')}

// ===== MEMBRES√çA =====
async function guardarM(){
  const n=document.getElementById('mNom').value.trim();
  if(!n){toast('El nombre es requerido','error');return}
  const id=document.getElementById('mId').value;
  // Leer temas pendientes del hidden field
  let temas=[];
  try{ temas=JSON.parse(document.getElementById('mTemas').value||'[]'); }catch(e){}
  const m={
    id:id||'miem_'+Date.now(),
    nombre:n,
    telefono:document.getElementById('mTel').value,
    email:document.getElementById('mEmail').value,
    direccion:document.getElementById('mDir').value,
    fechaNac:document.getElementById('mFNac').value,
    fechaIng:document.getElementById('mFIng').value,
    estadoCivil:document.getElementById('mECiv').value,
    ministerio:document.getElementById('mMin').value,
    estado:document.getElementById('mEst').value,
    celula:document.getElementById('mCel').value,
    notas:document.getElementById('mNotas').value,
    cedula:document.getElementById('mCedula').value,
    pasaporte:document.getElementById('mPasaporte').value,
    cedulaVence:document.getElementById('mCedulaVence').value,
    nacionalidad:document.getElementById('mNacionalidad').value,
    foto:document.getElementById('mFoto').value,
    temas:temas,
    historial: (() => { try{ return JSON.parse(document.getElementById('mHistorial').value||'[]'); }catch(e){ return []; } })()
  };
  await dbP('miembros',m);
  const idx=miembros.findIndex(x=>x.id===m.id);
  if(idx>=0)miembros[idx]=m; else miembros.push(m);
  limpiarM(); renderM();
  logAudit(id?'UPDATE':'CREATE',(id?'Actualizar':'Crear')+' miembro: '+n);
  toast(id?'Miembro actualizado':'Miembro guardado');
}
function limpiarM(){
  ['mId','mNom','mTel','mEmail','mDir','mFNac','mFIng','mNotas',
   'mCedula','mPasaporte','mCedulaVence','mNacionalidad','mFoto','mTemas','mHistorial'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('mECiv').value='soltero';
  document.getElementById('mMin').value='ninguno';
  document.getElementById('mEst').value='activo';
  document.getElementById('mCel').value='';
  document.getElementById('editLbl').style.display='none';
  borrarFoto();
  document.getElementById('listaTemasPend').innerHTML='<div style="color:#555;font-size:12px;padding:12px;text-align:center">Guarda el miembro primero, luego agrega temas aqu√≠.</div>';
  document.getElementById('listaHistorial').innerHTML='<div style="color:#555;font-size:12px;padding:8px;text-align:center">No hay acciones registradas.</div>';
  tabMForm('general', document.querySelector('.mftab'));
}
function editM(i){
  const m=miembros[i];
  document.getElementById('mId').value=m.id;
  document.getElementById('mNom').value=m.nombre;
  document.getElementById('mTel').value=m.telefono||'';
  document.getElementById('mEmail').value=m.email||'';
  document.getElementById('mDir').value=m.direccion||'';
  document.getElementById('mFNac').value=m.fechaNac||'';
  document.getElementById('mFIng').value=m.fechaIng||'';
  document.getElementById('mECiv').value=m.estadoCivil||'soltero';
  document.getElementById('mMin').value=m.ministerio||'ninguno';
  document.getElementById('mEst').value=m.estado||'activo';
  document.getElementById('mCel').value=m.celula||'';
  document.getElementById('mNotas').value=m.notas||'';
  // Identidad
  document.getElementById('mCedula').value=m.cedula||'';
  document.getElementById('mPasaporte').value=m.pasaporte||'';
  document.getElementById('mCedulaVence').value=m.cedulaVence||'';
  document.getElementById('mNacionalidad').value=m.nacionalidad||'';
  // Foto
  if(m.foto){ document.getElementById('mFoto').value=m.foto; mostrarFoto(m.foto); }
  else borrarFoto();
  // Temas pendientes
  const temas=m.temas||[];
  document.getElementById('mTemas').value=JSON.stringify(temas);
  renderTemas(temas);
  // Historial
  const hist=m.historial||[];
  document.getElementById('mHistorial').value=JSON.stringify(hist);
  // Set today as default date for historial
  const hf=document.getElementById('histFecha'); if(hf) hf.valueAsDate=new Date();
  renderHistorial(hist);
  document.getElementById('editLbl').style.display='inline';
  document.querySelector('.contenido').scrollTo(0,0);
  tabMForm('general', document.querySelector('.mftab'));
}
async function delM(i){
  const nombre=miembros[i].nombre;
  const conf=prompt(`‚ö†Ô∏è Para confirmar, escribe el nombre exacto del miembro:\n\n"${nombre}"\n\nEsto eliminar√° permanentemente todos sus datos.`);
  if(conf===null) return;
  if(conf.trim().toLowerCase()!==nombre.toLowerCase()){toast('Nombre incorrecto. No se elimin√≥.','error');return;}
  await dbD('miembros',miembros[i].id);logAudit('DELETE','Eliminar miembro: '+nombre);miembros.splice(i,1);renderM();toast('Miembro eliminado');
}
function filtrarM(){const q=document.getElementById('buscarM').value.toLowerCase();document.querySelectorAll('#tbM tr').forEach(r=>r.style.display=r.textContent.toLowerCase().includes(q)?'':'none')}
function actCelSel(){const s=document.getElementById('mCel');s.innerHTML='<option value="">Sin c√©lula</option>';celulas.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.nombre;s.appendChild(o)})}
const EBADGE={activo:'ba',inactivo:'bi',visitante:'bv','visitante-habitual':'bvh','visita-nueva':'bvn'};
const ELABEL={activo:'Activo',inactivo:'Inactivo',visitante:'Visitante','visitante-habitual':'Vis. Habitual','visita-nueva':'Visita Nueva'};
function renderM(){
  const t=document.getElementById('tbM');
  if(!miembros.length){t.innerHTML='<tr><td colspan="6" style="text-align:center;padding:36px;color:#555">No hay miembros registrados</td></tr>';document.getElementById('subMiem').textContent='0 miembros';document.getElementById('cuentaM').textContent='';return}
  t.innerHTML=miembros.map((m,i)=>{
    const temasAbiertos=(m.temas||[]).filter(t=>t.estado!=='resuelto');
    const hayAlta=temasAbiertos.some(t=>t.prioridad==='alta');
    const alertaHtml=temasAbiertos.length>0
      ?`<span class="alerta-cnt" title="${temasAbiertos.map(t=>t.titulo).join(', ')}" style="${hayAlta?'background:rgba(231,76,60,.2);color:#e74c3c':'background:rgba(243,156,18,.15);color:#f39c12'}">${hayAlta?'üî¥':'üü°'} ${temasAbiertos.length}</span>`
      :'<span style="color:#444;font-size:10px">‚Äî</span>';
    const fotoHtml=m.foto
      ?`<div class="mava"><img src="${m.foto}" alt=""></div>`
      :`<div class="mava">${(m.nombre||'?').substring(0,2).toUpperCase()}</div>`;
    return`<tr>
      <td>${fotoHtml}</td>
      <td><div style="font-weight:700;color:#fff">${m.nombre}</div>${m.cedula?'<div style="font-size:9px;color:#666;font-family:monospace">ID: '+m.cedula+'</div>':''}${m.email?'<div style="font-size:9px;color:#777">'+m.email+'</div>':''}</td>
      <td><span class="badge bvol" style="font-size:9px">${MINS[m.ministerio]||'‚Äî'}</span></td>
      <td><span class="badge ${EBADGE[m.estado]||'bi'}">${ELABEL[m.estado]||m.estado}</span></td>
      <td>${alertaHtml}</td>
      <td style="white-space:nowrap">
        <button class="btn btn-i btn-xs" title="Editar miembro" onclick="editM(${i})">‚úèÔ∏è Editar</button>
        ${m.telefono?`<button class="btn btn-wa btn-xs" onclick="waM('${m.telefono}','${m.nombre}')">üì±</button>`:''}
        <button class="btn btn-d btn-xs" title="Eliminar (requiere confirmaci√≥n)" onclick="delM(${i})">üóëÔ∏è</button>
      </td></tr>`;}).join('');
  const activos=miembros.filter(m=>m.estado==='activo').length;
  document.getElementById('subMiem').textContent=miembros.length+' registrados ¬∑ '+activos+' activos';document.getElementById('cuentaM').textContent=miembros.length;
}
function waM(tel,nom){if(tel)window.open('https://wa.me/'+tel.replace(/\D/g,'')+'?text=Hola+'+encodeURIComponent(nom),'_blank');else toast('Sin tel√©fono','error')}
function exportMiembrosCSV(){let c='Nombre,Tel√©fono,Email,Estado,Ministerio,C√©lula\n';miembros.forEach(m=>{const cel=celulas.find(x=>x.id===m.celula);c+=`"${m.nombre}","${m.telefono||''}","${m.email||''}","${m.estado}","${MINS[m.ministerio]||''}","${cel?cel.nombre:''}"\n`});dl(c,'miembros.csv','text/csv');toast('CSV exportado')}

// ===== VISITAS =====
async function guardarVis(){const n=document.getElementById('visNom').value.trim();if(!n){toast('El nombre es requerido','error');return}const v={id:document.getElementById('visId').value||'vis_'+Date.now(),nombre:n,telefono:document.getElementById('visTel').value,email:document.getElementById('visEmail').value,fecha:document.getElementById('visFecha').value,llego:document.getElementById('visLleg').value,estado:document.getElementById('visEst').value,notas:document.getElementById('visNotas').value};await dbP('visitas',v);const idx=visitas.findIndex(x=>x.id===v.id);if(idx>=0)visitas[idx]=v;else visitas.push(v);closeM('mVisita');renderVis();statVis();toast('Visita registrada')}
function statVis(){document.getElementById('vTot').textContent=visitas.length;document.getElementById('vHab').textContent=visitas.filter(v=>v.estado==='visitante-habitual').length;document.getElementById('vNuv').textContent=visitas.filter(v=>v.estado==='visita-nueva').length;document.getElementById('vConv').textContent=visitas.filter(v=>v.estado==='convertido').length}
async function delVis(i){if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.'))return;await dbD('visitas',visitas[i].id);visitas.splice(i,1);renderVis();statVis();toast('Eliminado')}
function renderVis(){const t=document.getElementById('tbVis');if(!visitas.length){t.innerHTML='<tr><td colspan="7" style="text-align:center;padding:36px;color:#555">No hay visitas</td></tr>';return}t.innerHTML=visitas.slice().reverse().map((v,i)=>`<tr><td style="font-weight:700;color:#fff">${v.nombre}</td><td>${v.telefono||'-'}</td><td>${fmtF(v.fecha)}</td><td>${v.llego||'-'}</td><td><span class="badge bvn">${v.estado}</span></td><td>${v.notas||'-'}</td><td><button class="btn btn-d btn-xs" onclick="delVis(${visitas.length-1-i})">üóëÔ∏è</button></td></tr>`).join('')}

// ===== C√âLULAS =====
function selLideres(){['celLid'].forEach(id=>{const s=document.getElementById(id);if(!s)return;s.innerHTML='<option value="">-- Seleccione --</option>';miembros.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.nombre;s.appendChild(o)})})}
async function guardarCel(){const n=document.getElementById('celNom').value.trim(),lid=document.getElementById('celLid').value;if(!n||!lid){toast('Complete nombre y l√≠der','error');return}const lm=miembros.find(m=>m.id===lid);const c={id:document.getElementById('celId').value||'cel_'+Date.now(),nombre:n,liderId:lid,liderNombre:lm?lm.nombre:'',dia:document.getElementById('celDia').value,hora:document.getElementById('celHora').value,lugar:document.getElementById('celLugar').value,descripcion:document.getElementById('celDesc').value};await dbP('celulas',c);const idx=celulas.findIndex(x=>x.id===c.id);if(idx>=0)celulas[idx]=c;else celulas.push(c);closeM('mCelula');renderCel();toast('C√©lula guardada')}
async function delCel(i){if(!confirm('¬øEliminar c√©lula?'))return;await dbD('celulas',celulas[i].id);celulas.splice(i,1);renderCel();toast('Eliminado')}
function renderCel(){
  const cg=document.getElementById('celGrid'),t=document.getElementById('tbCel');
  if(!celulas.length){cg.innerHTML='<div class="empty" style="grid-column:1/-1"><div class="empty-ico">üè†</div><div class="empty-txt">No hay c√©lulas</div></div>';t.innerHTML='<tr><td colspan="6" style="text-align:center;padding:36px;color:#555">No hay c√©lulas</td></tr>';return}
  cg.innerHTML=celulas.map(c=>{const ms=miembros.filter(m=>m.celula===c.id).length;return`<div class="cel-card"><div class="cel-n">üè† ${c.nombre}</div><div class="cel-l">üë§ ${c.liderNombre}</div><div class="cel-st"><div class="cel-sn" style="text-align:left"><div class="cel-sn">${ms}</div><div class="cel-sl">Miembros</div></div><div><div class="cel-sn">${c.dia||'-'}</div><div class="cel-sl">D√≠a</div></div></div></div>`}).join('');
  t.innerHTML=celulas.map((c,i)=>{const ms=miembros.filter(m=>m.celula===c.id).length;return`<tr><td style="font-weight:700;color:#fff">${c.nombre}</td><td>${c.liderNombre}</td><td>${c.dia||'-'} ${c.hora||''}</td><td>${c.lugar||'-'}</td><td><span class="badge ba">${ms} miembros</span></td><td><button class="btn btn-d btn-xs" onclick="delCel(${i})">üóëÔ∏è</button></td></tr>`}).join('');
}

// ===== NI√ëOS =====
async function guardarN(){const n=document.getElementById('nNom').value.trim(),p=document.getElementById('nPadre').value;if(!n||!p){toast('Complete nombre y padre/tutor','error');return}const pa=miembros.find(m=>m.id===p);const ni={id:'nino_'+Date.now(),nombre:n,edad:document.getElementById('nEdad').value,fechaNac:document.getElementById('nFNac').value,grado:document.getElementById('nGrado').value,padreId:p,padreNombre:pa?pa.nombre:'',alergias:document.getElementById('nAler').value,emergencia:document.getElementById('nEmerg').value};await dbP('ninos',ni);ninos.push(ni);limpiarN();renderN();toast('Ni√±o registrado')}
function limpiarN(){['nNom','nEdad','nFNac','nGrado','nPadre','nAler','nEmerg'].forEach(id=>document.getElementById(id).value='')}
function selPadres(){const s=document.getElementById('nPadre');s.innerHTML='<option value="">-- Seleccione --</option>';miembros.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.nombre;s.appendChild(o)})}
async function delN(i){if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.'))return;await dbD('ninos',ninos[i].id);ninos.splice(i,1);renderN();toast('Eliminado')}
function renderN(){const t=document.getElementById('tbNin');if(!ninos.length){t.innerHTML='<tr><td colspan="7" style="text-align:center;padding:36px;color:#555">No hay ni√±os</td></tr>';return}t.innerHTML=ninos.map((n,i)=>`<tr><td style="font-weight:700;color:#fff">${n.nombre}</td><td>${n.edad||'-'}</td><td>${n.grado||'-'}</td><td>${n.padreNombre}</td><td>${n.alergias?'<span style="color:var(--pe)">‚ö†Ô∏è '+n.alergias+'</span>':'-'}</td><td>${n.emergencia||'-'}</td><td><button class="btn btn-d btn-xs" onclick="delN(${i})">üóëÔ∏è</button></td></tr>`).join('')}

// ===== ORACI√ìN =====
async function guardarOra(){const t=document.getElementById('orTit').value.trim();if(!t){toast('El t√≠tulo es requerido','error');return}const mid=document.getElementById('orMiem').value;const mb=miembros.find(m=>m.id===mid);const o={id:document.getElementById('orId').value||'ora_'+Date.now(),titulo:t,texto:document.getElementById('orTxt').value,miembroId:mid,sol:mb?mb.nombre:'An√≥nimo',urgencia:document.getElementById('orUrg').value,estado:document.getElementById('orEst').value,fecha:new Date().toISOString().split('T')[0]};await dbP('oraciones',o);const idx=oraciones.findIndex(x=>x.id===o.id);if(idx>=0)oraciones[idx]=o;else oraciones.push(o);closeM('mOracion');renderOra();toast('Petici√≥n guardada')}
async function togOra(id){const o=oraciones.find(x=>x.id===id);if(!o)return;o.estado=o.estado==='activa'?'respondida':'activa';await dbP('oraciones',o);renderOra();toast('Estado actualizado')}
async function delOra(id){if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.'))return;await dbD('oraciones',id);oraciones=oraciones.filter(o=>o.id!==id);renderOra();toast('Eliminado')}
function filtOra(f,el){filtroOra=f;document.querySelectorAll('.tabs .tab').forEach(t=>t.classList.remove('activo'));el.classList.add('activo');renderOra()}
function renderOra(){let l=oraciones;if(filtroOra!=='todas')l=oraciones.filter(o=>filtroOra==='urgente'?o.urgencia==='urgente':o.estado===filtroOra);const c=document.getElementById('listaOra');if(!l.length){c.innerHTML='<div class="empty"><div class="empty-ico">üôè</div><div class="empty-txt">No hay peticiones</div></div>';return}c.innerHTML=l.map(o=>`<div class="orc"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div class="ort">${o.urgencia==='urgente'?'üî¥ ':''}${o.titulo} <span class="badge ${o.estado==='respondida'?'ba':'bv'}" style="margin-left:6px">${o.estado==='respondida'?'Respondida':'Activa'}</span></div><div class="orx">${o.texto||''}</div><div class="orm">üôè ${o.sol} ¬∑ ${fmtF(o.fecha)}</div></div><div style="display:flex;gap:5px;flex-shrink:0;margin-left:8px"><button class="btn btn-e btn-xs" onclick="togOra('${o.id}')">${o.estado==='activa'?'‚úÖ':'üîÑ'}</button><button class="btn btn-d btn-xs" onclick="delOra('${o.id}')">üóëÔ∏è</button></div></div></div>`).join('')}
function selGen(id,l){const s=document.getElementById(id);if(!s)return;s.innerHTML='<option value="">-- Seleccione --</option>';l.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.nombre;s.appendChild(o)})}

// ===== FINANZAS (nuevo sistema de pesta√±as) =====
let tipoFinActivo = 'diezmo';

function finTab(tab, el){
  ['entradas','gastos','prestamos','resumen'].forEach(t=>{
    const d=document.getElementById('fin-'+t);
    if(d) d.style.display = t===tab ? 'block':'none';
  });
  document.querySelectorAll('#vp-finanzas .tab').forEach(x=>x.classList.remove('activo'));
  if(el) el.classList.add('activo');
  if(tab==='resumen') renderResumenFin();
  if(tab==='prestamos') renderPres();
  if(tab==='gastos') renderGastos();
  if(tab==='entradas') renderFin();
}

function selTipoFin(tipo){
  tipoFinActivo = tipo;
  // Quitar activo de todas
  document.querySelectorAll('.fin-cat-card').forEach(c=>c.removeAttribute('data-active'));
  const card = document.getElementById('fcat-'+tipo);
  if(card) card.setAttribute('data-active','true');
  const labels={diezmo:'üìñ Diezmo',ofrenda:'üôè Ofrenda',primicia:'üåæ Primicia',donacion:'üéÅ Donaci√≥n',otro:'üìã Otro ingreso'};
  const lbl = labels[tipo]||tipo;
  const l1=document.getElementById('fCatSelLbl'); if(l1) l1.textContent=lbl;
  const l2=document.getElementById('fCatSelLbl2'); if(l2) l2.textContent=lbl;
  document.getElementById('donBox').style.display = tipo==='donacion' ? 'block':'none';
}

// Alias para compatibilidad con c√≥digo viejo
function selTipo(t,btn){ tipoFinActivo=t; selTipoFin(t); }

function cambDon(){document.getElementById('artBox').style.display=document.getElementById('donTipo').value==='articulos'?'block':'none'}

function selFinMiem(){
  const s=document.getElementById('fMiem');
  s.innerHTML='<option value="">‚Äî An√≥nimo ‚Äî</option>';
  miembros.forEach(m=>{const o=document.createElement('option');o.value=m.id;o.textContent=m.nombre;s.appendChild(o)});
}

async function guardarFin(){
  const f=document.getElementById('fFecha').value;
  const m=parseFloat(document.getElementById('fMonto').value)||0;
  if(!f){toast('Seleccione una fecha','error');return}
  if(m<=0){toast('Ingrese un monto v√°lido','error');return}
  const mid=document.getElementById('fMiem').value;
  const mb=miembros.find(x=>x.id===mid);
  const fn={
    id:'fin_'+Date.now(),
    fecha:f,
    tipo:tipoFinActivo,
    miembroId:mid,
    miembroNombre:mb?mb.nombre:'An√≥nimo',
    monto:m,
    metodo:document.getElementById('fMet').value,
    descripcion:document.getElementById('fDesc').value
  };
  if(tipoFinActivo==='donacion'){
    fn.donTipo=document.getElementById('donTipo').value;
    if(fn.donTipo==='articulos') fn.articulos=document.getElementById('donArt').value;
  }
  await dbP('finanzas',fn);
  finanzas.push(fn);
  limpiarFin();
  renderFin();
  resumen();
  logAudit('CREATE','Registro financiero: $'+m+' tipo '+tipoFinActivo);
  toast('‚úÖ Entrada registrada correctamente');
}

function limpiarFin(){
  document.getElementById('fFecha').valueAsDate=new Date();
  ['fMonto','fDesc'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  document.getElementById('fMiem').value='';
  document.getElementById('fMet').value='efectivo';
  document.getElementById('donBox').style.display='none';
  selTipoFin('diezmo');
}

// Gastos
async function guardarGasto(){
  const f=document.getElementById('gFecha').value;
  const m=parseFloat(document.getElementById('gMonto').value)||0;
  if(!f){toast('Seleccione una fecha','error');return}
  if(m<=0){toast('Ingrese un monto v√°lido','error');return}
  const desc=document.getElementById('gDesc').value.trim();
  if(!desc){toast('Ingrese una descripci√≥n del gasto','error');return}
  const fn={
    id:'fin_'+Date.now(),
    fecha:f,
    tipo:'gasto',
    categoria:document.getElementById('gCategoria').value,
    miembroNombre:'‚Äî',
    monto:m,
    metodo:document.getElementById('gMet').value,
    descripcion:desc
  };
  await dbP('finanzas',fn);
  finanzas.push(fn);
  limpiarGasto();
  renderGastos();
  resumen();
  logAudit('CREATE','Gasto registrado: $'+m);
  toast('üì§ Gasto registrado');
}

function limpiarGasto(){
  document.getElementById('gFecha').valueAsDate=new Date();
  ['gMonto','gDesc'].forEach(id=>{const el=document.getElementById(id);if(el)el.value=''});
  document.getElementById('gCategoria').value='servicios';
  document.getElementById('gMet').value='efectivo';
}

function resumen(){
  const tipos=['diezmo','ofrenda','primicia','donacion'],ids=['fDi','fOf','fPr','fDn'];
  let tot=0;
  tipos.forEach((tp,i)=>{
    const s=finanzas.filter(f=>f.tipo===tp).reduce((a,f)=>a+parseFloat(f.monto||0),0);
    const el=document.getElementById(ids[i]);
    if(el) el.textContent='$'+s.toFixed(2);
    tot+=s;
  });
  // otro ingreso
  const sOt=finanzas.filter(f=>f.tipo==='otro').reduce((a,f)=>a+parseFloat(f.monto||0),0);
  const elOt=document.getElementById('fOt'); if(elOt) elOt.textContent='$'+sOt.toFixed(2);
  tot+=sOt;
  const elTo=document.getElementById('fTo'); if(elTo) elTo.textContent='$'+tot.toFixed(2);
  // gastos
  const gas=finanzas.filter(f=>f.tipo==='gasto').reduce((a,f)=>a+parseFloat(f.monto||0),0);
  const elGa=document.getElementById('fGa'); if(elGa) elGa.textContent='$'+gas.toFixed(2);
  const bal=tot-gas;
  const elBal=document.getElementById('fBalance');
  if(elBal){elBal.textContent='$'+bal.toFixed(2);elBal.style.color=bal>=0?'#27ae60':'#e74c3c';}
  // dashboard
  ['db_d','db_o','db_pr','db_dn'].forEach((id,i)=>{const el=document.getElementById(id);if(el)el.textContent='$'+finanzas.filter(f=>f.tipo===tipos[i]).reduce((a,f)=>a+parseFloat(f.monto||0),0).toFixed(2)});
  const elT=document.getElementById('db_t'); if(elT) elT.textContent='$'+tot.toFixed(2);
}

const TIPO_ICO={diezmo:'üìñ',ofrenda:'üôè',primicia:'üåæ',donacion:'üéÅ',gasto:'üì§',otro:'üìã'};
const TIPO_COLOR={diezmo:'rgba(212,175,55,.15)',ofrenda:'rgba(41,128,185,.15)',primicia:'rgba(39,174,96,.15)',donacion:'rgba(142,68,173,.15)',gasto:'rgba(231,76,60,.15)',otro:'rgba(255,255,255,.07)'};

function renderFin(){
  const c=document.getElementById('listaFinEntradas');
  if(!c) return;
  const filtro=(document.getElementById('fFiltroTipo')||{}).value||'';
  let lista=finanzas.filter(f=>f.tipo!=='gasto').sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  if(filtro) lista=lista.filter(f=>f.tipo===filtro);
  if(!lista.length){c.innerHTML='<div class="empty" style="padding:28px"><div class="empty-ico">üí∞</div><div class="empty-txt">No hay entradas registradas</div></div>';return}
  c.innerHTML=lista.map(f=>`
    <div class="fin-item">
      <div class="fin-item-ico" style="background:${TIPO_COLOR[f.tipo]||TIPO_COLOR.otro}">${TIPO_ICO[f.tipo]||'üìã'}</div>
      <div class="fin-item-info">
        <div class="fin-item-nom">${TIPO_LBL[f.tipo]||f.tipo} ¬∑ ${f.miembroNombre}</div>
        <div class="fin-item-det">${fmtF(f.fecha)} ¬∑ ${f.metodo}${f.descripcion?' ¬∑ '+f.descripcion:''}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="fin-item-monto entrada">$${parseFloat(f.monto).toFixed(2)}</div>
        <button class="btn btn-d btn-xs" onclick="if(!confirm('‚ö†Ô∏è ¬øEliminar este registro?\\nEsta acci√≥n no se puede deshacer.'))return;delFin('${f.id}')">üóëÔ∏è</button>
      </div>
    </div>`).join('');
}

function renderGastos(){
  const c=document.getElementById('listaFinGastos');
  if(!c) return;
  const lista=finanzas.filter(f=>f.tipo==='gasto').sort((a,b)=>new Date(b.fecha)-new Date(a.fecha));
  if(!lista.length){c.innerHTML='<div class="empty" style="padding:28px"><div class="empty-ico">üì§</div><div class="empty-txt">No hay gastos registrados</div></div>';return}
  const GICO={servicios:'üîå',mantenimiento:'üîß',ministerio:'üé§',alimentacion:'üçΩÔ∏è',transporte:'üöó',otro:'üìã'};
  c.innerHTML=lista.map(f=>`
    <div class="fin-item">
      <div class="fin-item-ico" style="background:rgba(231,76,60,.12)">${GICO[f.categoria]||'üì§'}</div>
      <div class="fin-item-info">
        <div class="fin-item-nom">${f.descripcion||'Gasto'}</div>
        <div class="fin-item-det">${fmtF(f.fecha)} ¬∑ ${f.metodo}${f.categoria?' ¬∑ '+f.categoria:''}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="fin-item-monto gasto">-$${parseFloat(f.monto).toFixed(2)}</div>
        <button class="btn btn-d btn-xs" onclick="if(!confirm('‚ö†Ô∏è ¬øEliminar este gasto?\\nEsta acci√≥n no se puede deshacer.'))return;delFin('${f.id}')">üóëÔ∏è</button>
      </div>
    </div>`).join('');
}

function renderResumenFin(){
  const tot=finanzas.filter(f=>f.tipo!=='gasto').reduce((a,f)=>a+parseFloat(f.monto||0),0);
  const gas=finanzas.filter(f=>f.tipo==='gasto').reduce((a,f)=>a+parseFloat(f.monto||0),0);
  const bal=tot-gas;
  const elT=document.getElementById('resTot'); if(elT) elT.textContent='$'+tot.toFixed(2);
  const elG=document.getElementById('resGas'); if(elG) elG.textContent='$'+gas.toFixed(2);
  const elB=document.getElementById('resBalance');
  if(elB){elB.textContent='$'+bal.toFixed(2);elB.style.color=bal>=0?'#27ae60':'#e74c3c';}
  // detalle por categor√≠a
  const cats=['diezmo','ofrenda','primicia','donacion','otro','gasto'];
  const lbl={diezmo:'üìñ Diezmos',ofrenda:'üôè Ofrendas',primicia:'üåæ Primicias',donacion:'üéÅ Donaciones',otro:'üìã Otros ingresos',gasto:'üì§ Gastos'};
  const c=document.getElementById('resDetalle');
  if(c) c.innerHTML=cats.map(cat=>{
    const s=finanzas.filter(f=>f.tipo===cat).reduce((a,f)=>a+parseFloat(f.monto||0),0);
    if(s===0) return '';
    return `<div style="display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,.05)">
      <div style="display:flex;align-items:center;gap:12px">
        <div style="width:36px;height:36px;border-radius:50%;background:${TIPO_COLOR[cat]};display:flex;align-items:center;justify-content:center;font-size:18px">${TIPO_ICO[cat]||'üìã'}</div>
        <div style="font-weight:700;color:#fff;font-size:13px">${lbl[cat]}</div>
      </div>
      <div style="font-size:18px;font-weight:700;font-family:Cinzel,serif;color:${cat==='gasto'?'#e74c3c':'#27ae60'}">$${s.toFixed(2)}</div>
    </div>`;
  }).join('');
}

async function delFin(id){
  await dbD('finanzas',id);
  finanzas=finanzas.filter(f=>f.id!==id);
  renderFin();renderGastos();resumen();
  toast('Eliminado');
}

function exportFinCSV(){
  let c='Fecha,Tipo,Miembro,Monto,M√©todo,Descripci√≥n\n';
  finanzas.forEach(f=>c+=`${f.fecha},"${f.tipo}","${f.miembroNombre||''}",${f.monto},"${f.metodo||''}","${f.descripcion||''}"\n`);
  dl(c,'finanzas.csv','text/csv');
  toast('CSV exportado');
}

// ===== ASISTENCIA (Sistema de Actividades) =====
let actividadActual = null;
let asistEstados = {};

function abrirCrearActividad(){
  const hoy=new Date().toISOString().split('T')[0];
  document.getElementById('actNombre').value='';
  document.getElementById('actFecha').value=hoy;
  document.getElementById('actHora').value='';
  document.getElementById('actTipo').value='culto';
  openM('mCrearActividad');
}

async function crearActividad(){
  const nom=document.getElementById('actNombre').value.trim();
  const fecha=document.getElementById('actFecha').value;
  if(!nom){toast('Ingrese el nombre de la actividad','error');return}
  if(!fecha){toast('Seleccione una fecha','error');return}
  const act={
    id:'act_'+Date.now(),
    nombre:nom,fecha,
    hora:document.getElementById('actHora').value,
    tipo:document.getElementById('actTipo').value,
    estado:'pendiente',
    creadoPor:usrActual?usrActual.nombre:'',
    fc:new Date().toISOString()
  };
  if(!_db.actividades) _db.actividades={};
  _db.actividades[act.id]=act;
  await _dbSave();
  closeM('mCrearActividad');
  toast('Actividad creada. Pasando lista...');
  setTimeout(()=>iniciarPasarLista(act),300);
}

function renderActividades(){
  const c=document.getElementById('listaActividades');
  const acts=Object.values(_db.actividades||{}).filter(a=>a.estado==='pendiente').sort((a,b)=>b.fecha.localeCompare(a.fecha));
  const tipos={culto:'‚õ™',celula:'üè†',jovenes:'üéØ',ninos:'üë∂',capacitacion:'üìö',otro:'üìã'};
  if(!acts.length){
    c.innerHTML='<div class="empty"><div class="empty-ico">üìÖ</div><div class="empty-txt">No hay actividades pendientes.<br>Crea una nueva para comenzar.</div></div>';
  } else {
    c.innerHTML=acts.map(a=>`
      <div style="display:flex;align-items:center;gap:14px;padding:16px 0;border-bottom:1px solid rgba(255,255,255,.04);flex-wrap:wrap">
        <div style="width:52px;height:52px;border-radius:14px;background:rgba(212,175,55,.08);border:1px solid rgba(212,175,55,.2);display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0">${tipos[a.tipo]||'üìã'}</div>
        <div style="flex:1;min-width:130px">
          <div style="font-weight:700;color:#fff;font-size:15px">${a.nombre}</div>
          <div style="font-size:11px;color:#888;margin-top:4px">${fmtF(a.fecha)}${a.hora?' ¬∑ ‚è∞ '+a.hora:''}</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-p" onclick="iniciarPasarLista(${JSON.stringify(a).replace(/"/g,'&quot;')})" style="min-height:44px;padding:10px 18px">üìã Pasar lista</button>
          <button class="btn btn-d btn-sm" onclick="confirmarElimActiv('${a.id}','${a.nombre.replace(/'/g,'')}')">üóëÔ∏è</button>
        </div>
      </div>`).join('');
  }
  renderHistorialAsist();
}

function confirmarElimActiv(id, nombre){
  // Confirmaci√≥n de seguridad con modal visual
  if(!confirm(`‚ö†Ô∏è ¬øEliminar la actividad "${nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) return;
  delete _db.actividades[id];
  _dbSave();
  renderActividades();
  toast('Actividad eliminada');
}

function iniciarPasarLista(act){
  actividadActual=act;
  asistEstados={};
  const prev=(asistData[act.id]||asistData[act.fecha])||{};
  miembros.forEach(m=>{asistEstados[m.id]=prev[m.id]||'pendiente'});
  // Mostrar vista pasar lista, ocultar vista actividades
  document.getElementById('vistaActividades').style.display='none';
  document.getElementById('vistaPasarLista').style.display='block';
  const tipos={culto:'‚õ™',celula:'üè†',jovenes:'üéØ',ninos:'üë∂',capacitacion:'üìö',otro:'üìã'};
  document.getElementById('aActividadNombre').textContent=`${tipos[act.tipo]||'üìã'} ${act.nombre} ‚Äî ${fmtF(act.fecha)}`;
  document.getElementById('buscarAsist').value='';
  // Scroll al top del contenido
  document.querySelector('.contenido').scrollTo(0,0);
  renderListaAsist();
}

function cerrarPasarLista(){
  actividadActual=null;asistEstados={};
  document.getElementById('vistaPasarLista').style.display='none';
  document.getElementById('vistaActividades').style.display='block';
  renderActividades();
}

function confirmarCerrarLista(){
  if(!confirm('¬øCancelar la lista? Los cambios no guardados se perder√°n.')) return;
  cerrarPasarLista();
}

function renderListaAsist(){
  const busq=(document.getElementById('buscarAsist').value||'').toLowerCase();
  const cPend=document.getElementById('listaAsist');
  const cPres=document.getElementById('listaPresentes');
  const cExcu=document.getElementById('listaExcusas');
  const secPres=document.getElementById('secPresentes');
  const secExcu=document.getElementById('secExcusas');
  cPend.innerHTML='';cPres.innerHTML='';cExcu.innerHTML='';
  let nPres=0,nExcu=0,nPend=0;
  miembros.forEach(m=>{
    if(busq&&!m.nombre.toLowerCase().includes(busq)) return;
    const e=asistEstados[m.id]||'pendiente';
    const ini=m.nombre.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase();
    const foto=m.foto?`<img src="${m.foto}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`:`<span style="font-size:13px;font-weight:700;color:var(--ng)">${ini}</span>`;
    if(e==='presente'){
      nPres++;
      const d=document.createElement('div');
      d.style.cssText='display:flex;align-items:center;gap:10px;background:rgba(39,174,96,.07);border:1px solid rgba(39,174,96,.3);border-radius:10px;padding:12px;cursor:pointer;transition:all .2s;user-select:none;-webkit-tap-highlight-color:transparent';
      d.title='Toca para quitar';
      d.onclick=()=>{asistEstados[m.id]='pendiente';renderListaAsist();contAsist()};
      d.innerHTML=`<div class="ava" style="width:36px;height:36px;font-size:12px;flex-shrink:0">${foto}</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.nombre}</div><div style="font-size:10px;color:#27ae60;margin-top:2px">Toca para quitar</div></div><span style="font-size:22px;flex-shrink:0">‚úÖ</span>`;
      cPres.appendChild(d);
    } else if(e==='justificado'){
      nExcu++;
      const d=document.createElement('div');
      d.style.cssText='display:flex;align-items:center;gap:10px;background:rgba(243,156,18,.07);border:1px solid rgba(243,156,18,.3);border-radius:10px;padding:12px;cursor:pointer;transition:all .2s;user-select:none;-webkit-tap-highlight-color:transparent';
      d.title='Toca para quitar excusa';
      d.onclick=()=>{asistEstados[m.id]='pendiente';renderListaAsist();contAsist()};
      d.innerHTML=`<div class="ava" style="width:36px;height:36px;font-size:12px;flex-shrink:0">${foto}</div><div style="flex:1;min-width:0"><div style="font-size:13px;font-weight:700;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.nombre}</div><div style="font-size:10px;color:#f39c12;margin-top:2px">Toca para quitar</div></div><span style="font-size:22px;flex-shrink:0">üìù</span>`;
      cExcu.appendChild(d);
    } else {
      nPend++;
      const d=document.createElement('div');
      d.className='ac';
      d.dataset.id=m.id;
      d.style.cssText='background:var(--gr);border:2px solid rgba(255,255,255,.07);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;transition:all .2s;user-select:none;-webkit-tap-highlight-color:transparent';
      d.innerHTML=`<div class="ava" style="flex-shrink:0">${foto}</div>
        <div style="flex:1;min-width:0">
          <div style="font-weight:700;font-size:14px;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${m.nombre}</div>
          <div style="font-size:10px;color:#777;margin-top:2px">${MINS[m.ministerio]||'Miembro'}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0">
          <button onclick="event.stopPropagation();asistEstados['${m.id}']='presente';renderListaAsist();contAsist()" 
            style="padding:10px 14px;background:rgba(39,174,96,.15);border:1.5px solid #27ae60;border-radius:9px;color:#27ae60;font-size:12px;font-weight:700;cursor:pointer;font-family:Lato,sans-serif;min-width:90px;min-height:38px;-webkit-tap-highlight-color:transparent">‚úÖ Asisti√≥</button>
          <button onclick="event.stopPropagation();asistEstados['${m.id}']='justificado';renderListaAsist();contAsist()" 
            style="padding:10px 14px;background:rgba(243,156,18,.12);border:1.5px solid #f39c12;border-radius:9px;color:#f39c12;font-size:12px;font-weight:700;cursor:pointer;font-family:Lato,sans-serif;min-width:90px;min-height:38px;-webkit-tap-highlight-color:transparent">üìù Excusa</button>
        </div>`;
      cPend.appendChild(d);
    }
  });
  secPres.style.display=nPres>0?'block':'none';
  secExcu.style.display=nExcu>0?'block':'none';
  document.getElementById('cntPresentes').textContent=nPres;
  document.getElementById('cntExcusas').textContent=nExcu;
  const cntPend=document.getElementById('cntPendientes');
  if(cntPend) cntPend.textContent=nPend;
  contAsist();
}

function filtrarListaAsist(){renderListaAsist()}

function contAsist(){
  const vals=Object.values(asistEstados);
  const pEl=document.getElementById('aP');if(pEl)pEl.textContent=vals.filter(v=>v==='presente').length;
  const aEl=document.getElementById('aA');if(aEl)aEl.textContent=vals.filter(v=>v==='pendiente').length;
  const jEl=document.getElementById('aJ');if(jEl)jEl.textContent=vals.filter(v=>v==='justificado').length;
  const tEl=document.getElementById('aT');if(tEl)tEl.textContent=miembros.length;
}

function marcarT(e){
  miembros.forEach(m=>{asistEstados[m.id]=e});
  renderListaAsist();
}

async function guardarAsist(){
  if(!actividadActual){toast('No hay actividad activa','error');return}
  const pres=Object.values(asistEstados).filter(v=>v==='presente').length;
  const exc=Object.values(asistEstados).filter(v=>v==='justificado').length;
  const pend=Object.values(asistEstados).filter(v=>v==='pendiente').length;
  if(!confirm(`¬øFinalizar la lista?\n\n‚úÖ Presentes: ${pres}\nüìù Con excusa: ${exc}\n‚ùå Sin marcar (quedar√°n como Ausentes): ${pend}\n\nEsta acci√≥n no se puede deshacer.`)) return;
  // Los pendientes pasan a ausentes autom√°ticamente
  miembros.forEach(m=>{if(!asistEstados[m.id]||asistEstados[m.id]==='pendiente') asistEstados[m.id]='ausente'});
  const datos={...asistEstados};
  asistData[actividadActual.id]=datos;
  asistData[actividadActual.fecha]=datos;
  await dbP('asistencia',{fecha:actividadActual.fecha,actividadId:actividadActual.id,actividadNombre:actividadActual.nombre,datos});
  if(_db.actividades&&_db.actividades[actividadActual.id]){
    _db.actividades[actividadActual.id].estado='guardada';
    _db.actividades[actividadActual.id].datosAsist=datos;
    await _dbSave();
  }
  cerrarPasarLista();
  toast('‚úÖ Lista guardada ‚Äî actividad movida a historial');
}

function renderHistorialAsist(){
  const c=document.getElementById('listaHistorialAsist');
  const guardadas=Object.values(_db.actividades||{}).filter(a=>a.estado==='guardada').sort((a,b)=>b.fecha.localeCompare(a.fecha));
  const tipos={culto:'‚õ™',celula:'üè†',jovenes:'üéØ',ninos:'üë∂',capacitacion:'üìö',otro:'üìã'};
  if(!guardadas.length){c.innerHTML='<div class="empty"><div class="empty-ico">üìú</div><div class="empty-txt">A√∫n no hay listas guardadas.</div></div>';return}
  c.innerHTML=guardadas.map(a=>{
    const datos=a.datosAsist||asistData[a.id]||{};
    const vals=Object.values(datos);
    const pres=vals.filter(v=>v==='presente').length;
    const aus=vals.filter(v=>v==='ausente').length;
    const exc=vals.filter(v=>v==='justificado').length;
    const total=pres+aus+exc;
    const pct=total>0?Math.round(pres/total*100):0;
    return `<div style="display:flex;align-items:center;gap:12px;padding:14px 0;border-bottom:1px solid rgba(255,255,255,.04);flex-wrap:wrap">
      <div style="width:46px;height:46px;border-radius:12px;background:rgba(39,174,96,.08);border:1px solid rgba(39,174,96,.2);display:flex;align-items:center;justify-content:center;font-size:22px;flex-shrink:0">${tipos[a.tipo]||'üìã'}</div>
      <div style="flex:1;min-width:120px">
        <div style="font-weight:700;color:#fff;font-size:13px">${a.nombre}</div>
        <div style="font-size:10px;color:#888;margin-top:2px">${fmtF(a.fecha)}${a.hora?' ¬∑ '+a.hora:''}</div>
        <div style="margin-top:6px;height:4px;background:rgba(255,255,255,.07);border-radius:2px;overflow:hidden;max-width:180px"><div style="height:100%;width:${pct}%;background:#27ae60;border-radius:2px;transition:width .3s"></div></div>
      </div>
      <div style="display:flex;gap:14px;font-size:13px;flex-wrap:wrap">
        <div style="text-align:center"><div style="color:#27ae60;font-weight:700;font-size:16px">${pres}</div><div style="color:#666;font-size:9px;text-transform:uppercase">Asisti√≥</div></div>
        <div style="text-align:center"><div style="color:#f39c12;font-weight:700;font-size:16px">${exc}</div><div style="color:#666;font-size:9px;text-transform:uppercase">Excusa</div></div>
        <div style="text-align:center"><div style="color:#e74c3c;font-weight:700;font-size:16px">${aus}</div><div style="color:#666;font-size:9px;text-transform:uppercase">Ausente</div></div>
      </div>
      <div style="display:flex;gap:6px;flex-shrink:0">
        <button class="btn btn-xl btn-xs" onclick="exportAsistCSVById('${a.id}')">üìä CSV</button>
        <button class="btn btn-d btn-xs" onclick="confirmarElimHistorial('${a.id}','${a.nombre.replace(/'/g,'')}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

function confirmarElimHistorial(id, nombre){
  if(!confirm(`‚ö†Ô∏è ¬øEliminar el registro de "${nombre}"?\n\nSe perder√°n todos los datos de asistencia de esta lista. Esta acci√≥n no se puede deshacer.`)) return;
  delete _db.actividades[id];
  _dbSave();
  renderActividades();
  toast('Registro eliminado');
}

function exportAsistCSV(){if(!actividadActual)return;exportAsistCSVById(actividadActual.id)}

function exportAsistCSVById(id){
  const act=(_db.actividades||{})[id];
  if(!act){toast('No se encontraron datos','error');return}
  const datos=act.datosAsist||asistData[id]||{};
  let c='Actividad,Fecha,Nombre,Estado\n';
  miembros.forEach(m=>c+=`"${act.nombre}","${act.fecha}","${m.nombre}","${datos[m.id]||'ausente'}"\n`);
  dl(c,'asistencia_'+act.nombre.replace(/\s+/g,'_')+'_'+act.fecha+'.csv','text/csv');
  toast('CSV exportado');
}

// ===== PR√âSTAMOS =====
async function guardarPre(){const mid=document.getElementById('preMiem').value;const m=parseFloat(document.getElementById('preMonto').value)||0;if(!mid||m<=0){toast('Complete miembro y monto','error');return}const mb=miembros.find(x=>x.id===mid);const p={id:document.getElementById('preId').value||'pre_'+Date.now(),miembroId:mid,miembroNombre:mb?mb.nombre:'',monto:m,fecha:document.getElementById('preFecha').value,vencimiento:document.getElementById('preVenc').value,motivo:document.getElementById('preMot').value,estado:'activo'};await dbP('prestamos',p);const idx=prestamos.findIndex(x=>x.id===p.id);if(idx>=0)prestamos[idx]=p;else prestamos.push(p);closeM('mPrestamo');renderPres();toast('Pr√©stamo registrado')}
async function pagarPre(id){const p=prestamos.find(x=>x.id===id);if(!p)return;p.estado='pagado';await dbP('prestamos',p);renderPres();toast('Marcado como pagado')}
async function delPre(id){if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.'))return;await dbD('prestamos',id);prestamos=prestamos.filter(p=>p.id!==id);renderPres();toast('Eliminado')}
function renderPres(){const hoy=new Date().toISOString().split('T')[0];document.getElementById('pTot').textContent=prestamos.length;document.getElementById('pAct').textContent=prestamos.filter(p=>p.estado==='activo').length;document.getElementById('pVen').textContent=prestamos.filter(p=>p.estado==='activo'&&p.vencimiento&&p.vencimiento<hoy).length;document.getElementById('pPag').textContent=prestamos.filter(p=>p.estado==='pagado').length;const c=document.getElementById('listaPres');if(!prestamos.length){c.innerHTML='<div class="empty"><div class="empty-ico">üí≥</div><div class="empty-txt">No hay pr√©stamos</div></div>';return}c.innerHTML=prestamos.map(p=>{const vc=p.estado==='activo'&&p.vencimiento&&p.vencimiento<hoy;return`<div class="prc${vc?' vc':p.estado==='pagado'?' pg':''}"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div><div style="font-weight:700;color:#fff;font-size:13px">${p.miembroNombre}</div><div style="color:#888;font-size:11px;margin-top:3px">${p.motivo||''}</div><div style="margin-top:6px;font-size:11px;color:#aaa">Otorgado: ${fmtF(p.fecha)} ${p.vencimiento?'¬∑ Vence: '+fmtF(p.vencimiento):''}</div></div><div style="text-align:right"><div style="font-size:22px;font-weight:700;color:${vc?'var(--pe)':p.estado==='pagado'?'var(--ex)':'var(--do)'}">$${p.monto.toFixed(2)}</div><span class="badge ${p.estado==='pagado'?'ba':vc?'bi':'bv'}" style="margin-top:5px">${p.estado==='pagado'?'Pagado':vc?'Vencido':'Activo'}</span></div></div><div class="bgrp" style="margin-top:10px">${p.estado==='activo'?`<button class="btn btn-e btn-xs" onclick="pagarPre('${p.id}')">‚úÖ Pagado</button>`:''}<button class="btn btn-d btn-xs" onclick="delPre('${p.id}')">üóëÔ∏è</button></div></div>`}).join('')}

// ===== REPORTES =====

// ================================================================
// REPORTES MEJORADOS ‚Äî asistencia por categor√≠a
// ================================================================
let _repData = [];      // datos generados del reporte
let _repFiltro = 'siempre'; // filtro activo

// Categorizar miembro seg√∫n % asistencia
function categorizarAsist(pct, diasUltimaVez){
  if(pct >= 90)                      return 'siempre';
  if(pct >= 70)                      return 'frecuente';
  if(pct >= 40)                      return 'ocasional';
  if(pct >= 10)                      return 'casinunca';
  return 'noasiste';
}

async function genReporte(){
  const fi   = document.getElementById('rFI').value;
  const ff   = document.getElementById('rFF').value;
  const rMin = document.getElementById('rMin')?.value || '';
  const rEst = document.getElementById('rEst')?.value || '';
  if(!fi||!ff){ toast('Seleccione fechas','error'); return; }

  let lista = [...miembros];
  if(rMin) lista = lista.filter(m => m.ministerio === rMin);
  if(rEst) lista = lista.filter(m => m.estado    === rEst);

  const stats = {};
  lista.forEach(m => {
    stats[m.id] = {
      miembro: m, total: 0, presentes: 0,
      ausentes: 0, justificados: 0, pct: 0,
      ultimaFecha: null, diasSinVenir: 999
    };
  });

  Object.keys(asistData).sort().forEach(fecha => {
    if(fecha < fi || fecha > ff) return;
    Object.keys(asistData[fecha]).forEach(mid => {
      if(!stats[mid]) return;
      stats[mid].total++;
      const e = asistData[fecha][mid];
      if(e === 'presente'){
        stats[mid].presentes++;
        stats[mid].ultimaFecha = fecha;
      } else if(e === 'ausente')     stats[mid].ausentes++;
      else if(e === 'justificado')   stats[mid].justificados++;
    });
  });

  const hoy = new Date();
  _repData = Object.values(stats).map(s => {
    s.pct = s.total > 0 ? (s.presentes / s.total * 100) : 0;
    s.diasSinVenir = s.ultimaFecha
      ? Math.floor((hoy - new Date(s.ultimaFecha)) / 86400000)
      : 999;
    s.categoria = categorizarAsist(s.pct, s.diasSinVenir);
    return s;
  });

  // Contadores por categor√≠a
  const cnt = {siempre:0, frecuente:0, ocasional:0, casinunca:0, noasiste:0};
  _repData.forEach(s => cnt[s.categoria] = (cnt[s.categoria]||0) + 1);
  document.getElementById('rSi').textContent  = cnt.siempre    || 0;
  document.getElementById('rFr').textContent  = cnt.frecuente  || 0;
  document.getElementById('rOc').textContent  = cnt.ocasional  || 0;
  document.getElementById('rIn').textContent  = cnt.casinunca  || 0;
  document.getElementById('rNo').textContent  = cnt.noasiste   || 0;

  // Activar primer tab y mostrar
  const tabs = document.querySelectorAll('.rep-tab');
  tabs.forEach(t => t.classList.remove('on'));
  if(tabs[0]) tabs[0].classList.add('on');
  _repFiltro = 'siempre';
  renderListaRep();

  // Actualizar alertas en dashboard
  actualizarAlertas();
  toast('Reporte generado ‚Äî ' + _repData.length + ' miembros');
  logAudit('EXPORT', 'Generar reporte de asistencia '+fi+' a '+ff);
}

function filtrarReporte(cat, btnEl){
  _repFiltro = cat;
  if(btnEl){
    document.querySelectorAll('.rep-tab').forEach(b => b.classList.remove('on'));
    btnEl.classList.add('on');
  }
  renderListaRep();
}

function renderListaRep(){
  const c = document.getElementById('listaSeg');
  if(!_repData.length){
    c.innerHTML = '<div class="empty"><div class="empty-ico">üìä</div><div class="empty-txt">Presiona "Generar Reporte" para ver resultados</div></div>';
    return;
  }

  let lista = _repFiltro === 'todos' ? [..._repData]
    : _repFiltro === 'seguimiento'
        ? _repData.filter(s => s.categoria === 'ocasional' || s.categoria === 'casinunca' || s.categoria === 'noasiste')
        : _repData.filter(s => s.categoria === _repFiltro);

  lista.sort((a,b) => b.pct - a.pct);

  if(!lista.length){
    c.innerHTML = '<div class="empty"><div class="empty-ico">üîç</div><div class="empty-txt">No hay miembros en esta categor√≠a para el per√≠odo seleccionado</div></div>';
    return;
  }

  const COL  = {siempre:'#27ae60', frecuente:'#2980b9', ocasional:'#f39c12', casinunca:'#e74c3c', noasiste:'#8e44ad'};
  const ICON = {siempre:'‚úÖ', frecuente:'üìÖ', ocasional:'üîÑ', casinunca:'‚ö†Ô∏è', noasiste:'‚ùå'};
  const ETIQ = {siempre:'Siempre asiste', frecuente:'Asistencia frecuente', ocasional:'Asistencia ocasional', casinunca:'Casi nunca asiste', noasiste:'No asiste'};
  const EBADGE = {activo:'ba', inactivo:'bi', visita:'bv'};

  c.innerHTML = lista.map(s => {
    const col  = COL[s.categoria] || '#888';
    const icon = ICON[s.categoria] || '‚Ä¢';
    const etiq = ETIQ[s.categoria] || '';
    const ult  = s.ultimaFecha ? ('√öltima vez: ' + fmtF(s.ultimaFecha) + ' ¬∑ hace ' + s.diasSinVenir + ' d√≠as') : 'Sin registros de asistencia';
    return `<div class="mcard ${s.categoria}">
      <div class="mcard-top">
        <div>
          <div class="mcard-nom">${icon} ${s.miembro.nombre}
            <span class="badge ${EBADGE[s.miembro.estado]||'bi'}" style="margin-left:5px">${s.miembro.estado||'-'}</span>
            <span class="badge bvol" style="margin-left:4px">${MINS[s.miembro.ministerio]||'Sin ministerio'}</span>
          </div>
          <div style="font-size:10px;color:#777;margin-top:3px">${ult}</div>
          <div style="font-size:10px;color:#777">
            <b style="color:#ccc">Presentes:</b> ${s.presentes} &nbsp;
            <b style="color:#ccc">Ausentes:</b> ${s.ausentes} &nbsp;
            <b style="color:#ccc">Justificados:</b> ${s.justificados} &nbsp;
            <b style="color:#ccc">Total sesiones:</b> ${s.total}
          </div>
        </div>
        <div style="text-align:center">
          <div class="mcard-pct" style="color:${col}">${s.pct.toFixed(0)}%</div>
          <div style="font-size:9px;color:${col};text-transform:uppercase;letter-spacing:.5px">${etiq}</div>
        </div>
      </div>
      <div class="pbar"><div class="pfill" style="width:${s.pct}%;background:${col}"></div></div>
      <div style="display:flex;gap:6px;flex-wrap:wrap">
        ${s.miembro.telefono ? `<button class="btn btn-wa btn-xs" onclick="waM('${s.miembro.telefono}','${s.miembro.nombre}')">üì± WhatsApp</button>` : ''}
        <button class="btn btn-i btn-xs" onclick="editM(${miembros.indexOf(s.miembro)});go('membresia')">‚úèÔ∏è Ver perfil</button>
      </div>
    </div>`;
  }).join('');
}

// Alertas de seguimiento ‚Äî aparecen en dashboard y en barra superior
function actualizarAlertas(){
  const alertas = _repData.filter(s =>
    s.categoria === 'casinunca' || s.categoria === 'noasiste' ||
    (s.categoria === 'ocasional' && s.diasSinVenir > 21)
  ).sort((a,b) => b.diasSinVenir - a.diasSinVenir);

  // Panel de alertas en dashboard
  const cDash = document.getElementById('dashAlertas');
  if(cDash){
    if(!alertas.length){
      cDash.innerHTML = '<div style="color:#555;font-size:12px;padding:8px">Sin alertas de seguimiento activas.</div>';
      return;
    }
    cDash.innerHTML = alertas.slice(0,10).map(s => {
      const esGrave = s.categoria === 'noasiste' || s.diasSinVenir > 45;
      return `<div class="alerta-seg ${esGrave?'':'oc'}" onclick="go('reportes')">
        <div class="alerta-ico">${esGrave ? 'üî¥' : 'üü°'}</div>
        <div class="alerta-info">
          <div class="alerta-nom">${s.miembro.nombre}</div>
          <div class="alerta-det">
            ${s.diasSinVenir < 999 ? '√öltima vez hace '+s.diasSinVenir+' d√≠as' : 'Sin registro de asistencia'} ¬∑ 
            ${s.pct.toFixed(0)}% de asistencia
          </div>
        </div>
        <span class="alerta-badge ${esGrave?'badge-peligro':'badge-aviso'}">${esGrave?'URGENTE':'AVISO'}</span>
      </div>`;
    }).join('');
    document.getElementById('dashAlertasCnt').textContent = alertas.length;
  }
}

// ================================================================
// EXPORTAR REPORTE ACTUAL
// ================================================================
function exportarReporteActualPDF(){
  if(!puedeExportar('reportes')){ toast('Sin permiso de exportar','error'); return; }
  if(!_repData.length){ toast('Genera un reporte primero','error'); return; }

  const lista = _repFiltro === 'todos' ? [..._repData]
    : _repFiltro === 'seguimiento'
        ? _repData.filter(s => ['ocasional','casinunca','noasiste'].includes(s.categoria))
        : _repData.filter(s => s.categoria === _repFiltro);

  const ETIQ = {siempre:'Siempre asiste', frecuente:'Frecuente', ocasional:'Ocasional', casinunca:'Casi nunca', noasiste:'No asiste', seguimiento:'Seguimiento', todos:'General'};
  const doc = getPDFBase();
  doc.setFontSize(14); doc.setTextColor(212,175,55); doc.setFont('helvetica','bold');
  doc.text('Reporte de Asistencia ‚Äî '+ETIQ[_repFiltro], 105, 48, {align:'center'});
  doc.setFontSize(9); doc.setTextColor(100,100,100);
  doc.text('Total: '+lista.length+' miembros', 105, 55, {align:'center'});

  const rows = lista.map(s => [
    s.miembro.nombre,
    MINS[s.miembro.ministerio]||'-',
    s.presentes+'',
    s.ausentes+'',
    s.total+'',
    s.pct.toFixed(0)+'%',
    ETIQ[s.categoria]||'-',
    s.ultimaFecha ? fmtF(s.ultimaFecha) : 'Sin registro'
  ]);

  doc.autoTable({
    startY: 60,
    head: [['Nombre','Ministerio','Presentes','Ausentes','Total','%','Categor√≠a','√öltima visita']],
    body: rows,
    theme: 'grid',
    headStyles: {fillColor:[212,175,55], textColor:[0,0,0], fontStyle:'bold'},
    alternateRowStyles: {fillColor:[245,245,245]},
    styles: {fontSize:8},
    didParseCell: (d) => {
      if(d.section==='body' && d.column.index===6){
        const v = d.cell.raw;
        if(v==='Siempre asiste') d.cell.styles.textColor = [39,174,96];
        else if(v==='Frecuente')  d.cell.styles.textColor = [41,128,185];
        else if(v==='Ocasional')  d.cell.styles.textColor = [243,156,18];
        else if(v==='Casi nunca'||v==='No asiste') d.cell.styles.textColor = [231,76,60];
      }
    }
  });

  doc.save('Reporte_Asistencia_'+_repFiltro+'_'+new Date().toISOString().split('T')[0]+'.pdf');
  logAudit('EXPORT','PDF Reporte Asistencia: '+_repFiltro+' ('+lista.length+' registros)');
  toast('PDF exportado ‚Äî '+lista.length+' registros');
}

function exportarReporteActualExcel(){
  if(!puedeExportar('reportes')){ toast('Sin permiso de exportar','error'); return; }
  if(!_repData.length){ toast('Genera un reporte primero','error'); return; }

  const lista = _repFiltro === 'todos' ? [..._repData]
    : _repFiltro === 'seguimiento'
        ? _repData.filter(s => ['ocasional','casinunca','noasiste'].includes(s.categoria))
        : _repData.filter(s => s.categoria === _repFiltro);

  const ETIQ = {siempre:'Siempre asiste', frecuente:'Frecuente', ocasional:'Ocasional', casinunca:'Casi nunca', noasiste:'No asiste'};
  const BOM = '\uFEFF';
  let csv = BOM + 'Nombre,Ministerio,Estado,Tel,Presentes,Ausentes,Justificados,Total Sesiones,Porcentaje,Categor√≠a,√öltima Visita,D√≠as Sin Venir\n';
  lista.forEach(s => {
    csv += [
      '"'+s.miembro.nombre+'"',
      '"'+(MINS[s.miembro.ministerio]||'')+'"',
      '"'+(s.miembro.estado||'')+'"',
      '"'+(s.miembro.telefono||'')+'"',
      s.presentes, s.ausentes, s.justificados, s.total,
      s.pct.toFixed(1)+'%',
      '"'+(ETIQ[s.categoria]||'')+'"',
      '"'+(s.ultimaFecha?fmtF(s.ultimaFecha):'Sin registro')+'"',
      s.diasSinVenir < 999 ? s.diasSinVenir : 'Sin registro'
    ].join(',') + '\n';
  });
  dl(csv, 'Reporte_'+_repFiltro+'_'+new Date().toISOString().split('T')[0]+'.csv', 'text/csv');
  logAudit('EXPORT','Excel Reporte: '+_repFiltro+' ('+lista.length+' registros)');
  toast('Excel exportado ‚Äî '+lista.length+' registros');
}

function exportRepCSV(){ exportarReporteActualExcel(); }

// ===== PUBLICIDAD =====
const PLTS_DEF=[{id:'domingo-culto',n:'Domingo de Culto',c:['#cb2d3e','#ef473a']},{id:'discipulado',n:'Discipulado',c:['#0f0f0f','#2c2c2c']},{id:'bible-study',n:'Bible Study',c:['#0f0f0f','#d4af37']},{id:'adoracion',n:'Culto de Adoraci√≥n',c:['#1e3c72','#667eea']},{id:'evento-dorado',n:'Evento Especial',c:['#d4af37','#f4d03f']},{id:'jovenes',n:'J√≥venes',c:['#f12711','#f5af19']}];
function initPub(){document.getElementById('totAnu').textContent=anuncios.length;const c=document.getElementById('pltContainer');c.innerHTML=PLTS_DEF.map(p=>`<div class="pltc" onclick="selPltAbrir('${p.id}')"><div class="pltpv" style="background:linear-gradient(135deg,${p.c[0]},${p.c[1]})">${p.n}</div><div class="plti"><div class="pltn">${p.n}</div></div></div>`).join('')}
function selPltAbrir(id){document.getElementById('pltBase').value=id;openM('mAnuncio');setTimeout(()=>{cargarPlt();updPrev()},200)}
function initEditor(){const dc=document.getElementById('diasCont');dc.innerHTML=DIAS.map(d=>`<button class="dsb${d.id===diaPub?' activo':''}" onclick="selDia('${d.id}',this)">${d.n}</button>`).join('');const cc=document.getElementById('colorCont');cc.innerHTML=COLORES.map((c,i)=>`<div class="cls${JSON.stringify(colorPub)===JSON.stringify(c)?' activo':''}" style="background:linear-gradient(135deg,${c[0]},${c[1]})" onclick="selCol(${i},this)"></div>`).join('');updPrev()}
function selDia(d,btn){diaPub=d;document.querySelectorAll('.dsb').forEach(b=>b.classList.remove('activo'));btn.classList.add('activo')}
function selCol(i,el){colorPub=COLORES[i];document.querySelectorAll('.cls').forEach(s=>s.classList.remove('activo'));el.classList.add('activo');updPrev()}
function colPers2(){const c=document.getElementById('colPers').value;colorPub=[c,c];updPrev()}
function cargarPlt(){const v=document.getElementById('pltBase').value;const p=PLTS_DEF.find(x=>x.id===v);if(p){colorPub=p.c;document.querySelectorAll('.cls').forEach(s=>s.classList.remove('activo'));updPrev()}}
function cargarImgFondo(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{imgFondoD=ev.target.result;updPrev()};r.readAsDataURL(f)}
function cargarLogo(e){const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{logoD=ev.target.result;updPrev()};r.readAsDataURL(f)}
function updPrev(){const ca=document.getElementById('pvCanvas');if(!ca)return;const ctx=ca.getContext('2d');const w=580,h=435;ca.width=w;ca.height=h;const draw=()=>{ctx.fillStyle='rgba(0,0,0,0.28)';ctx.fillRect(0,0,w,h);ctx.strokeStyle='#d4af37';ctx.lineWidth=7;ctx.strokeRect(3,3,w-6,h-6);if(logoD){const li=new Image();li.onload=()=>{ctx.save();ctx.beginPath();ctx.arc(w/2,55,32,0,Math.PI*2);ctx.clip();ctx.drawImage(li,w/2-32,23,64,64);ctx.restore();drawTxt(ctx,w,h,105)};li.src=logoD}else drawTxt(ctx,w,h,35)};if(imgFondoD){const bi=new Image();bi.onload=()=>{ctx.drawImage(bi,0,0,w,h);draw()};bi.src=imgFondoD}else{const g=ctx.createLinearGradient(0,0,w,h);g.addColorStop(0,colorPub[0]||'#1e3c72');g.addColorStop(1,colorPub[1]||'#2a5298');ctx.fillStyle=g;ctx.fillRect(0,0,w,h);draw()}}
function drawTxt(ctx,w,h,yS){const al=document.getElementById('anAlin').value||'center';const xp=al==='center'?w/2:al==='left'?38:w-38;ctx.textAlign=al;ctx.font='bold 15px Georgia';ctx.fillStyle='#d4af37';ctx.fillText(config.nombreIglesia||'Centro Cristiano Sublime Gracia',xp,yS);const ti=document.getElementById('anTit').value||'T√≠tulo del Evento';const fn=document.getElementById('anFuente').value||'Georgia';ctx.font='bold 40px '+fn;ctx.fillStyle=document.getElementById('anColT').value||'#fff';ctx.shadowColor='rgba(0,0,0,0.75)';ctx.shadowBlur=11;ctx.fillText(ti,xp,yS+55);ctx.shadowBlur=0;const su=document.getElementById('anSub').value;if(su){ctx.font='bold 22px '+fn;ctx.fillStyle=document.getElementById('anColX').value||'#fff';ctx.fillText(su,xp,yS+90)}ctx.font='bold 18px Georgia';ctx.fillStyle='#d4af37';ctx.fillText(diaPub.toUpperCase(),xp,yS+135);const fe=document.getElementById('anFecha').value,ho=document.getElementById('anHora').value;if(fe||ho){ctx.font='16px Georgia';ctx.fillStyle='#fff';ctx.fillText((fe?fmtF(fe):'')+' '+(ho||''),xp,yS+162)}const hrs=document.getElementById('anHors').value;if(hrs){ctx.font='bold 14px Georgia';ctx.fillStyle='#d4af37';hrs.split(',').forEach((hs,i)=>ctx.fillText(hs.trim(),xp,yS+192+i*20))}const lu=document.getElementById('anLugar').value;if(lu){ctx.font='14px Georgia';ctx.fillStyle='#ccc';ctx.fillText('üìç '+lu,xp,yS+255)}const ve=document.getElementById('anVers').value,re=document.getElementById('anRef').value;if(ve){ctx.font='italic 12px Georgia';ctx.fillStyle='rgba(255,255,255,0.72)';ctx.fillText('"'+ve+'"',xp,h-52);if(re){ctx.font='bold 10px Georgia';ctx.fillStyle='#d4af37';ctx.fillText('‚Äî '+re,xp,h-36)}}const co=document.getElementById('anCont').value;if(co){ctx.font='11px Georgia';ctx.fillStyle='rgba(255,255,255,0.55)';ctx.fillText(co,xp,h-16)}}
function expJPG(){const ca=document.getElementById('pvCanvas');if(!ca)return;const l=document.createElement('a');l.download='anuncio_'+Date.now()+'.jpg';l.href=ca.toDataURL('image/jpeg',.9);l.click();toast('JPG exportado')}
function expPNG(){const ca=document.getElementById('pvCanvas');if(!ca)return;const l=document.createElement('a');l.download='anuncio_'+Date.now()+'.png';l.href=ca.toDataURL('image/png');l.click();toast('PNG exportado')}
async function guardarAnu(){const t=document.getElementById('anTit').value.trim();if(!t){toast('Ingrese un t√≠tulo','error');return}const ca=document.getElementById('pvCanvas');const a={id:'anu_'+Date.now(),titulo:t,subtitulo:document.getElementById('anSub').value,fecha:document.getElementById('anFecha').value,hora:document.getElementById('anHora').value,lugar:document.getElementById('anLugar').value,versiculo:document.getElementById('anVers').value,referencia:document.getElementById('anRef').value,contacto:document.getElementById('anCont').value,horarios:document.getElementById('anHors').value,dia:diaPub,colores:colorPub,preview:ca.toDataURL('image/jpeg',.55),creadoPor:usrActual.nombre,fc:new Date().toISOString()};await dbP('anuncios',a);anuncios.push(a);closeM('mAnuncio');initPub();toast('Anuncio guardado')}
function renderAnuG(){const c=document.getElementById('listaAnuG');if(!anuncios.length){c.innerHTML='<div class="empty"><div class="empty-ico">üì¢</div><div class="empty-txt">No hay anuncios guardados</div></div>';return}c.innerHTML=anuncios.slice().reverse().map((a,i)=>{const ri=anuncios.length-1-i;return`<div style="display:flex;gap:13px;align-items:center;padding:11px;border-bottom:1px solid rgba(255,255,255,.04)"><img src="${a.preview||''}" style="width:75px;height:56px;object-fit:cover;border-radius:7px;border:1px solid rgba(212,175,55,.18)"><div style="flex:1"><div style="font-weight:700;color:#fff;font-size:13px">${a.titulo}</div><div style="font-size:11px;color:#888">${fmtF(a.fecha)} ¬∑ ${a.creadoPor||''}</div></div><div style="display:flex;gap:5px"><button class="btn btn-e btn-xs" onclick="dlAnu(${ri})">üì∑</button><button class="btn btn-d btn-xs" onclick="delAnu(${ri})">üóëÔ∏è</button></div></div>`}).join('')}
function dlAnu(i){const a=anuncios[i];if(!a.preview)return;const l=document.createElement('a');l.href=a.preview;l.download=a.titulo+'.jpg';l.click()}
async function delAnu(i){if(!confirm('‚ö†Ô∏è ¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.'))return;await dbD('anuncios',anuncios[i].id);anuncios.splice(i,1);renderAnuG();initPub();toast('Anuncio eliminado')}

// ===== COMUNICACI√ìN =====
function envWA(){const m=document.getElementById('comMsg').value;if(!m.trim()){toast('Escriba un mensaje','error');return}window.open('https://wa.me/?text='+encodeURIComponent(m),'_blank')}
function envEmail(){const t=document.getElementById('comTit').value,m=document.getElementById('comMsg').value;if(!m.trim()){toast('Escriba un mensaje','error');return}window.open('mailto:?subject='+encodeURIComponent(t)+'&body='+encodeURIComponent(m),'_blank')}
function limpCom(){['comTit','comMsg'].forEach(id=>document.getElementById(id).value='');document.getElementById('comTipo').value='todos'}
function pltMsg(t){const msgs={bienvenida:{tit:'¬°Bienvenido a nuestra familia!',msg:'¬°Querido hermano/a! Es un honor tenerte como parte de nuestra familia en el Centro Cristiano Sublime Gracia de Dios. ¬°Que Dios te bendiga en este nuevo inicio! üôè‚úùÔ∏è'},culto:{tit:'Recordatorio Culto Dominical',msg:'üîî Este domingo te esperamos en el culto dominical. ¬°Ven y adora con nosotros! El Se√±or tiene algo especial para ti. ‚úùÔ∏è Centro Cristiano Sublime Gracia'},cumple:{tit:'¬°Feliz Cumplea√±os!',msg:'üéÇ ¬°Que este d√≠a est√© lleno de las bendiciones de Dios! Te deseamos un feliz cumplea√±os. ¬°Con amor, tu familia en Cristo! ‚úùÔ∏è'},oracion:{tit:'Cadena de Oraci√≥n',msg:'üôè Hermanos, los invitamos a unirse en oraci√≥n. "No se preocupen por nada; en cambio, oren por todo." ‚Äì Filipenses 4:6 ‚úùÔ∏è'}};const d=msgs[t];if(d){document.getElementById('comTit').value=d.tit;document.getElementById('comMsg').value=d.msg}}

// ===== ADMINISTRACI√ìN =====
/* reemplazado por sistema de permisos granulares */
/* reemplazado por sistema de permisos granulares */
/* reemplazado por sistema de permisos granulares */
/* reemplazado por sistema de permisos granulares */
/* reemplazado por sistema de permisos granulares */
function tabAdm(t,el){['usuarios','backup','config'].forEach(s=>{document.getElementById('adm'+s.charAt(0).toUpperCase()+s.slice(1)).style.display=s===t?'block':'none'});document.querySelectorAll('.tabs .tab').forEach(x=>x.classList.remove('activo'));el.classList.add('activo');if(t==='config'){cargarPoliticaPw();previewPolicy();}}
async function guardarCfg(){const c={clave:'general',nombreIglesia:document.getElementById('cfgNom').value,tel:document.getElementById('cfgTel').value,email:document.getElementById('cfgEmail').value,dir:document.getElementById('cfgDir').value,pastor:document.getElementById('cfgPas').value,horario:document.getElementById('cfgHor').value};await dbP('configuracion',c);config=c;logAudit('CONFIG','Configuraci√≥n del sistema actualizada');toast('Configuraci√≥n guardada')}

// ===== LOGO DE LA IGLESIA =====
function previsualizarLogo(e){
  const f=e.target.files[0];
  if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{
    const src=ev.target.result;
    // Preview login
    const pli=document.getElementById('prevLogoLoginImg');
    const plc=document.getElementById('prevLogoLoginCross');
    if(pli){pli.src=src;pli.style.display='block';if(plc)plc.style.display='none';}
    // Preview header
    const phi=document.getElementById('prevLogoHdrImg');
    const phc=document.getElementById('prevLogoHdrCross');
    if(phi){phi.src=src;phi.style.display='block';if(phc)phc.style.display='none';}
  };
  r.readAsDataURL(f);
}

async function guardarLogo(){
  const pli=document.getElementById('prevLogoLoginImg');
  if(!pli||!pli.src||pli.style.display==='none'){toast('Selecciona una imagen primero','error');return;}
  const src=pli.src;
  // Guardar en BD
  await dbP('configuracion',{clave:'logo',src});
  // Aplicar a los logos del sistema
  aplicarLogo(src);
  logAudit('CONFIG','Logo de la iglesia actualizado');
  toast('‚úÖ Logo guardado y aplicado');
}

async function eliminarLogo(){
  if(!confirm('¬øQuitar el logo personalizado?\nSe mostrar√° la cruz dorada por defecto.')) return;
  await dbP('configuracion',{clave:'logo',src:''});
  aplicarLogo('');
  // Limpiar previews
  ['prevLogoLoginImg','prevLogoHdrImg'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){el.src='';el.style.display='none';}
  });
  ['prevLogoLoginCross','prevLogoHdrCross'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='';
  });
  document.getElementById('cfgLogoFile').value='';
  toast('Logo eliminado');
}

function aplicarLogo(src){
  // Login logo
  const li=document.getElementById('loginLogoImg');
  const lc=document.getElementById('loginLogoCross');
  if(src){
    if(li){li.src=src;li.style.display='block';}
    if(lc) lc.style.display='none';
  } else {
    if(li){li.src='';li.style.display='none';}
    if(lc) lc.style.display='';
  }
  // Header logo
  const hi=document.getElementById('hdrLogoImg');
  const hc=document.getElementById('hdrLogoCross');
  if(src){
    if(hi){hi.src=src;hi.style.display='block';}
    if(hc) hc.style.display='none';
  } else {
    if(hi){hi.src='';hi.style.display='none';}
    if(hc) hc.style.display='';
  }
}

async function cargarLogoGuardado(){
  const logoCfg=await dbG('configuracion','logo');
  if(logoCfg&&logoCfg.src){
    aplicarLogo(logoCfg.src);
    // Llenar previews en la tab de config si est√°n visibles
    ['prevLogoLoginImg','prevLogoHdrImg'].forEach(id=>{
      const el=document.getElementById(id);
      if(el){el.src=logoCfg.src;el.style.display='block';}
    });
    ['prevLogoLoginCross','prevLogoHdrCross'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.display='none';
    });
  }
}

// ===== BACKUP =====
async function exportDB(){
  const d={v:'2.0',fecha:new Date().toISOString()};
  for(const s of['usuarios','miembros','finanzas','ninos','anuncios','eventos','visitas','celulas','oraciones','prestamos','asistencia','configuracion'])d[s]=await dbA(s);
  dl(JSON.stringify(d,null,2),'backup_sublimegracia_'+new Date().toISOString().split('T')[0]+'.json','application/json');
  logAudit('EXPORT','Exportar base de datos completa');toast('Copia exportada correctamente');
}
function importDB(){document.getElementById('impFile').click()}
async function procImport(e){
  const f=e.target.files[0];if(!f)return;
  if(!confirm('‚ö†Ô∏è Esto reemplazar√° TODOS los datos. ¬øContinuar?')){e.target.value='';return}
  const r=new FileReader();
  r.onload=async ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      _db={};
      for(const s of['usuarios','miembros','finanzas','ninos','anuncios','eventos','visitas','celulas','oraciones','prestamos','asistencia','configuracion']){
        if(d[s]) _db[s]=d[s];
      }
      await _dbSave();
      toast('Importado correctamente. Recargando...');
      setTimeout(()=>location.reload(),1500);
    }catch(err){toast('Error al importar: '+err.message,'error')}
  };
  r.readAsText(f);e.target.value='';
}

async function abrirCarpetaBD(){
  try{ await fetch('/api/open-folder'); toast('Carpeta abierta en el Explorador'); }
  catch(e){ toast('No se pudo abrir la carpeta','error'); }
}

async function cargarRutaBD(){
  try{
    const r = await fetch('/api/db-path');
    const d = await r.json();

    // Actualizar textos de estado
    const el = document.getElementById('bdRutaTexto');
    if(el) el.textContent = d.file;
    document.getElementById('dbRuta') && (document.getElementById('dbRuta').textContent = d.file);

    // Detectar tipo de servicio por la ruta
    const ruta = (d.dir || '').toLowerCase();
    let icono = 'üíæ', nombre = 'Local (Documentos)';
    if(ruta.includes('google drive') || ruta.includes('my drive') || ruta.includes('mi unidad')){
      icono = 'üü¢'; nombre = 'Google Drive';
    } else if(ruta.includes('onedrive')){ icono = 'üîµ'; nombre = 'OneDrive'; }
    else if(ruta.includes('mega'))       { icono = 'üî¥'; nombre = 'MEGA'; }
    else if(ruta.includes('dropbox'))    { icono = 'üü¶'; nombre = 'Dropbox'; }
    else if(ruta.includes('desktop') || ruta.includes('escritorio')){ icono = 'üñ•Ô∏è'; nombre = 'Escritorio'; }

    const nomEl = document.getElementById('bdEstadoNombre');
    const icoEl = document.getElementById('bdEstadoIcono');
    if(nomEl) nomEl.textContent = nombre + ' ‚Äî Base de datos activa';
    if(icoEl) icoEl.textContent = icono;

    // Precargar input con ruta actual
    const inp = document.getElementById('nuevaRutaBD');
    if(inp && !inp.value) inp.value = d.dir;

    // Renderizar tarjetas de nube detectadas
    if(d.nube && d.nube.length > 0) renderNubeDetectada(d.nube, d.dir);
    else {
      const nc = document.getElementById('nubeDetectada');
      if(nc) nc.innerHTML = '<div style="color:#555;font-size:11px;padding:8px">No se detectaron servicios de nube instalados en esta PC.<br>Instala Google Drive, OneDrive, MEGA o Dropbox y reinicia el sistema.</div>';
    }

    // Verificar estado de sincronizaci√≥n
    verificarSync();
  } catch(e){ console.error('Error cargando ruta:', e); }
}

function renderNubeDetectada(nubes, rutaActual){
  const c = document.getElementById('nubeDetectada');
  if(!c) return;
  c.innerHTML = nubes.map(n => {
    const esActual = n.ruta === rutaActual;
    return `<div style="background:${esActual?'rgba(212,175,55,.1)':'rgba(255,255,255,.04)'};border:${esActual?'2px solid rgba(212,175,55,.5)':'1px solid rgba(255,255,255,.08)'};border-radius:9px;padding:11px;cursor:pointer;transition:all .2s" 
      onclick="seleccionarRutaNube('${n.ruta.replace(/\\/g,'\\\\')}')" 
      onmouseover="this.style.borderColor='rgba(212,175,55,.3)'"
      onmouseout="this.style.borderColor='${esActual?'rgba(212,175,55,.5)':'rgba(255,255,255,.08)'}'">
      <div style="font-size:18px;margin-bottom:4px">${n.icono}</div>
      <div style="font-weight:700;color:${esActual?'#d4af37':'#fff'};font-size:12px">${n.nombre} ${esActual?'‚úì (actual)':''}</div>
      <div style="font-size:9px;color:#666;margin-top:3px;font-family:monospace;word-break:break-all">${n.ruta}</div>
    </div>`;
  }).join('');
}

function seleccionarRutaNube(ruta){
  const inp = document.getElementById('nuevaRutaBD');
  if(inp){ inp.value = ruta; inp.focus(); }
  toast('Ruta seleccionada. Presiona "Aplicar nueva ruta" para confirmar.', 'info');
}

async function verificarSync(){
  try{
    const r = await fetch('/api/sync-status');
    const d = await r.json();
    const el = document.getElementById('bdSyncEstado');
    if(!el) return;
    if(!d.ok){ el.textContent = '‚ö†Ô∏è Error al verificar archivo'; el.style.color='#e74c3c'; return; }
    if(d.status === 'vacio'){ el.textContent = 'üÜï Base de datos nueva (sin datos a√∫n)'; el.style.color='#f39c12'; return; }
    const hace = d.haceSegundos;
    const tam  = (d.tamanio/1024).toFixed(1)+'KB';
    if(hace < 60)       { el.textContent = '‚úÖ Sincronizado hace '+hace+' seg ¬∑ '+tam; el.style.color='#27ae60'; }
    else if(hace < 3600){ el.textContent = 'üîÑ √öltima actualizaci√≥n hace '+Math.floor(hace/60)+' min ¬∑ '+tam; el.style.color='#2980b9'; }
    else                { el.textContent = '‚ö†Ô∏è Sin cambios desde hace '+Math.floor(hace/3600)+' horas ¬∑ '+tam; el.style.color='#f39c12'; }
  } catch(e){}
}

async function cambiarRutaBD(){
  const nuevaRuta = document.getElementById('nuevaRutaBD').value.trim();
  if(!nuevaRuta){ toast('Ingrese una ruta v√°lida','error'); return; }
  if(!confirm('¬øCambiar la base de datos a:\n' + nuevaRuta + '\n\nLos datos actuales se copiar√°n a la nueva ubicaci√≥n.')) return;
  try{
    toast('Cambiando ruta...','info');
    const r = await fetch('/api/db-path',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({dir: nuevaRuta})
    });
    const d = await r.json();
    if(d.ok){
      logAudit('CONFIG','Base de datos movida a: '+nuevaRuta);
      toast('‚úÖ Ruta cambiada. Recargando...');
      setTimeout(()=>location.reload(), 1500);
    } else {
      toast('Error: '+(d.error||'No se pudo cambiar la ruta'),'error');
    }
  } catch(e){ toast('Error de conexi√≥n','error'); }
}

function respLocal(){const d={miembros,finanzas,ninos,eventos,visitas,celulas,oraciones,prestamos};localStorage.setItem('backup_'+new Date().toISOString().split('T')[0],JSON.stringify(d));toast('Respaldo local guardado')}
async function limpiarTodo(){if(!confirm('‚ö†Ô∏è PELIGRO: ¬øEliminar TODOS los datos?')||!confirm('Segunda confirmaci√≥n: ¬øSeguro?'))return;for(const s of['miembros','finanzas','ninos','anuncios','eventos','visitas','celulas','oraciones','prestamos','asistencia']){const all=await dbA(s);for(const it of all)await dbD(s,it.id||it.fecha).catch(()=>{})}toast('Datos eliminados');setTimeout(()=>location.reload(),1500)}

// ===== UTILS =====
function fmtF(f){if(!f)return'-';const p=f.substring(0,10).split('-');return p[2]+'/'+p[1]+'/'+p[0]}
// Formatea montos de manera amigable para iglesia (sin centavos si es entero)
function fmtM(m){
  const n=parseFloat(m)||0;
  if(Number.isInteger(n)) return '$'+n.toLocaleString('es-DO');
  return '$'+n.toLocaleString('es-DO',{minimumFractionDigits:2,maximumFractionDigits:2});
}
function dl(c,n,t){const b=new Blob([c],{type:t});const l=document.createElement('a');l.href=URL.createObjectURL(b);l.download=n;l.click()}

// ================================================================
// SEGMENTACI√ìN DE ROLES
// ================================================================
const PERMISOS = {
  administrador: ['dashboard','calendario','membresia','visitas','celulas','ninos','oracion','asistencia','finanzas','prestamos','reportes','publicidad','comunicacion','auditoria','admin'],
  pastor:        ['dashboard','calendario','membresia','visitas','celulas','ninos','oracion','asistencia','finanzas','prestamos','reportes','publicidad','comunicacion'],
  tesorero:      ['dashboard','finanzas','prestamos','reportes','membresia'],
  secretario:    ['dashboard','calendario','membresia','visitas','asistencia','comunicacion','reportes'],
  lider:         ['dashboard','calendario','celulas','asistencia','oracion','comunicacion'],
  voluntario:    ['dashboard','calendario','oracion']
};

function aplicarRol(rol){
  const permitidos = PERMISOS[rol] || PERMISOS['voluntario'];
  // Ocultar todos los nav items primero
  document.querySelectorAll('.ni[id^="nav-"]').forEach(el=>{
    const modulo = el.id.replace('nav-','');
    el.style.display = permitidos.includes(modulo) ? '' : 'none';
  });
}

function puedeAcceder(modulo){
  if(!usrActual) return false;
  const permitidos = PERMISOS[usrActual.rol] || [];
  return permitidos.includes(modulo);
}

// ================================================================
// AUDITOR√çA / LOG DEL SISTEMA
// ================================================================
let auditLog = [];

async function cargarAudit(){
  auditLog = (await dbA('auditoria')) || [];
}

async function logAudit(accion, detalle){
  if(!usrActual) return;
  const entrada = {
    id: 'log_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),
    fecha: new Date().toISOString(),
    usuario: usrActual.nombre,
    usuarioId: usrActual.id,
    rol: usrActual.rol,
    accion,
    detalle: detalle || ''
  };
  auditLog.push(entrada);
  await dbP('auditoria', entrada);
}

async function logAuditFail(usuario, detalle){
  const entrada = {
    id: 'log_'+Date.now()+'_'+Math.random().toString(36).substr(2,5),
    fecha: new Date().toISOString(),
    usuario: usuario || 'desconocido',
    usuarioId: null,
    rol: '-',
    accion: 'FAIL_LOGIN',
    detalle: detalle || 'Contrase√±a incorrecta'
  };
  auditLog.push(entrada);
  await dbP('auditoria', entrada);
}

function renderAudit(){
  const filtUser = document.getElementById('audFiltroUser')?.value || '';
  const filtAcc  = document.getElementById('audFiltroAcc')?.value  || '';
  const tb = document.getElementById('tbAudit');
  if(!tb) return;

  let logs = [...auditLog].reverse();
  if(filtUser) logs = logs.filter(l => l.usuario === filtUser);
  if(filtAcc)  logs = logs.filter(l => l.accion  === filtAcc);

  const COLOR = {LOGIN:'#27ae60',LOGOUT:'#e74c3c',CREATE:'#2980b9',UPDATE:'#f39c12',DELETE:'#e74c3c',EXPORT:'#8e44ad',IMPORT:'#16a085',CONFIG:'#d4af37',FAIL_LOGIN:'#e74c3c',DEFAULT:'#888'};
  tb.innerHTML = logs.slice(0,200).map(l=>{
    const c = COLOR[l.accion] || COLOR.DEFAULT;
    const fecha = new Date(l.fecha).toLocaleString('es-ES');
    return `<tr>
      <td style="color:#aaa;font-size:11px;white-space:nowrap">${fecha}</td>
      <td style="font-weight:700;color:#fff">${l.usuario}</td>
      <td><span class="badge bvol">${l.rol}</span></td>
      <td><span style="color:${c};font-weight:700;font-size:10px">${l.accion}</span></td>
      <td style="color:#aaa;font-size:11px">${l.detalle}</td>
    </tr>`;
  }).join('') || '<tr><td colspan="5" style="text-align:center;color:#555;padding:20px">No hay registros</td></tr>';

  // Poblar filtro de usuarios
  const sel = document.getElementById('audFiltroUser');
  if(sel && sel.options.length <= 1){
    const users = [...new Set(auditLog.map(l=>l.usuario))];
    users.forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; sel.appendChild(o); });
  }
}

async function limpiarAudit(){
  if(!confirm('¬øEliminar todo el registro de auditor√≠a?')) return;
  const all = await dbA('auditoria');
  for(const e of all) await dbD('auditoria', e.id);
  auditLog = [];
  renderAudit();
  toast('Registro de auditor√≠a limpiado');
}

// ================================================================
// POL√çTICA DE CONTRASE√ëA CONFIGURABLE
// ================================================================

// Pol√≠tica activa ‚Äî se carga desde BD al iniciar
let _pwPolicy = {
  minLen:      8,
  maxLen:      32,
  reqUpper:    true,
  reqLower:    true,
  reqNum:      true,
  reqSym:      false,
  noSpaces:    true,
  noRepeat:    false,
  maxIntentos: 5,
  minBloqueo:  5
};

async function cargarPoliticaPw(){
  try{
    const p = await dbG('configuracion','pwpolicy');
    if(p) _pwPolicy = {..._pwPolicy,...p};
  }catch(e){}
  // Aplicar valores a los controles
  const set = (id,val) => { const el=document.getElementById(id); if(el) el.value=val; };
  const setc = (id,val) => { const el=document.getElementById(id); if(el) el.checked=val; };
  const setn = (id,val) => { const el=document.getElementById(id); if(el) el.textContent=val; };
  set('pwMinLen',    _pwPolicy.minLen);      setn('pwMinLenVal',    _pwPolicy.minLen);
  set('pwMaxLen',    _pwPolicy.maxLen);      setn('pwMaxLenVal',    _pwPolicy.maxLen);
  setc('pwReqUpper', _pwPolicy.reqUpper);
  setc('pwReqLower', _pwPolicy.reqLower);
  setc('pwReqNum',   _pwPolicy.reqNum);
  setc('pwReqSym',   _pwPolicy.reqSym);
  setc('pwNoSpaces', _pwPolicy.noSpaces);
  setc('pwNoRepeat', _pwPolicy.noRepeat);
  set('pwMaxIntentos', _pwPolicy.maxIntentos); setn('pwMaxIntentosVal', _pwPolicy.maxIntentos);
  set('pwMinBloqueo',  _pwPolicy.minBloqueo);  setn('pwMinBloqueoVal',  _pwPolicy.minBloqueo);
  previewPolicy();
}

async function guardarPoliticaPw(){
  _pwPolicy = {
    clave:       'pwpolicy',
    minLen:      parseInt(document.getElementById('pwMinLen').value),
    maxLen:      parseInt(document.getElementById('pwMaxLen').value),
    reqUpper:    document.getElementById('pwReqUpper').checked,
    reqLower:    document.getElementById('pwReqLower').checked,
    reqNum:      document.getElementById('pwReqNum').checked,
    reqSym:      document.getElementById('pwReqSym').checked,
    noSpaces:    document.getElementById('pwNoSpaces').checked,
    noRepeat:    document.getElementById('pwNoRepeat').checked,
    maxIntentos: parseInt(document.getElementById('pwMaxIntentos').value),
    minBloqueo:  parseInt(document.getElementById('pwMinBloqueo').value)
  };
  await dbP('configuracion', _pwPolicy);
  logAudit('CONFIG','Pol√≠tica de contrase√±as actualizada');
  toast('Pol√≠tica de contrase√±as guardada');
  previewPolicy();
}

function previewPolicy(){
  const pol = {
    minLen:   parseInt(document.getElementById('pwMinLen')?.value || _pwPolicy.minLen),
    maxLen:   parseInt(document.getElementById('pwMaxLen')?.value || _pwPolicy.maxLen),
    reqUpper: document.getElementById('pwReqUpper')?.checked ?? _pwPolicy.reqUpper,
    reqLower: document.getElementById('pwReqLower')?.checked ?? _pwPolicy.reqLower,
    reqNum:   document.getElementById('pwReqNum')?.checked   ?? _pwPolicy.reqNum,
    reqSym:   document.getElementById('pwReqSym')?.checked   ?? _pwPolicy.reqSym,
    noSpaces: document.getElementById('pwNoSpaces')?.checked ?? _pwPolicy.noSpaces,
    noRepeat: document.getElementById('pwNoRepeat')?.checked ?? _pwPolicy.noRepeat,
  };
  const reqs = [];
  reqs.push('‚úÖ Entre '+pol.minLen+' y '+pol.maxLen+' caracteres');
  if(pol.reqUpper) reqs.push('‚úÖ Al menos una may√∫scula (A-Z)');
  if(pol.reqLower) reqs.push('‚úÖ Al menos una min√∫scula (a-z)');
  if(pol.reqNum)   reqs.push('‚úÖ Al menos un n√∫mero (0-9)');
  if(pol.reqSym)   reqs.push('‚úÖ Al menos un s√≠mbolo (!@#$%...)');
  if(pol.noSpaces) reqs.push('üö´ Sin espacios');
  if(pol.noRepeat) reqs.push('üö´ Sin 3 caracteres iguales consecutivos');
  const el = document.getElementById('pwPolicyList');
  if(el) el.innerHTML = reqs.join('<br>');
}

function validarPassword(pw){
  const p = _pwPolicy;
  const errores = [];
  if(pw.length < p.minLen)    errores.push('M√≠nimo '+p.minLen+' caracteres (tienes '+pw.length+')');
  if(pw.length > p.maxLen)    errores.push('M√°ximo '+p.maxLen+' caracteres');
  if(p.reqUpper && !/[A-Z]/.test(pw))        errores.push('Al menos una letra may√∫scula');
  if(p.reqLower && !/[a-z]/.test(pw))        errores.push('Al menos una letra min√∫scula');
  if(p.reqNum   && !/[0-9]/.test(pw))        errores.push('Al menos un n√∫mero');
  if(p.reqSym   && !/[^A-Za-z0-9]/.test(pw)) errores.push('Al menos un s√≠mbolo (!@#$%...)');
  if(p.noSpaces && /\s/.test(pw))            errores.push('No se permiten espacios');
  if(p.noRepeat && /(.)\1\1/.test(pw))      errores.push('No repitas el mismo car√°cter 3 veces seguidas');
  return errores;
}

function mostrarIndicadorPw(inputId, indicadorId){
  const pw  = document.getElementById(inputId)?.value || '';
  const ind = document.getElementById(indicadorId);
  if(!ind || !pw) return;
  const errores = validarPassword(pw);
  const total   = [
    _pwPolicy.reqUpper, _pwPolicy.reqLower, _pwPolicy.reqNum,
    _pwPolicy.reqSym, _pwPolicy.noSpaces, true, true
  ].filter(Boolean).length;
  const cumple  = total - errores.length;
  const fuerza  = Math.min(5, Math.round(cumple / total * 5));
  const colores = ['#e74c3c','#e74c3c','#f39c12','#f39c12','#27ae60','#27ae60'];
  const labels  = ['Muy d√©bil','D√©bil','Regular','Aceptable','Fuerte','Muy fuerte'];
  ind.innerHTML = `
    <div style="display:flex;gap:3px;margin-top:5px">
      ${[1,2,3,4,5].map(i=>`<div style="flex:1;height:4px;border-radius:2px;background:${i<=fuerza?colores[fuerza]:'#333'}"></div>`).join('')}
    </div>
    <div style="font-size:10px;color:${colores[fuerza]};margin-top:3px">${labels[fuerza]}${errores.length?' ‚Äî '+errores[0]:' ‚úì Cumple todos los requisitos'}</div>`;
}

// ================================================================
// GENERACI√ìN DE REPORTES EN PDF
// ================================================================
function getPDFBase(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const cfg = config || {};
  // Encabezado
  doc.setFillColor(20,20,20);
  doc.rect(0,0,210,32,'F');
  doc.setTextColor(212,175,55);
  doc.setFontSize(16);
  doc.setFont('helvetica','bold');
  doc.text(cfg.nombreIglesia||'Centro Cristiano Sublime Gracia', 105, 13, {align:'center'});
  doc.setFontSize(9);
  doc.setTextColor(150,150,150);
  doc.text((cfg.dir||'')+'  '+( cfg.tel||''), 105, 20, {align:'center'});
  doc.setDrawColor(212,175,55);
  doc.setLineWidth(0.5);
  doc.line(10,32,200,32);
  doc.setTextColor(80,80,80);
  doc.setFontSize(8);
  doc.text('Generado: '+new Date().toLocaleString('es-ES')+' | Usuario: '+(usrActual?.nombre||''), 10, 38);
  return doc;
}

function exportPDF_Miembros(){
  if(!puedeAcceder('membresia')){ toast('Sin permiso','error'); return; }
  const doc = getPDFBase();
  doc.setFontSize(14); doc.setTextColor(212,175,55); doc.setFont('helvetica','bold');
  doc.text('Reporte de Miembros', 105, 48, {align:'center'});
  const rows = miembros.map(m=>[m.nombre, m.telefono||'-', m.estadoCivil||'-', m.ministerio||'-', m.estado==='activo'?'Activo':'Inactivo']);
  doc.autoTable({ startY:55, head:[['Nombre','Tel√©fono','Est. Civil','Ministerio','Estado']], body:rows, theme:'grid', headStyles:{fillColor:[212,175,55],textColor:[0,0,0],fontStyle:'bold'}, alternateRowStyles:{fillColor:[245,245,245]}, styles:{fontSize:9} });
  doc.save('Reporte_Miembros_'+new Date().toISOString().split('T')[0]+'.pdf');
  logAudit('EXPORT','PDF Miembros ('+miembros.length+' registros)');
  toast('PDF de miembros generado');
}

function exportPDF_Finanzas(){
  if(!puedeAcceder('finanzas')){ toast('Sin permiso','error'); return; }
  const doc = getPDFBase();
  doc.setFontSize(14); doc.setTextColor(212,175,55); doc.setFont('helvetica','bold');
  doc.text('Reporte Financiero', 105, 48, {align:'center'});
  // Resumen
  const ingresos = finanzas.filter(f=>f.tipo!=='gasto').reduce((a,f)=>a+f.monto,0);
  const gastos   = finanzas.filter(f=>f.tipo==='gasto').reduce((a,f)=>a+f.monto,0);
  doc.setFontSize(11); doc.setTextColor(40,40,40);
  doc.text('Ingresos totales: $'+ingresos.toFixed(2), 15, 56);
  doc.text('Gastos totales:   $'+gastos.toFixed(2),   15, 63);
  doc.text('Balance:          $'+(ingresos-gastos).toFixed(2), 15, 70);
  const rows = finanzas.slice(-100).map(f=>[f.fecha, f.tipo, f.miembroNombre||'-', '$'+f.monto.toFixed(2), f.metodo||'-', f.descripcion||'-']);
  doc.autoTable({ startY:77, head:[['Fecha','Tipo','Miembro','Monto','M√©todo','Descripci√≥n']], body:rows, theme:'grid', headStyles:{fillColor:[212,175,55],textColor:[0,0,0],fontStyle:'bold'}, alternateRowStyles:{fillColor:[245,245,245]}, styles:{fontSize:8} });
  doc.save('Reporte_Finanzas_'+new Date().toISOString().split('T')[0]+'.pdf');
  logAudit('EXPORT','PDF Finanzas');
  toast('PDF financiero generado');
}

function exportPDF_Asistencia(){
  if(!puedeAcceder('asistencia')){ toast('Sin permiso','error'); return; }
  const doc = getPDFBase();
  doc.setFontSize(14); doc.setTextColor(212,175,55); doc.setFont('helvetica','bold');
  doc.text('Reporte de Asistencia', 105, 48, {align:'center'});
  const fechas = Object.keys(asistData).sort().slice(-20);
  const rows = miembros.map(m=>{
    const fila = [m.nombre];
    fechas.forEach(f=>{ const est=asistData[f]?.[m.id]||'-'; fila.push(est==='presente'?'P':est==='ausente'?'A':est==='justificado'?'J':'-'); });
    return fila;
  });
  doc.autoTable({ startY:55, head:[['Miembro',...fechas.map(f=>f.slice(5))]], body:rows, theme:'grid', headStyles:{fillColor:[212,175,55],textColor:[0,0,0],fontStyle:'bold'}, styles:{fontSize:7} });
  doc.save('Reporte_Asistencia_'+new Date().toISOString().split('T')[0]+'.pdf');
  logAudit('EXPORT','PDF Asistencia');
  toast('PDF de asistencia generado');
}

function exportPDF_Prestamos(){
  if(!puedeAcceder('prestamos')){ toast('Sin permiso','error'); return; }
  const doc = getPDFBase();
  doc.setFontSize(14); doc.setTextColor(212,175,55); doc.setFont('helvetica','bold');
  doc.text('Reporte de Pr√©stamos', 105, 48, {align:'center'});
  const rows = prestamos.map(p=>[p.miembroNombre, '$'+p.monto.toFixed(2), p.fecha, p.vencimiento||'-', p.motivo||'-', p.estado==='pagado'?'Pagado':'Activo']);
  doc.autoTable({ startY:55, head:[['Miembro','Monto','Fecha','Vencimiento','Motivo','Estado']], body:rows, theme:'grid', headStyles:{fillColor:[212,175,55],textColor:[0,0,0],fontStyle:'bold'}, alternateRowStyles:{fillColor:[245,245,245]}, styles:{fontSize:9} });
  doc.save('Reporte_Prestamos_'+new Date().toISOString().split('T')[0]+'.pdf');
  logAudit('EXPORT','PDF Pr√©stamos');
  toast('PDF de pr√©stamos generado');
}

function exportAuditPDF(){
  const doc = getPDFBase();
  doc.setFontSize(14); doc.setTextColor(212,175,55); doc.setFont('helvetica','bold');
  doc.text('Registro de Auditor√≠a', 105, 48, {align:'center'});
  const rows = [...auditLog].reverse().slice(0,200).map(l=>[
    new Date(l.fecha).toLocaleString('es-ES'), l.usuario, l.rol, l.accion, (l.detalle||'').substring(0,60)
  ]);
  doc.autoTable({ startY:55, head:[['Fecha','Usuario','Rol','Acci√≥n','Detalle']], body:rows, theme:'grid', headStyles:{fillColor:[212,175,55],textColor:[0,0,0],fontStyle:'bold'}, styles:{fontSize:7} });
  doc.save('Auditoria_'+new Date().toISOString().split('T')[0]+'.pdf');
  toast('PDF de auditor√≠a generado');
}


// ================================================================
// SISTEMA DE PERMISOS GRANULARES POR USUARIO
// ================================================================

// Definici√≥n de todos los m√≥dulos con sus acciones posibles
const MODULOS_DEF = [
  {id:'dashboard',   ico:'üìä', nombre:'Dashboard',      acciones:['ver']},
  {id:'calendario',  ico:'üìÖ', nombre:'Calendario',     acciones:['ver','crear','editar','eliminar']},
  {id:'membresia',   ico:'üë•', nombre:'Miembros',       acciones:['ver','crear','editar','eliminar','exportar']},
  {id:'visitas',     ico:'üëÅÔ∏è', nombre:'Visitas',        acciones:['ver','crear','editar','eliminar']},
  {id:'celulas',     ico:'üè†', nombre:'C√©lulas',        acciones:['ver','crear','editar','eliminar']},
  {id:'ninos',       ico:'üë∂', nombre:'√Årea Infantil',  acciones:['ver','crear','editar','eliminar']},
  {id:'oracion',     ico:'üôè', nombre:'Peticiones',     acciones:['ver','crear','editar','eliminar']},
  {id:'asistencia',  ico:'üìã', nombre:'Asistencia',     acciones:['ver','crear','exportar']},
  {id:'finanzas',    ico:'üí∞', nombre:'Finanzas',       acciones:['ver','crear','eliminar','exportar']},
  {id:'prestamos',   ico:'üí≥', nombre:'Pr√©stamos',      acciones:['ver','crear','editar','eliminar','exportar']},
  {id:'reportes',    ico:'üìà', nombre:'Reportes',       acciones:['ver','exportar']},
  {id:'publicidad',  ico:'üì¢', nombre:'Publicidad',     acciones:['ver','crear','eliminar']},
  {id:'comunicacion',ico:'üìß', nombre:'Comunicaci√≥n',   acciones:['ver','crear']},
  {id:'auditoria',   ico:'üîç', nombre:'Auditor√≠a',      acciones:['ver','exportar']},
  {id:'admin',       ico:'‚öôÔ∏è', nombre:'Administraci√≥n', acciones:['ver','crear','editar','eliminar']},
];

// Permisos por defecto seg√∫n rol
const PERMISOS_ROL = {
  administrador: {
    dashboard:{ver:true}, calendario:{ver:true,crear:true,editar:true,eliminar:true},
    membresia:{ver:true,crear:true,editar:true,eliminar:true,exportar:true},
    visitas:{ver:true,crear:true,editar:true,eliminar:true},
    celulas:{ver:true,crear:true,editar:true,eliminar:true},
    ninos:{ver:true,crear:true,editar:true,eliminar:true},
    oracion:{ver:true,crear:true,editar:true,eliminar:true},
    asistencia:{ver:true,crear:true,exportar:true},
    finanzas:{ver:true,crear:true,eliminar:true,exportar:true},
    prestamos:{ver:true,crear:true,editar:true,eliminar:true,exportar:true},
    reportes:{ver:true,exportar:true}, publicidad:{ver:true,crear:true,eliminar:true},
    comunicacion:{ver:true,crear:true}, auditoria:{ver:true,exportar:true},
    admin:{ver:true,crear:true,editar:true,eliminar:true}
  },
  pastor: {
    dashboard:{ver:true}, calendario:{ver:true,crear:true,editar:true,eliminar:true},
    membresia:{ver:true,crear:true,editar:true,exportar:true},
    visitas:{ver:true,crear:true,editar:true}, celulas:{ver:true,crear:true,editar:true},
    ninos:{ver:true,crear:true,editar:true}, oracion:{ver:true,crear:true,editar:true,eliminar:true},
    asistencia:{ver:true,crear:true,exportar:true},
    finanzas:{ver:true,exportar:true}, prestamos:{ver:true,exportar:true},
    reportes:{ver:true,exportar:true}, publicidad:{ver:true,crear:true,eliminar:true},
    comunicacion:{ver:true,crear:true}
  },
  tesorero: {
    dashboard:{ver:true}, membresia:{ver:true},
    finanzas:{ver:true,crear:true,eliminar:true,exportar:true},
    prestamos:{ver:true,crear:true,editar:true,eliminar:true,exportar:true},
    reportes:{ver:true,exportar:true}
  },
  secretario: {
    dashboard:{ver:true}, calendario:{ver:true,crear:true,editar:true},
    membresia:{ver:true,crear:true,editar:true,exportar:true},
    visitas:{ver:true,crear:true,editar:true},
    asistencia:{ver:true,crear:true,exportar:true},
    comunicacion:{ver:true,crear:true}, reportes:{ver:true,exportar:true}
  },
  lider: {
    dashboard:{ver:true}, calendario:{ver:true},
    celulas:{ver:true,editar:true}, asistencia:{ver:true,crear:true},
    oracion:{ver:true,crear:true}, comunicacion:{ver:true}
  },
  voluntario: {
    dashboard:{ver:true}, calendario:{ver:true}, oracion:{ver:true,crear:true}
  }
};

// Renderizar la grilla de permisos en el formulario
function renderPermisosGrid(permisosActuales){
  const grid = document.getElementById('permisosGrid');
  if(!grid) return;
  grid.innerHTML = MODULOS_DEF.map(mod => {
    const mp = permisosActuales?.[mod.id] || {};
    const tieneAlgo = Object.values(mp).some(v=>v);
    return `<div class="perm-card${tieneAlgo?' activo':''}" id="pcard-${mod.id}">
      <div class="perm-header">
        <span class="perm-title">${mod.ico} ${mod.nombre}</span>
        <label style="display:flex;align-items:center;gap:4px;cursor:pointer;font-size:10px;color:#888">
          <input type="checkbox" ${tieneAlgo?'checked':''} onchange="toggleModuloCompleto('${mod.id}',this.checked)" style="accent-color:#d4af37"> Acceso
        </label>
      </div>
      <div class="perm-sub">
        ${mod.acciones.map(a=>`
          <button class="perm-btn ${a}${mp[a]?' on':''}" 
            onclick="togglePermiso('${mod.id}','${a}',this)"
            title="${a}">${a==='ver'?'üëÅ Ver':a==='crear'?'‚ûï Crear':a==='editar'?'‚úèÔ∏è Editar':a==='eliminar'?'üóë Eliminar':'üì§ Exportar'}
          </button>`).join('')}
      </div>
    </div>`;
  }).join('');
}

function togglePermiso(modulo, accion, btn){
  btn.classList.toggle('on');
  // Actualizar card activo
  const card = document.getElementById('pcard-'+modulo);
  if(card){
    const tieneAlgo = card.querySelectorAll('.perm-btn.on').length > 0;
    card.classList.toggle('activo', tieneAlgo);
    const cb = card.querySelector('input[type=checkbox]');
    if(cb) cb.checked = tieneAlgo;
  }
}

function toggleModuloCompleto(modulo, activo){
  const card = document.getElementById('pcard-'+modulo);
  if(!card) return;
  card.querySelectorAll('.perm-btn').forEach(btn=>{
    if(activo) btn.classList.add('on'); else btn.classList.remove('on');
  });
  card.classList.toggle('activo', activo);
}

function marcarTodosPermisos(activo){
  MODULOS_DEF.forEach(mod => toggleModuloCompleto(mod.id, activo));
}

function cargarPermisosPorRol(){
  const rol = document.getElementById('admRol')?.value || 'voluntario';
  const permisos = PERMISOS_ROL[rol] || {};
  renderPermisosGrid(permisos);
}

// Leer permisos actuales del grid como objeto
function leerPermisosDelGrid(){
  const permisos = {};
  MODULOS_DEF.forEach(mod => {
    const card = document.getElementById('pcard-'+mod.id);
    if(!card) return;
    const mp = {};
    mod.acciones.forEach(a => {
      const btn = card.querySelector('.perm-btn.'+a);
      if(btn) mp[a] = btn.classList.contains('on');
    });
    if(Object.values(mp).some(v=>v)) permisos[mod.id] = mp;
  });
  return permisos;
}

// ‚îÄ‚îÄ APLICAR PERMISOS AL USUARIO LOGUEADO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aplicarRol(rol, permisosCustom){
  // Si tiene permisos personalizados, usar esos; si no, usar los del rol
  const permisos = (permisosCustom && Object.keys(permisosCustom).length > 0)
    ? permisosCustom
    : (PERMISOS_ROL[rol] || PERMISOS_ROL['voluntario']);

  // Guardar en variable global para consultas r√°pidas
  window._permisosActivos = permisos;

  // Mostrar/ocultar m√≥dulos en el nav
  document.querySelectorAll('.ni[id^="nav-"]').forEach(el => {
    const mod = el.id.replace('nav-','');
    el.style.display = (permisos[mod]?.ver) ? '' : 'none';
  });
}

function puedeAcceder(modulo){
  return !!(window._permisosActivos?.[modulo]?.ver);
}
function puedeCrear(modulo){
  return !!(window._permisosActivos?.[modulo]?.crear);
}
function puedeEditar(modulo){
  return !!(window._permisosActivos?.[modulo]?.editar);
}
function puedeEliminar(modulo){
  return !!(window._permisosActivos?.[modulo]?.eliminar);
}
function puedeExportar(modulo){
  return !!(window._permisosActivos?.[modulo]?.exportar);
}

// ‚îÄ‚îÄ GUARDAR USUARIO CON PERMISOS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function guardarUsr(){
  const id = document.getElementById('admId').value;
  const n  = document.getElementById('admNom').value.trim();
  const u  = document.getElementById('admUsr').value.trim();
  const c  = document.getElementById('admPw').value;
  if(!n||!u||!c){toast('Complete todos los campos','error');return}
  if(!id && usuarios.find(x=>x.usuario===u)){toast('El usuario ya existe','error');return}
  if(c && c!=='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'){
    const pwErrors = validarPassword(c);
    if(pwErrors.length>0){toast('Contrase√±a no cumple pol√≠ticas: '+pwErrors[0],'error');return}
  }
  const permisos = leerPermisosDelGrid();
  const ud = {
    id: id||'usr_'+Date.now(),
    nombre:n, usuario:u, clave:c,
    rol: document.getElementById('admRol').value,
    activo: document.getElementById('admEst').value==='true',
    permisos: permisos
  };
  await dbP('usuarios',ud);
  const idx = usuarios.findIndex(x=>x.id===ud.id);
  if(idx>=0) usuarios[idx]=ud; else usuarios.push(ud);
  limpiarUsr(); renderUsr(); poblarSelUsr();
  logAudit(id?'UPDATE':'CREATE',(id?'Actualizar':'Crear')+' usuario: '+n+' ('+ud.rol+')');
  toast(id?'Usuario actualizado':'Usuario creado');
}

function limpiarUsr(){
  ['admId','admNom','admUsr','admPw'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('admRol').value='secretario';
  document.getElementById('admEst').value='true';
  cargarPermisosPorRol();
}

function editUsr(i){
  const u = usuarios[i];
  document.getElementById('admId').value   = u.id;
  document.getElementById('admNom').value  = u.nombre;
  document.getElementById('admUsr').value  = u.usuario;
  document.getElementById('admPw').value   = u.clave;
  document.getElementById('admRol').value  = u.rol;
  document.getElementById('admEst').value  = String(u.activo);
  renderPermisosGrid(u.permisos || PERMISOS_ROL[u.rol] || {});
  document.querySelector('.contenido').scrollTo(0,0);
  toast('Editando usuario: '+u.nombre,'info');
}

function renderUsr(){
  const t = document.getElementById('tbUsr');
  const RCLASS = {administrador:'badm',pastor:'bpas',tesorero:'btes',secretario:'bsec',lider:'blid',voluntario:'bvol'};
  t.innerHTML = usuarios.map((u,i) => {
    const modCount = Object.keys(u.permisos||{}).length;
    const custom = u.permisos && Object.keys(u.permisos).length > 0;
    return `<tr>
      <td style="font-weight:700;color:#fff">${u.nombre}</td>
      <td style="color:#888">${u.usuario}</td>
      <td><span class="badge ${RCLASS[u.rol]||'bvol'}">${u.rol}</span></td>
      <td><span class="badge ${u.activo?'ba':'bi'}">${u.activo?'Activo':'Inactivo'}</span></td>
      <td><span style="font-size:10px;color:${custom?'#d4af37':'#666'}">${custom?modCount+' m√≥dulos personalizados':'Permisos de rol'}</span></td>
      <td>
        <button class="btn btn-i btn-xs" onclick="editUsr(${i})">‚úèÔ∏è</button>
        <button class="btn btn-d btn-xs" onclick="delUsr(${i})">üóëÔ∏è</button>
      </td>
    </tr>`;
  }).join('');
}

async function delUsr(i){
  if(usuarios[i].id===usrActual.id){toast('No puedes eliminar tu propio usuario','error');return}
  if(!confirm('¬øEliminar usuario '+usuarios[i].nombre+'?'))return;
  logAudit('DELETE','Eliminar usuario: '+usuarios[i].nombre);
  await dbD('usuarios',usuarios[i].id);
  usuarios.splice(i,1); renderUsr(); poblarSelUsr();
  toast('Usuario eliminado');
}


// Refrescar estado de sincronizaci√≥n cada 30 segundos
setInterval(verificarSync, 30000);


// ================================================================
// MIEMBRO ‚Äî Foto, C√©dula, Temas Pendientes
// ================================================================

function tabMForm(tab, btn){
  ['mfGeneral','mfIdentidad','mfTemas'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.style.display='none';
  });
  const el=document.getElementById('mf'+tab.charAt(0).toUpperCase()+tab.slice(1));
  if(el) el.style.display='block';
  document.querySelectorAll('.mftab').forEach(b=>b.classList.remove('activo'));
  if(btn) btn.classList.add('activo');
  // Si va a temas y hay ID, renderizar
  if(tab==='temas'){
    try{ const t=JSON.parse(document.getElementById('mTemas').value||'[]'); renderTemas(t); }catch(e){}
  }
  if(tab==='historial'){
    try{ const h=JSON.parse(document.getElementById('mHistorial').value||'[]'); renderHistorial(h); }catch(e){}
    const hf=document.getElementById('histFecha'); if(hf&&!hf.value) hf.valueAsDate=new Date();
  }
}

// ‚îÄ‚îÄ Foto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cargarFoto(event){
  const file=event.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    // Comprimir a max 200x200
    const img=new Image();
    img.onload=()=>{
      const canvas=document.createElement('canvas');
      const max=200;
      let w=img.width, h=img.height;
      if(w>h){ if(w>max){h=Math.round(h*max/w);w=max} }
      else    { if(h>max){w=Math.round(w*max/h);h=max} }
      canvas.width=w; canvas.height=h;
      canvas.getContext('2d').drawImage(img,0,0,w,h);
      const dataUrl=canvas.toDataURL('image/jpeg',0.75);
      document.getElementById('mFoto').value=dataUrl;
      mostrarFoto(dataUrl);
    };
    img.src=e.target.result;
  };
  reader.readAsDataURL(file);
}

function mostrarFoto(dataUrl){
  const img=document.getElementById('fotoImg');
  const ph=document.getElementById('fotoPlaceholder');
  if(img){ img.src=dataUrl; img.style.display='block'; }
  if(ph) ph.style.display='none';
}

function borrarFoto(){
  const img=document.getElementById('fotoImg');
  const ph=document.getElementById('fotoPlaceholder');
  const inp=document.getElementById('mFoto');
  if(img){ img.src=''; img.style.display='none'; }
  if(ph) ph.style.display='block';
  if(inp) inp.value='';
  const fi=document.getElementById('fotoFile');
  if(fi) fi.value='';
}

// ‚îÄ‚îÄ Temas Pendientes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function agregarTema(){
  const tit=document.getElementById('temaTitulo').value.trim();
  if(!tit){ toast('Escribe el t√≠tulo del tema','error'); return; }
  let temas=[];
  try{ temas=JSON.parse(document.getElementById('mTemas').value||'[]'); }catch(e){}
  const tema={
    id:'tema_'+Date.now(),
    titulo:tit,
    detalle:document.getElementById('temaDetalle').value,
    prioridad:document.getElementById('temaPrioridad').value,
    fechaLimite:document.getElementById('temaFechaLimite').value,
    fechaCreacion:new Date().toISOString().split('T')[0],
    estado:'pendiente',
    creadoPor:usrActual?usrActual.nombre:''
  };
  temas.push(tema);
  document.getElementById('mTemas').value=JSON.stringify(temas);
  document.getElementById('temaTitulo').value='';
  document.getElementById('temaDetalle').value='';
  document.getElementById('temaFechaLimite').value='';
  renderTemas(temas);
  toast('Tema agregado');
}

function renderTemas(temas){
  const c=document.getElementById('listaTemasPend');
  if(!c) return;
  if(!temas||!temas.length){
    c.innerHTML='<div style="color:#555;font-size:12px;padding:12px;text-align:center">No hay temas pendientes. Agrega uno arriba.</div>';
    return;
  }
  const PCOL={alta:'#e74c3c',media:'#f39c12',baja:'#27ae60'};
  const PICO={alta:'üî¥',media:'üü°',baja:'üü¢'};
  c.innerHTML=temas.map((t,i)=>`
    <div class="tema-card ${t.estado==='resuelto'?'resuelto':t.prioridad}">
      <div class="tema-top">
        <div>
          <div class="tema-tit">${PICO[t.prioridad]||'‚Ä¢'} ${t.titulo} ${t.estado==='resuelto'?'<span style="color:#27ae60;font-size:9px">‚úì Resuelto</span>':''}</div>
          ${t.detalle?`<div class="tema-det">${t.detalle}</div>`:''}
        </div>
        <div style="display:flex;gap:4px;flex-shrink:0">
          ${t.estado!=='resuelto'?`<button class="btn btn-e btn-xs" onclick="resolverTema(${i})" title="Marcar como resuelto">‚úì</button>`:''}
          <button class="btn btn-d btn-xs" onclick="eliminarTema(${i})" title="Eliminar">üóëÔ∏è</button>
        </div>
      </div>
      <div class="tema-meta">
        <span style="font-size:9px;color:#666">Creado: ${fmtF(t.fechaCreacion)}</span>
        ${t.fechaLimite?`<span style="font-size:9px;color:${new Date(t.fechaLimite)<new Date()?'#e74c3c':'#888'}">‚è∞ L√≠mite: ${fmtF(t.fechaLimite)}</span>`:''}
        ${t.creadoPor?`<span style="font-size:9px;color:#555">Por: ${t.creadoPor}</span>`:''}
      </div>
    </div>`).join('');
}

function resolverTema(i){
  let temas=[];
  try{ temas=JSON.parse(document.getElementById('mTemas').value||'[]'); }catch(e){}
  if(temas[i]){ temas[i].estado='resuelto'; temas[i].fechaResolucion=new Date().toISOString().split('T')[0]; }
  document.getElementById('mTemas').value=JSON.stringify(temas);
  renderTemas(temas);
  // Historial
  const hist=m.historial||[];
  document.getElementById('mHistorial').value=JSON.stringify(hist);
  // Set today as default date for historial
  const hf=document.getElementById('histFecha'); if(hf) hf.valueAsDate=new Date();
  renderHistorial(hist);
  toast('Tema marcado como resuelto');
}

function eliminarTema(i){
  let temas=[];
  try{ temas=JSON.parse(document.getElementById('mTemas').value||'[]'); }catch(e){}
  temas.splice(i,1);
  document.getElementById('mTemas').value=JSON.stringify(temas);
  renderTemas(temas);
  // Historial
  const hist=m.historial||[];
  document.getElementById('mHistorial').value=JSON.stringify(hist);
  // Set today as default date for historial
  const hf=document.getElementById('histFecha'); if(hf) hf.valueAsDate=new Date();
  renderHistorial(hist);
}

// Alertas de temas en Dashboard
function alertasTemasDash(){
  const urgentes=[];
  const hoy=new Date();
  miembros.forEach(m=>{
    (m.temas||[]).filter(t=>t.estado!=='resuelto').forEach(t=>{
      const esVencido=t.fechaLimite && new Date(t.fechaLimite)<hoy;
      if(t.prioridad==='alta'||esVencido) urgentes.push({miembro:m,tema:t,vencido:esVencido});
    });
  });
  const el=document.getElementById('dashTemasPend');
  const cnt=document.getElementById('dashTemasCnt');
  if(!el) return;
  if(cnt) cnt.textContent=urgentes.length;
  if(!urgentes.length){ el.innerHTML='<div style="color:#555;font-size:11px;padding:6px">Sin temas urgentes pendientes.</div>'; return; }
  el.innerHTML=urgentes.slice(0,8).map(u=>`
    <div class="alerta-seg ${u.vencido?'':'oc'}" onclick="editM(${miembros.indexOf(u.miembro)});go('membresia');setTimeout(()=>tabMForm('temas',document.querySelectorAll('.mftab')[2]),400)">
      <div class="alerta-ico">${u.vencido?'üî¥':'üü°'}</div>
      <div class="alerta-info">
        <div class="alerta-nom">${u.miembro.nombre}</div>
        <div class="alerta-det">üìå ${u.tema.titulo}${u.vencido?' ¬∑ <span style=color:#e74c3c>VENCIDO</span>':''}</div>
      </div>
      <span class="alerta-badge ${u.vencido?'badge-peligro':'badge-aviso'}">${u.vencido?'VENCIDO':'URGENTE'}</span>
    </div>`).join('');
}


// ================================================================
// HISTORIAL DE ACCIONES POR MIEMBRO
// ================================================================
const HIST_TIPOS = {
  visita:       {ico:'üè†', color:'#2980b9',  label:'Visita domiciliaria'},
  llamada:      {ico:'üìû', color:'#16a085',  label:'Llamada telef√≥nica'},
  consejeria:   {ico:'ü§ù', color:'#8e44ad',  label:'Consejer√≠a'},
  oracion:      {ico:'üôè', color:'#d4af37',  label:'Oraci√≥n personal'},
  bautismo:     {ico:'üíß', color:'#2980b9',  label:'Bautismo'},
  membresia:    {ico:'üìú', color:'#27ae60',  label:'Membres√≠a'},
  disciplina:   {ico:'‚ö†Ô∏è', color:'#e74c3c',  label:'Disciplina'},
  restauracion: {ico:'‚úÖ', color:'#27ae60',  label:'Restauraci√≥n'},
  capacitacion: {ico:'üìö', color:'#f39c12',  label:'Capacitaci√≥n'},
  ministerio:   {ico:'üé§', color:'#9b59b6',  label:'Cambio de ministerio'},
  otro:         {ico:'üìù', color:'#7f8c8d',  label:'Otro'},
};

function agregarHistorial(){
  const tipo    = document.getElementById('histTipo').value;
  const detalle = document.getElementById('histDetalle').value.trim();
  const fecha   = document.getElementById('histFecha').value;
  if(!detalle){ toast('Describe la acci√≥n realizada','error'); return; }

  let hist = [];
  try{ hist = JSON.parse(document.getElementById('mHistorial').value||'[]'); }catch(e){}

  hist.unshift({
    id:          'hist_'+Date.now(),
    tipo,
    detalle,
    fecha:       fecha || new Date().toISOString().split('T')[0],
    horaReg:     new Date().toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
    fechaReg:    new Date().toISOString(),
    registradoPor: usrActual ? usrActual.nombre : 'Sistema',
    rolRegistrador: usrActual ? usrActual.rol : ''
  });

  document.getElementById('mHistorial').value = JSON.stringify(hist);
  document.getElementById('histDetalle').value = '';
  document.getElementById('histFecha').value   = '';
  renderHistorial(hist);
  toast('Acci√≥n registrada en el historial');
}

function renderHistorial(hist){
  const c = document.getElementById('listaHistorial');
  if(!c) return;
  if(!hist || !hist.length){
    c.innerHTML = '<div style="color:#555;font-size:12px;padding:8px;text-align:center">No hay acciones registradas para este miembro.</div>';
    return;
  }

  // Agrupar por a√±o-mes para mostrar separadores
  let mesActual = '';
  c.innerHTML = hist.map((h,i) => {
    const t      = HIST_TIPOS[h.tipo] || HIST_TIPOS.otro;
    const fReg   = new Date(h.fechaReg || h.fecha+'T00:00:00');
    const mes    = fReg.toLocaleDateString('es-ES',{month:'long',year:'numeric'});
    const sep    = mes !== mesActual ? `<div style="font-size:9px;color:#444;text-transform:uppercase;letter-spacing:1px;padding:10px 0 4px;font-weight:700;border-top:1px solid rgba(255,255,255,.04);margin-top:4px">${mes}</div>` : '';
    mesActual    = mes;

    return sep + `<div class="hist-item">
      <div class="hist-dot" style="background:${t.color}"></div>
      <div class="hist-body">
        <div class="hist-accion">${t.ico} ${t.label}</div>
        <div class="hist-det">${h.detalle}</div>
        <div class="hist-meta">
          <span>üìÖ ${fmtF(h.fecha)}</span>
          <span>üïê Registrado: ${fmtF(h.fechaReg?.split('T')[0]||h.fecha)} ${h.horaReg||''}</span>
          ${h.registradoPor ? `<span>üë§ Por: ${h.registradoPor}${h.rolRegistrador?' ('+h.rolRegistrador+')':''}</span>` : ''}
        </div>
      </div>
      <button class="btn btn-d btn-xs" onclick="eliminarHistorial(${i})" title="Eliminar">üóëÔ∏è</button>
    </div>`;
  }).join('');
}

function eliminarHistorial(i){
  if(!confirm('¬øEliminar esta entrada del historial?')) return;
  let hist = [];
  try{ hist = JSON.parse(document.getElementById('mHistorial').value||'[]'); }catch(e){}
  hist.splice(i,1);
  document.getElementById('mHistorial').value = JSON.stringify(hist);
  renderHistorial(hist);
}

</script>


<!-- Overlay para cerrar sidebar en m√≥vil -->
<div id="sidebarOverlay" onclick="toggleSidebar()"></div>

<!-- Navegaci√≥n inferior m√≥vil -->
<div id="mobileNav">
  <button class="mn-btn" id="mnav-dashboard" onclick="go('dashboard');closeSidebar()">
    <span class="mn-ico">üìä</span>Inicio
  </button>
  <button class="mn-btn" id="mnav-membresia" onclick="go('membresia');closeSidebar()">
    <span class="mn-ico">üë•</span>Miembros
  </button>
  <button class="mn-btn" id="mnav-asistencia" onclick="go('asistencia');closeSidebar()">
    <span class="mn-ico">üìã</span>Asist.
  </button>
  <button class="mn-btn" id="mnav-finanzas" onclick="go('finanzas');closeSidebar()">
    <span class="mn-ico">üí∞</span>Finanzas
  </button>
  <button class="mn-btn" id="mnav-menu" onclick="toggleSidebar()">
    <span class="mn-ico">‚ò∞</span>M√°s
  </button>
</div>

<script>
// === CONTROL SIDEBAR M√ìVIL ===
function toggleSidebar(){
  const sb = document.querySelector('.sidebar');
  const ov = document.getElementById('sidebarOverlay');
  if(!sb) return;
  sb.classList.toggle('open');
  ov.classList.toggle('open');
}
function closeSidebar(){
  const sb = document.querySelector('.sidebar');
  const ov = document.getElementById('sidebarOverlay');
  if(!sb) return;
  sb.classList.remove('open');
  ov.classList.remove('open');
}
// Resaltar bot√≥n activo en nav inferior
const _origGo = typeof go !== 'undefined' ? go : null;
document.addEventListener('DOMContentLoaded', ()=>{
  // Parchear go() para actualizar nav inferior
  const _go = window.go;
  window.go = function(v){
    _go(v);
    document.querySelectorAll('.mn-btn').forEach(b=>b.classList.remove('activo'));
    const mb = document.getElementById('mnav-'+v);
    if(mb) mb.classList.add('activo');
    closeSidebar();
  };
  // Activar dashboard por defecto en nav inferior
  const d = document.getElementById('mnav-dashboard');
  if(d) d.classList.add('activo');
});
</script>
</body>
</html>
